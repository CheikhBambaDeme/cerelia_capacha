{% extends 'base.html' %}

{% block title %}Line Simulation - Cerelia{% endblock %}

{% block extra_css %}
<style>
    .scenario-card {
        transition: all 0.3s ease;
    }
    .scenario-card:hover {
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    .scenario-card .card-body {
        background-color: #f8f9fa;
    }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="bi bi-bar-chart-line"></i> Line Simulation</h2>
    <button class="btn btn-primary" onclick="runSimulation()">
        <i class="bi bi-play-fill"></i> Run Simulation
    </button>
</div>

<div class="row">
    <!-- Configuration Panel -->
    <div class="col-md-3">
        <div class="card mb-4" style="max-height: 85vh; min-height: 500px; display: flex; flex-direction: column;">
            <div class="card-header">
                <i class="bi bi-sliders"></i> <span style="color: #ea6d09;">Configuration</span>
            </div>
            <div class="card-body flex-grow-1 overflow-auto" style="min-height: 0;">
                <!-- Simulation Category Selection -->
                <div class="mb-3">
                    <label class="form-label" style="color: #ea6d09; font-weight: bold;">
                        <i class="bi bi-collection"></i> Simulation Category
                    </label>
                    <select class="form-select" id="simulationCategorySelect">
                        <option value="">-- Select a Category or choose lines manually --</option>
                    </select>
                    <small class="text-muted">Select a pre-defined category to auto-populate lines and filters</small>
                </div>

                <div id="categoryDetails" class="mb-3" style="display: none;">
                    <div class="card bg-light">
                        <div class="card-body p-2">
                            <small class="text-muted">Category filters:</small>
                            <div id="categoryFiltersInfo" class="small"></div>
                            <div class="mt-2">
                                <span class="badge bg-info" id="categoryProductCount">0 matching products</span>
                            </div>
                        </div>
                    </div>
                </div>

                <hr>

                <!-- Date Range -->
                <div class="mb-3">
                    <label class="form-label" style="color: #5e3e2f; font-weight: bold;">Date Range</label>
                    <div class="row">
                        <div class="col-6">
                            <input type="date" class="form-control" id="startDate">
                        </div> 
                        <div class="col-6">
                            <input type="date" class="form-control" id="endDate">
                        </div>
                    </div>
                </div>

                <!-- Line Selection -->
                <div class="mb-3">
                    <label class="form-label" style="color: #ea6d09; font-weight: bold;">Production Lines</label>
                    <select class="form-select" id="lineSelect" multiple size="6">
                    </select>
                    <small class="text-muted">Hold Ctrl to select multiple lines (auto-filled by category)</small>
                </div>

                <!-- Shift Configuration per Line -->
                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <label class="form-label mb-0" style="color: #5e3e2f; font-weight: bold;">Shift Configurations</label>
                        <button class="btn btn-sm btn-outline-primary" onclick="addScenario()" title="Add another shift configuration scenario">
                            <i class="bi bi-plus-circle"></i> Add Scenario
                        </button>
                    </div>
                    <div id="scenariosContainer">
                        <div class="scenario-card mb-3" data-scenario-id="0">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="badge bg-primary">Scenario 1</span>
                            </div>
                            <div class="shift-config-container" data-scenario-id="0">
                                <small class="text-muted">Select lines first</small>
                            </div>
                        </div>
                    </div>
                </div>

                <hr>

                <!-- Optional Filters -->
                <h6 style="color: #ea6d09; font-weight: bold;"><i class="bi bi-funnel"></i> Optional Filters</h6>
                
                <div class="mb-3">
                    <label class="form-label" style="color: #5e3e2f; font-weight: bold;">Filter by Client</label>
                    <div class="input-group">
                        <input type="text" class="form-control" id="clientFilterInput" list="clientDatalist" placeholder="Enter client code">
                        <button class="btn btn-outline-secondary" type="button" onclick="addClientFilter()">
                            <i class="bi bi-plus"></i>
                        </button>
                    </div>
                    <datalist id="clientDatalist"></datalist>
                    <div id="clientFilterList" class="mt-2">
                        <!-- Client filter tags will appear here -->
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label" style="color: #5e3e2f; font-weight: bold;">Filter by Product</label>
                    <div class="input-group">
                        <input type="text" class="form-control" id="productFilterInput" list="productDatalist" placeholder="Enter product code">
                        <button class="btn btn-outline-secondary" type="button" onclick="addProductFilter()">
                            <i class="bi bi-plus"></i>
                        </button>
                    </div>
                    <datalist id="productDatalist"></datalist>
                    <div id="productFilterList" class="mt-2">
                        <!-- Product filter tags will appear here -->
                    </div>
                </div>

                <hr>

                <!-- Client Demand Overlays -->
                <h6 style="color: #ea6d09; font-weight: bold;"><i class="bi bi-layers"></i> Client Demand Overlays</h6>
                <small class="text-muted d-block mb-2">Add client codes to overlay their demand curves</small>
                
                <div class="mb-3">
                    <div class="input-group">
                        <input type="text" class="form-control" id="clientCodeInput" placeholder="Enter client code">
                        <button class="btn btn-outline-secondary" type="button" onclick="addClientOverlay()">
                            <i class="bi bi-plus"></i>
                        </button>
                    </div>
                </div>
                
                <div id="overlayClientsList" class="mb-3">
                    <!-- Client overlay tags will appear here -->
                </div>
                
                <div class="form-check mb-2">
                    <input class="form-check-input" type="checkbox" id="combineOverlays">
                    <label class="form-check-label" for="combineOverlays">
                        <i class="bi bi-union"></i> Combine selected clients
                    </label>
                    <small class="text-muted d-block">Show sum of all overlay clients as one curve</small>
                </div>

                <hr>

                <!-- Demand Modifications -->
                <h6 style="color: #ea6d09; font-weight: bold;"><i class="bi bi-pencil-square"></i> Demand Modifications</h6>
                <small class="text-muted d-block mb-2">Adjust client demand by percentage for specific products</small>
                
                <div class="card bg-light mb-3">
                    <div class="card-body p-2">
                        <div class="mb-2">
                            <label class="form-label small mb-1">Client</label>
                            <select class="form-select form-select-sm" id="modClientSelect">
                                <option value="">Select client...</option>
                            </select>
                        </div>
                        <div class="mb-2">
                            <label class="form-label small mb-1">Product</label>
                            <select class="form-select form-select-sm" id="modProductSelect" disabled>
                                <option value="">Select product...</option>
                            </select>
                        </div>
                        <div class="row mb-2">
                            <div class="col-6">
                                <label class="form-label small mb-1">Start Date</label>
                                <input type="date" class="form-control form-control-sm" id="modStartDate">
                            </div>
                            <div class="col-6">
                                <label class="form-label small mb-1">End Date</label>
                                <input type="date" class="form-control form-control-sm" id="modEndDate">
                            </div>
                        </div>
                        <div class="mb-2">
                            <label class="form-label small mb-1">Percentage Adjustment</label>
                            <div class="input-group input-group-sm">
                                <input type="number" class="form-control" id="modPercentage" value="0" min="-100" step="5">
                                <span class="input-group-text">%</span>
                            </div>
                            <small class="text-muted">-100% = Remove demand, +50% = Increase by 50%</small>
                        </div>
                        <div class="d-flex gap-1">
                            <button class="btn btn-sm btn-outline-primary flex-grow-1" id="modAddBtn" onclick="addDemandModification()">
                                <i class="bi bi-plus-lg"></i> Add Modification
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" id="modCancelBtn" onclick="cancelEditModification()" style="display: none;">
                                <i class="bi bi-x-lg"></i>
                            </button>
                        </div>
                    </div>
                </div>
                
                <div id="demandModificationsList" class="mb-3">
                    <!-- Demand modification items will appear here -->
                </div>

                <hr>

                <!-- Demand with Stock Handling -->
                <h6 style="color: #ea6d09; font-weight: bold;"><i class="bi bi-box-seam"></i> Demand with Stock</h6>
                <small class="text-muted d-block mb-2">Shift demand between weeks to optimize capacity. Adding units to a week will subtract them from the next week.</small>
                
                <div class="card bg-light mb-3">
                    <div class="card-body p-2">
                        <div class="row mb-2">
                            <div class="col-6">
                                <label class="form-label small mb-1">Week</label>
                                <select class="form-select form-select-sm" id="stockWeekSelect">
                                    <option value="">Select week...</option>
                                </select>
                            </div>
                            <div class="col-6">
                                <label class="form-label small mb-1">Units to Add</label>
                                <input type="number" class="form-control form-control-sm" id="stockUnits" value="0" step="100">
                            </div>
                        </div>
                        <small class="text-muted d-block mb-2"><i class="bi bi-info-circle"></i> Positive = add to this week (subtract from next), Negative = remove from this week (add to next)</small>
                        <div class="d-flex gap-1">
                            <button class="btn btn-sm btn-outline-success flex-grow-1" id="stockAddBtn" onclick="addStockAdjustment()">
                                <i class="bi bi-plus-lg"></i> Add Stock Adjustment
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" id="stockCancelBtn" onclick="cancelEditStockAdjustment()" style="display: none;">
                                <i class="bi bi-x-lg"></i>
                            </button>
                        </div>
                    </div>
                </div>
                
                <div id="stockAdjustmentsList" class="mb-3">
                    <!-- Stock adjustment items will appear here -->
                </div>

                <hr>

                <!-- Super Chilling -->
                <h6 style="color: #ea6d09; font-weight: bold;"><i class="bi bi-snow"></i> Super Chilling</h6>
                <small class="text-muted d-block mb-2">Shift demand between weeks (up to 4 weeks apart). Reduce demand in one week and increase it in an earlier week for pre-production.</small>
                
                <div class="card bg-light mb-3">
                    <div class="card-body p-2">
                        <div class="row mb-2">
                            <div class="col-6">
                                <label class="form-label small mb-1">Reduce Week (Peak)</label>
                                <select class="form-select form-select-sm" id="superChillReduceWeek">
                                    <option value="">Select week...</option>
                                </select>
                            </div>
                            <div class="col-6">
                                <label class="form-label small mb-1">Increase Week (Pre-prod)</label>
                                <select class="form-select form-select-sm" id="superChillIncreaseWeek">
                                    <option value="">Select week...</option>
                                </select>
                            </div>
                        </div>
                        <div class="mb-2">
                            <label class="form-label small mb-1">Units to Transfer</label>
                            <input type="number" class="form-control form-control-sm" id="superChillUnits" value="0" step="100">
                        </div>
                        <small class="text-muted d-block mb-2"><i class="bi bi-info-circle"></i> Transfer demand from peak week to an earlier week (up to 4 weeks before) for super chilling pre-production.</small>
                        <div class="d-flex gap-1">
                            <button class="btn btn-sm btn-outline-info flex-grow-1" id="superChillAddBtn" onclick="addSuperChillAdjustment()">
                                <i class="bi bi-plus-lg"></i> Add Super Chill Adjustment
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" id="superChillCancelBtn" onclick="cancelEditSuperChillAdjustment()" style="display: none;">
                                <i class="bi bi-x-lg"></i>
                            </button>
                        </div>
                    </div>
                </div>
                
                <div id="superChillAdjustmentsList" class="mb-3">
                    <!-- Super chill adjustment items will appear here -->
                </div>

                <hr>

                <!-- Frozen -->
                <h6 style="color: #ea6d09; font-weight: bold;"><i class="bi bi-snow"></i><i class="bi bi-snow"></i> Frozen</h6>
                <small class="text-muted d-block mb-2">Shift demand for frozen products (up to 9+ months apart). Reduce demand in one week and increase it in a much earlier week for long-term pre-production.</small>
                
                <div class="card bg-light mb-3">
                    <div class="card-body p-2">
                        <div class="row mb-2">
                            <div class="col-6">
                                <label class="form-label small mb-1">Reduce Week (Peak)</label>
                                <select class="form-select form-select-sm" id="frozenReduceWeek">
                                    <option value="">Select week...</option>
                                </select>
                            </div>
                            <div class="col-6">
                                <label class="form-label small mb-1">Increase Week (Pre-prod)</label>
                                <select class="form-select form-select-sm" id="frozenIncreaseWeek">
                                    <option value="">Select week...</option>
                                </select>
                            </div>
                        </div>
                        <div class="mb-2">
                            <label class="form-label small mb-1">Units to Transfer</label>
                            <input type="number" class="form-control form-control-sm" id="frozenUnits" value="0" step="100">
                        </div>
                        <small class="text-muted d-block mb-2"><i class="bi bi-info-circle"></i> Transfer demand from peak week to any earlier week for frozen pre-production (no week limit).</small>
                        <div class="d-flex gap-1">
                            <button class="btn btn-sm btn-outline-primary flex-grow-1" id="frozenAddBtn" onclick="addFrozenAdjustment()" style="background-color: #e3f2fd;">
                                <i class="bi bi-plus-lg"></i> Add Frozen Adjustment
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" id="frozenCancelBtn" onclick="cancelEditFrozenAdjustment()" style="display: none;">
                                <i class="bi bi-x-lg"></i>
                            </button>
                        </div>
                    </div>
                </div>
                
                <div id="frozenAdjustmentsList" class="mb-3">
                    <!-- Frozen adjustment items will appear here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Results Panel -->
    <div class="col-md-9">
        <!-- Stats Cards -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card stat-card">
                    <div class="stat-value" id="avgUtilization">-</div>
                    <div class="stat-label">Avg Utilization %</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stat-card warning">
                    <div class="stat-value" id="peakUtilization">-</div>
                    <div class="stat-label">Peak Utilization %</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stat-card danger">
                    <div class="stat-value" id="overCapacityPeriods">-</div>
                    <div class="stat-label">Over-Capacity Weeks</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stat-card success">
                    <div class="stat-value" id="totalCapacity">-</div>
                    <div class="stat-label">Total Capacity</div>
                </div>
            </div>
        </div>

        <!-- Chart -->
        <div class="card">
            <div class="card-header">
                <i class="bi bi-graph-up"></i> Demand vs Capacity
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="simulationChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Data Table -->
        <div class="card mt-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="bi bi-table"></i> Weekly Data</span>
                <div>
                    <small class="text-muted me-3"><i class="bi bi-gear text-warning"></i> = Config Override Active</small>
                    <div class="btn-group btn-group-sm" id="exportButtons" style="display: none;">
                        <button class="btn btn-outline-success" onclick="exportToCSV()" title="Export to CSV">
                            <i class="bi bi-filetype-csv"></i> CSV
                        </button>
                        <button class="btn btn-outline-primary" onclick="exportToExcel()" title="Export to Excel">
                            <i class="bi bi-file-earmark-excel"></i> Excel
                        </button>
                        <button class="btn btn-outline-secondary" onclick="exportChartAsImage()" title="Export Chart as Image">
                            <i class="bi bi-image"></i> Chart
                        </button>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-sm" id="dataTable">
                        <thead>
                            <tr>
                                <th>Week</th>
                                <th>Demand</th>
                                <th>Capacity</th>
                                <th>Utilization</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="5" class="text-center text-muted">Run simulation to see data</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>

    // CSRF Token handling
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    const csrftoken = getCookie('csrftoken');

    let simulationChart = null;
    let shiftConfigs = [];
    let allLines = [];
    let overlayClients = [];  // Store client codes for overlay
    let lastSimulationResult = null;  // Store for export
    let scenarios = []; // Store multiple scenarios
    let nextScenarioId = 1; // Counter for scenario IDs
    let scenarioResults = {}; // Store results for each scenario
    let lastClientOverlays = {};  // Store for export
    let demandModifications = [];  // Store demand modifications
    let allProducts = [];  // Store all products for modification dropdown
    let stockAdjustments = [];  // Store stock adjustments for demand shifting
    let editingStockId = null;  // Track if we're editing an existing stock adjustment
    let availableWeeks = [];  // Store available weeks from last simulation
    let superChillAdjustments = [];  // Store super chilling adjustments (up to 4 weeks)
    let editingSuperChillId = null;  // Track if we're editing an existing super chill adjustment
    let frozenAdjustments = [];  // Store frozen adjustments (unlimited weeks)
    let editingFrozenId = null;  // Track if we're editing an existing frozen adjustment
    let filterClients = [];  // Store client codes for filtering
    let filterProducts = [];  // Store product codes for filtering
    
    // Colors for overlay curves
    const overlayColors = [
        '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', 
        '#FF9F40', '#7CB9E8', '#F0E68C', '#DDA0DD', '#98FB98'
    ];

    // Initialize
    document.addEventListener('DOMContentLoaded', async function() {
        // Set default dates (next 12 months)
        const today = new Date();
        const twelveMonthsLater = new Date(today);
        twelveMonthsLater.setMonth(twelveMonthsLater.getMonth() + 12);
        
        document.getElementById('startDate').value = today.toISOString().split('T')[0];
        document.getElementById('endDate').value = twelveMonthsLater.toISOString().split('T')[0];
        
        // Set default modification dates
        document.getElementById('modStartDate').value = today.toISOString().split('T')[0];
        document.getElementById('modEndDate').value = twelveMonthsLater.toISOString().split('T')[0];

        // Load data
        await Promise.all([
            loadLines(),
            loadClients(),
            loadSimulationCategories(),
            loadShiftConfigs(),
            loadAllProducts()
        ]);

        // Setup event listeners
        document.getElementById('lineSelect').addEventListener('change', updateShiftConfigUI);
        document.getElementById('simulationCategorySelect').addEventListener('change', onSimulationCategoryChange);
        
        // Setup modification client change listener
        document.getElementById('modClientSelect').addEventListener('change', loadClientProducts);
        
        // Handle Enter key for client code input
        document.getElementById('clientCodeInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                addClientOverlay();
            }
        });
        
        // Handle Enter key for client filter input
        document.getElementById('clientFilterInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                addClientFilter();
            }
        });
        
        // Handle Enter key for product filter input
        document.getElementById('productFilterInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                addProductFilter();
            }
        });
    });

    async function loadLines() {
        const data = await fetchAPI('lines/');
        allLines = data.results || data;
        const select = document.getElementById('lineSelect');
        select.innerHTML = allLines.map(line => 
            `<option value="${line.id}">${line.site_name} - ${line.name}</option>`
        ).join('');
    }

    let allClients = [];  // Store clients for lookup
    
    async function loadClients() {
        const data = await fetchAPI('clients/');
        allClients = data.results || data;
        const datalist = document.getElementById('clientDatalist');
        datalist.innerHTML = allClients.map(c => `<option value="${c.code}">${c.code} - ${c.name}</option>`).join('');
        
        // Also populate modification client dropdown
        const modClientSelect = document.getElementById('modClientSelect');
        modClientSelect.innerHTML = '<option value="">Select client...</option>' + 
            allClients.map(c => `<option value="${c.id}" data-code="${c.code}">${c.code} - ${c.name}</option>`).join('');
    }
    
    function getClientIdByCode(code) {
        if (!code) return null;
        const client = allClients.find(c => c.code.toUpperCase() === code.toUpperCase());
        return client ? client.id : null;
    }
    
    async function loadAllProducts() {
        const data = await fetchAPI('products/');
        allProducts = data.results || data;
        
        // Also populate product datalist for filter
        const datalist = document.getElementById('productDatalist');
        datalist.innerHTML = allProducts.map(p => `<option value="${p.code}">${p.code} - ${p.name}</option>`).join('');
    }
    
    async function loadClientProducts() {
        const clientId = document.getElementById('modClientSelect').value;
        const productSelect = document.getElementById('modProductSelect');
        
        if (!clientId) {
            productSelect.innerHTML = '<option value="">Select product...</option>';
            productSelect.disabled = true;
            return;
        }
        
        // Get products that have demand forecasts for this client
        try {
            const data = await fetchAPI(`forecasts/products_by_client/?client_id=${clientId}`);
            const products = data.results || data;
            
            if (products.length > 0) {
                productSelect.innerHTML = '<option value="">All products</option>' + 
                    products.map(p => `<option value="${p.id}" data-code="${p.code}">${p.code} - ${p.name}</option>`).join('');
            } else {
                // Fallback to all products if no specific endpoint
                productSelect.innerHTML = '<option value="">All products</option>' + 
                    allProducts.map(p => `<option value="${p.id}" data-code="${p.code}">${p.code} - ${p.name}</option>`).join('');
            }
            productSelect.disabled = false;
        } catch (error) {
            // Fallback to all products
            productSelect.innerHTML = '<option value="">All products</option>' + 
                allProducts.map(p => `<option value="${p.id}" data-code="${p.code}">${p.code} - ${p.name}</option>`).join('');
            productSelect.disabled = false;
        }
    }

    let simulationCategories = [];  // Store simulation categories
    let selectedSimulationCategory = null;  // Currently selected simulation category

    async function loadSimulationCategories() {
        try {
            const data = await fetchAPI('simulation-categories/');
            simulationCategories = data.results || data;
            const select = document.getElementById('simulationCategorySelect');
            select.innerHTML = '<option value="">-- Select a Category or choose lines manually --</option>' + 
                simulationCategories.map(c => `<option value="${c.id}">${c.name} (${c.matching_products_count} products)</option>`).join('');
        } catch (error) {
            console.error('Error loading simulation categories:', error);
        }
    }

    async function onSimulationCategoryChange() {
        const select = document.getElementById('simulationCategorySelect');
        const categoryId = select.value;
        const detailsDiv = document.getElementById('categoryDetails');
        const filtersInfo = document.getElementById('categoryFiltersInfo');
        const productCountBadge = document.getElementById('categoryProductCount');

        if (!categoryId) {
            // No category selected, hide details and allow manual selection
            detailsDiv.style.display = 'none';
            selectedSimulationCategory = null;
            return;
        }

        try {
            // Load full category details
            const category = await fetchAPI(`simulation-categories/${categoryId}/`);
            selectedSimulationCategory = category;
            
            // Show category details
            detailsDiv.style.display = 'block';
            
            // Build filters info display
            let filtersHtml = '';
            if (category.site_name) {
                filtersHtml += `<div><i class="bi bi-geo-alt"></i> Site: ${category.site_name}</div>`;
            }
            if (category.product_types) {
                filtersHtml += `<div><i class="bi bi-box"></i> Product Types: ${category.product_types}</div>`;
            }
            if (category.recipe_types) {
                filtersHtml += `<div><i class="bi bi-journal-text"></i> Recipe Types: ${category.recipe_types}</div>`;
            }
            if (category.material_types) {
                filtersHtml += `<div><i class="bi bi-layers"></i> Material Types: ${category.material_types}</div>`;
            }
            if (category.packaging_types) {
                filtersHtml += `<div><i class="bi bi-archive"></i> Packaging Types: ${category.packaging_types}</div>`;
            }
            filtersInfo.innerHTML = filtersHtml || '<em>No filters defined</em>';
            productCountBadge.textContent = `${category.matching_products_count} matching products`;

            // Auto-select the lines from the category
            const lineSelect = document.getElementById('lineSelect');
            const lineIds = category.lines_data ? category.lines_data.map(l => l.id) : [];
            
            // Select the lines in the dropdown
            Array.from(lineSelect.options).forEach(option => {
                option.selected = lineIds.includes(parseInt(option.value));
            });

            // Trigger shift config update
            updateShiftConfigUI();
            
        } catch (error) {
            console.error('Error loading category details:', error);
            detailsDiv.style.display = 'none';
        }
    }

    async function loadShiftConfigs() {
        const data = await fetchAPI('shift-configs/');
        shiftConfigs = data.results || data;
    }

    function updateShiftConfigUI() {
        const selectedOptions = Array.from(document.getElementById('lineSelect').selectedOptions);
        
        if (selectedOptions.length === 0) {
            // Update all scenario containers
            document.querySelectorAll('.shift-config-container').forEach(container => {
                container.innerHTML = '<small class="text-muted">Select lines first</small>';
            });
            return;
        }

        // Update each scenario's shift config UI
        document.querySelectorAll('.shift-config-container').forEach(container => {
            const scenarioId = container.dataset.scenarioId;
            
            // Preserve existing selections for this scenario
            const existingSelections = {};
            container.querySelectorAll('select[data-line-id]').forEach(select => {
                existingSelections[select.dataset.lineId] = select.value;
            });
            
            container.innerHTML = selectedOptions.map(opt => {
                const line = allLines.find(l => l.id == opt.value);
                const hasOverrides = line && line.active_overrides_count > 0;
                // Check if we have an existing selection for this line in this scenario
                const existingValue = existingSelections[opt.value];
                
                return `
                    <div class="mb-2">
                        <label class="form-label small">${line ? line.name : 'Line'} ${hasOverrides ? '<span class="badge bg-warning text-dark"><i class="bi bi-wrench"></i> Has Overrides</span>' : ''}</label>
                        <select class="form-select form-select-sm" data-line-id="${opt.value}" data-scenario-id="${scenarioId}">
                            <option value="override" ${existingValue === 'override' || (!existingValue && hasOverrides) ? 'selected' : ''}>ðŸ”§ Use Override Config (date-based)</option>
                            ${shiftConfigs.map(sc => {
                                const isSelected = existingValue ? existingValue == sc.id : (!hasOverrides && line && line.default_shift_config == sc.id);
                                return `<option value="${sc.id}" ${isSelected ? 'selected' : ''}>${sc.name}</option>`;
                            }).join('')}
                        </select>
                    </div>
                `;
            }).join('');
        });
    }

    function addScenario() {
        const scenarioId = nextScenarioId++;
        const scenarioNum = document.querySelectorAll('.scenario-card').length + 1;
        const scenariosContainer = document.getElementById('scenariosContainer');
        
        // Scenario colors for visual distinction
        const colors = ['primary', 'success', 'info', 'warning', 'danger', 'secondary'];
        const colorClass = colors[scenarioNum % colors.length];
        
        const scenarioHtml = `
            <div class="scenario-card mb-3 card" data-scenario-id="${scenarioId}" style="border-left: 4px solid var(--bs-${colorClass});">
                <div class="card-body p-2">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="badge bg-${colorClass}">Scenario ${scenarioNum}</span>
                        <button class="btn btn-sm btn-outline-danger" onclick="removeScenario(${scenarioId})" title="Remove this scenario">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                    <div class="shift-config-container" data-scenario-id="${scenarioId}">
                        <small class="text-muted">Select lines first</small>
                    </div>
                </div>
            </div>
        `;
        
        scenariosContainer.insertAdjacentHTML('beforeend', scenarioHtml);
        
        // Update the shift config UI for the new scenario
        updateShiftConfigUI();
    }

    function removeScenario(scenarioId) {
        // Don't allow removing the last scenario
        const allScenarios = document.querySelectorAll('.scenario-card');
        if (allScenarios.length <= 1) {
            alert('You must have at least one scenario');
            return;
        }
        
        const scenarioCard = document.querySelector(`[data-scenario-id="${scenarioId}"].scenario-card`);
        if (scenarioCard) {
            scenarioCard.remove();
            // Remove from results if exists
            delete scenarioResults[scenarioId];
            // Re-render chart without this scenario
            if (lastSimulationResult) {
                updateChartWithScenarios();
            }
        }
        
        // Renumber remaining scenarios
        const remainingScenarios = document.querySelectorAll('.scenario-card');
        remainingScenarios.forEach((card, index) => {
            const badge = card.querySelector('.badge');
            if (badge) {
                const oldText = badge.textContent;
                badge.textContent = `Scenario ${index + 1}`;
            }
        });
    }

    async function runSimulation() {
        const lineSelect = document.getElementById('lineSelect');
        const selectedLineIds = Array.from(lineSelect.selectedOptions).map(opt => parseInt(opt.value));
        const simulationCategoryId = document.getElementById('simulationCategorySelect').value;
    
        if (selectedLineIds.length === 0 && !simulationCategoryId) {
            alert('Please select a simulation category or at least one production line');
            return;
        }

        // Clear previous scenario results
        scenarioResults = {};
        
        // Get all scenarios
        const scenarioCards = document.querySelectorAll('.scenario-card');
        
        // Get client codes from filter tags
        const clientCodes = filterClients.map(c => c.code);
        // Get product codes from filter tags
        const productCodes = filterProducts.map(p => p.code);
        
        // Determine which API endpoint to use
        const useSimulationCategory = simulationCategoryId && selectedSimulationCategory;
        
        // Run simulation for each scenario
        try {
            for (const scenarioCard of scenarioCards) {
                const scenarioId = scenarioCard.dataset.scenarioId;
                
                // Get shift configs for this scenario
                const shiftConfigSelects = scenarioCard.querySelectorAll('.shift-config-container select');
                const lineShiftConfigs = Array.from(shiftConfigSelects).map(select => ({
                    line_id: parseInt(select.dataset.lineId),
                    shift_config_id: select.value === 'override' ? null : parseInt(select.value),
                    use_override: select.value === 'override'
                }));

                let requestData;
                let apiEndpoint;
                
                if (useSimulationCategory) {
                    // Use category-based simulation API
                    apiEndpoint = '/api/simulate/category/';
                    requestData = {
                        simulation_category_id: parseInt(simulationCategoryId),
                        shift_configs: lineShiftConfigs,
                        start_date: document.getElementById('startDate').value,
                        end_date: document.getElementById('endDate').value,
                        client_codes: clientCodes.length > 0 ? clientCodes : null,
                        product_codes: productCodes.length > 0 ? productCodes : null,
                        overlay_client_codes: overlayClients.map(c => c.code),
                        granularity: 'week',
                        demand_modifications: demandModifications.length > 0 ? demandModifications : null
                    };
                } else {
                    // Use line-based simulation API  
                    apiEndpoint = '/api/simulate/line/';
                    requestData = {
                        line_ids: selectedLineIds,
                        shift_configs: lineShiftConfigs,
                        start_date: document.getElementById('startDate').value,
                        end_date: document.getElementById('endDate').value,
                        client_codes: clientCodes.length > 0 ? clientCodes : null,
                        product_codes: productCodes.length > 0 ? productCodes : null,
                        overlay_client_codes: overlayClients.map(c => c.code),
                        granularity: 'week',
                        demand_modifications: demandModifications.length > 0 ? demandModifications : null
                    };
                }
                
                const response = await fetch(apiEndpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrftoken
                    },
                    body: JSON.stringify(requestData)
                });
            
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
            
                const result = await response.json();
                scenarioResults[scenarioId] = result;
            }
            
            // Store the first scenario as the main result for table display
            const firstScenarioId = scenarioCards[0].dataset.scenarioId;
            lastSimulationResult = scenarioResults[firstScenarioId];
            
            // Display results with all scenarios
            displayResultsWithScenarios();
            
        } catch (error) {
            console.error('Simulation error:', error);
            alert('Error running simulation: ' + error.message);
        }
    }

    // Client overlay management functions
    async function addClientOverlay() {
        const input = document.getElementById('clientCodeInput');
        const code = input.value.trim().toUpperCase();
        
        if (!code) {
            return;
        }
        
        // Check if already added
        if (overlayClients.some(c => c.code.toUpperCase() === code.toUpperCase())) {
            alert('Client code already added');
            input.value = '';
            return;
        }
        
        // Verify client exists
        try {
            const data = await fetchAPI(`clients/?code=${code}`);
            const clients = data.results || data;
            const client = clients.find(c => c.code.toUpperCase() === code.toUpperCase());
            
            if (!client) {
                alert(`Client with code "${code}" not found`);
                return;
            }
            
            // Add to overlay list with color
            const colorIndex = overlayClients.length % overlayColors.length;
            overlayClients.push({
                code: client.code,
                name: client.name,
                id: client.id,
                color: overlayColors[colorIndex]
            });
            
            input.value = '';
            updateOverlayClientsList();
            
        } catch (error) {
            console.error('Error verifying client:', error);
            alert('Error verifying client code');
        }
    }
    
    function removeClientOverlay(code) {
        overlayClients = overlayClients.filter(c => c.code !== code);
        updateOverlayClientsList();
    }
    
    function updateOverlayClientsList() {
        const container = document.getElementById('overlayClientsList');
        
        if (overlayClients.length === 0) {
            container.innerHTML = '';
            return;
        }
        
        container.innerHTML = overlayClients.map(client => `
            <span class="badge me-1 mb-1" style="background-color: ${client.color}; cursor: pointer;" 
                  onclick="removeClientOverlay('${client.code}')" title="Click to remove">
                ${client.code} - ${client.name} <i class="bi bi-x"></i>
            </span>
        `).join('');
    }

    // Client filter management functions (similar to client overlays)
    async function addClientFilter() {
        const input = document.getElementById('clientFilterInput');
        const code = input.value.trim().toUpperCase();
        
        if (!code) {
            return;
        }
        
        // Check if already added
        if (filterClients.some(c => c.code.toUpperCase() === code.toUpperCase())) {
            alert('Client code already added to filter');
            input.value = '';
            return;
        }
        
        // Verify client exists
        try {
            const data = await fetchAPI(`clients/?code=${code}`);
            const clients = data.results || data;
            const client = clients.find(c => c.code.toUpperCase() === code.toUpperCase());
            
            if (!client) {
                alert(`Client with code "${code}" not found`);
                return;
            }
            
            // Add to filter list
            filterClients.push({
                code: client.code,
                name: client.name,
                id: client.id
            });
            
            input.value = '';
            updateClientFilterList();
            
        } catch (error) {
            console.error('Error verifying client:', error);
            alert('Error verifying client code');
        }
    }
    
    function removeClientFilter(code) {
        filterClients = filterClients.filter(c => c.code !== code);
        updateClientFilterList();
    }
    
    function updateClientFilterList() {
        const container = document.getElementById('clientFilterList');
        
        if (filterClients.length === 0) {
            container.innerHTML = '';
            return;
        }
        
        container.innerHTML = filterClients.map(client => `
            <span class="badge bg-secondary me-1 mb-1" style="cursor: pointer;" 
                  onclick="removeClientFilter('${client.code}')" title="Click to remove">
                ${client.code} - ${client.name} <i class="bi bi-x"></i>
            </span>
        `).join('');
    }

    // Product filter management functions (similar to client overlays)
    async function addProductFilter() {
        const input = document.getElementById('productFilterInput');
        const code = input.value.trim().toUpperCase();
        
        if (!code) {
            return;
        }
        
        // Check if already added
        if (filterProducts.some(p => p.code.toUpperCase() === code.toUpperCase())) {
            alert('Product code already added to filter');
            input.value = '';
            return;
        }
        
        // Verify product exists
        try {
            const data = await fetchAPI(`products/?code=${code}`);
            const products = data.results || data;
            const product = products.find(p => p.code.toUpperCase() === code.toUpperCase());
            
            if (!product) {
                alert(`Product with code "${code}" not found`);
                return;
            }
            
            // Add to filter list
            filterProducts.push({
                code: product.code,
                name: product.name,
                id: product.id
            });
            
            input.value = '';
            updateProductFilterList();
            
        } catch (error) {
            console.error('Error verifying product:', error);
            alert('Error verifying product code');
        }
    }
    
    function removeProductFilter(code) {
        filterProducts = filterProducts.filter(p => p.code !== code);
        updateProductFilterList();
    }
    
    function updateProductFilterList() {
        const container = document.getElementById('productFilterList');
        
        if (filterProducts.length === 0) {
            container.innerHTML = '';
            return;
        }
        
        container.innerHTML = filterProducts.map(product => `
            <span class="badge bg-info me-1 mb-1" style="cursor: pointer;" 
                  onclick="removeProductFilter('${product.code}')" title="Click to remove">
                ${product.code} - ${product.name} <i class="bi bi-x"></i>
            </span>
        `).join('');
    }

    function displayResultsWithScenarios() {
        // Use the first scenario for stats and table display
        const firstScenarioId = Object.keys(scenarioResults)[0];
        const firstResult = scenarioResults[firstScenarioId];
        
        if (!firstResult) return;
        
        // Store for export
        lastSimulationResult = firstResult;
        const clientOverlays = firstResult.client_overlays || {};
        lastClientOverlays = clientOverlays;
        
        // Show export buttons
        document.getElementById('exportButtons').style.display = 'inline-flex';

        // Update stats (using first scenario)
        document.getElementById('avgUtilization').textContent = firstResult.average_utilization + '%';
        document.getElementById('peakUtilization').textContent = firstResult.peak_utilization + '%';
        document.getElementById('overCapacityPeriods').textContent = firstResult.over_capacity_periods;
        document.getElementById('totalCapacity').textContent = formatNumber(firstResult.total_capacity);

        // Update available weeks for stock adjustment
        const dataPoints = Array.isArray(firstResult.data_points) ? firstResult.data_points : [];
        availableWeeks = dataPoints.map(dp => dp.date);
        updateStockWeekSelect();

        // Update chart with all scenarios
        updateChartWithScenarios();

        // Update table (using first scenario)
        updateTable(dataPoints, clientOverlays);
    }

    function displayResults(result) {
        // Store results for export
        // Defensive: ensure arrays/objects
        lastSimulationResult = result;
        const dataPoints = Array.isArray(result.data_points) ? result.data_points : [];
        const clientOverlays = result.client_overlays || {};
        lastClientOverlays = clientOverlays;

        // Show export buttons
        document.getElementById('exportButtons').style.display = 'inline-flex';

        // Update stats
        document.getElementById('avgUtilization').textContent = result.average_utilization + '%';
        document.getElementById('peakUtilization').textContent = result.peak_utilization + '%';
        document.getElementById('overCapacityPeriods').textContent = result.over_capacity_periods;
        document.getElementById('totalCapacity').textContent = formatNumber(result.total_capacity);

        // Update available weeks for stock adjustment
        availableWeeks = dataPoints.map(dp => dp.date);
        updateStockWeekSelect();

        // Update chart with overlay data
        updateChart(dataPoints, clientOverlays);

        // Update table
        updateTable(dataPoints, clientOverlays);
    }
    
    function getSelectedLineNames() {
        const lineSelect = document.getElementById('lineSelect');
        const selectedIds = Array.from(lineSelect.selectedOptions).map(opt => parseInt(opt.value));
        // Return site_code + line_code format
        return selectedIds.map(id => {
            const line = allLines.find(l => l.id === id);
            return line ? `${line.site_code}-${line.code}` : '';
        }).filter(s => s);
    }

    function updateChartWithScenarios() {
        const ctx = document.getElementById('simulationChart').getContext('2d');
        
        if (simulationChart) {
            simulationChart.destroy();
        }
        
        // Get selected line names for chart subtitle
        const selectedLineNames = getSelectedLineNames();
        const linesSubtitle = selectedLineNames.length > 0 
            ? selectedLineNames.join(' + ') 
            : 'No lines selected';

        // Use first scenario for base data (demand, labels, etc.)
        const firstScenarioId = Object.keys(scenarioResults)[0];
        const firstResult = scenarioResults[firstScenarioId];
        const dataPoints = Array.isArray(firstResult.data_points) ? firstResult.data_points : [];
        const clientOverlays = firstResult.client_overlays || {};

        // Use date_display if available (daily view), otherwise use date (weekly view)
        const labels = dataPoints.map(dp => dp.date_display || dp.date);
        const demandData = dataPoints.map(dp => parseFloat(dp.demand));
        
        // Build datasets array
        const datasets = [
            {
                label: 'Total Demand',
                data: demandData,
                borderColor: chartColors.accent,
                backgroundColor: chartColors.accentLight,
                fill: false,
                tension: 0.3,
                borderWidth: 1.5,
                pointRadius: 0,
                pointHoverRadius: 5,
                order: 2
            }
        ];
        
        // Add capacity line for each scenario
        const scenarioColorsBorder = [
            '#5e3e2f', // brown (primary)
            '#28a745', // green
            '#17a2b8', // cyan
            '#ffc107', // yellow
            '#dc3545', // red
            '#6c757d'  // gray
        ];
        
        const scenarioColorsBackground = [
            'rgba(94, 62, 47, 0.1)',   // brown transparent
            'rgba(40, 167, 69, 0.1)',  // green transparent
            'rgba(23, 162, 184, 0.1)', // cyan transparent
            'rgba(255, 193, 7, 0.1)',  // yellow transparent
            'rgba(220, 53, 69, 0.1)',  // red transparent
            'rgba(108, 117, 125, 0.1)' // gray transparent
        ];
        
        const scenarioCards = document.querySelectorAll('.scenario-card');
        scenarioCards.forEach((card, index) => {
            const scenarioId = card.dataset.scenarioId;
            const result = scenarioResults[scenarioId];
            
            if (!result) return;
            
            const scenarioNum = index + 1;
            const scenarioDataPoints = Array.isArray(result.data_points) ? result.data_points : [];
            const capacityData = scenarioDataPoints.map(dp => parseFloat(dp.capacity));
            
            // Point colors for capacity - highlight overrides and weekends
            const capacityPointColors = scenarioDataPoints.map(dp => {
                if (dp.has_override) return '#ffc107';
                if (dp.is_weekend) return '#6c757d';
                return scenarioColorsBorder[index % scenarioColorsBorder.length];
            });
            const capacityPointRadius = scenarioDataPoints.map(dp => 
                dp.has_override ? 4 : 0
            );
            
            datasets.push({
                label: `Capacity - Scenario ${scenarioNum}`,
                data: capacityData,
                borderColor: scenarioColorsBorder[index % scenarioColorsBorder.length],
                backgroundColor: scenarioColorsBackground[index % scenarioColorsBackground.length],
                borderDash: index === 0 ? [5, 5] : [2, 2],
                fill: true, // Fill all scenarios with transparent background
                tension: 0,
                pointBackgroundColor: capacityPointColors,
                pointBorderColor: capacityPointColors,
                pointRadius: capacityPointRadius,
                pointHoverRadius: 5,
                borderWidth: index === 0 ? 1.5 : 1,
                order: 1 + index * 0.1
            });
        });
        
        // Add adjusted demand curve if stock adjustments or super chill adjustments exist
        const adjustedDemand = calculateAdjustedDemand(dataPoints);
        if (adjustedDemand) {
            // Determine label based on what adjustments are active
            let adjustedLabel = 'Adjusted Demand';
            const hasStock = stockAdjustments.length > 0;
            const hasSuperChill = superChillAdjustments.length > 0;
            const hasFrozen = frozenAdjustments.length > 0;
            
            const parts = [];
            if (hasStock) parts.push('Stock');
            if (hasSuperChill) parts.push('Super Chill');
            if (hasFrozen) parts.push('Frozen');
            
            if (parts.length === 1) {
                adjustedLabel = `Demand with ${parts[0]}`;
            } else if (parts.length > 1) {
                adjustedLabel = `Demand (${parts.join(' + ')})`;
            }
            
            datasets.push({
                label: adjustedLabel,
                data: adjustedDemand,
                borderColor: '#17a2b8',
                backgroundColor: '#17a2b840',
                fill: false,
                tension: 0.3,
                borderWidth: 1.5,
                borderDash: [10, 5],
                pointRadius: 0,
                pointHoverRadius: 5,
                pointStyle: 'rectRot',
                order: 0
            });
        }
        
        // Check if we should combine overlays
        const combineOverlays = document.getElementById('combineOverlays').checked;
        
        if (combineOverlays && Object.keys(clientOverlays).length > 0) {
            // Create combined overlay
            const combinedDemandData = dataPoints.map(dp => {
                let sum = 0;
                Object.entries(clientOverlays).forEach(([clientCode, overlayData]) => {
                    const overlayPoint = overlayData.data_points.find(op => op.date === dp.date);
                    sum += overlayPoint ? parseFloat(overlayPoint.demand) : 0;
                });
                return sum;
            });
            
            const clientCodes = Object.keys(clientOverlays).join(' + ');
            
            datasets.push({
                label: `Combined (${clientCodes})`,
                data: combinedDemandData,
                borderColor: '#9b59b6',
                backgroundColor: '#9b59b640',
                fill: false,
                tension: 0.3,
                borderWidth: 1.5,
                pointRadius: 0,
                pointHoverRadius: 5,
                order: 3
            });
        } else {
            // Add overlay datasets for each client separately
            Object.entries(clientOverlays).forEach(([clientCode, overlayData], index) => {
                const overlayClient = overlayClients.find(c => c.code === clientCode);
                const color = overlayClient ? overlayClient.color : overlayColors[index % overlayColors.length];
                
                const overlayDemandData = dataPoints.map(dp => {
                    const overlayPoint = overlayData.data_points.find(op => op.date === dp.date);
                    return overlayPoint ? parseFloat(overlayPoint.demand) : 0;
                });
                
                datasets.push({
                    label: `${clientCode} (${overlayData.client_name})`,
                    data: overlayDemandData,
                    borderColor: color,
                    backgroundColor: color + '40',
                    fill: false,
                    tension: 0.3,
                    borderWidth: 1.5,
                    pointRadius: 0,
                    pointHoverRadius: 5,
                    order: 3 + index
                });
            });
        }

        simulationChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: datasets
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: `Lines: ${linesSubtitle}`,
                        font: {
                            size: 14,
                            weight: 'normal'
                        },
                        color: '#6c757d',
                        padding: {
                            bottom: 10
                        }
                    },
                    legend: {
                        position: 'top',
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        callbacks: {
                            afterBody: function(context) {
                                const dataIndex = context[0].dataIndex;
                                const dp = dataPoints[dataIndex];
                                if (dp.has_override) {
                                    return ['âš ï¸ Config override active for this week'];
                                }
                                return [];
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Units'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Date'
                        }
                    }
                }
            }
        });
    }

    function updateChart(dataPoints, clientOverlays) {
        const ctx = document.getElementById('simulationChart').getContext('2d');
        
        if (simulationChart) {
            simulationChart.destroy();
        }
        
        // Get selected line names for chart subtitle
        const selectedLineNames = getSelectedLineNames();
        const linesSubtitle = selectedLineNames.length > 0 
            ? selectedLineNames.join(' + ') 
            : 'No lines selected';

        // Use date_display if available (daily view), otherwise use date (weekly view)
        const labels = dataPoints.map(dp => dp.date_display || dp.date);
        const demandData = dataPoints.map(dp => parseFloat(dp.demand));
        const capacityData = dataPoints.map(dp => parseFloat(dp.capacity));
        
        // Point colors for capacity - highlight overrides and weekends
        const capacityPointColors = dataPoints.map(dp => {
            if (dp.has_override) return '#ffc107';
            if (dp.is_weekend) return '#6c757d';  // Gray for weekends
            return chartColors.primary;
        });
        const capacityPointRadius = dataPoints.map(dp => 
            dp.has_override ? 4 : 0
        );
        
        // Build datasets array
        const datasets = [
            {
                label: 'Total Demand',
                data: demandData,
                borderColor: chartColors.accent,
                backgroundColor: chartColors.accentLight,
                fill: false,
                tension: 0.3,
                borderWidth: 1.5,
                pointRadius: 0,
                pointHoverRadius: 5,
                order: 2
            },
            {
                label: 'Capacity',
                data: capacityData,
                borderColor: chartColors.primary,
                backgroundColor: chartColors.primaryLight,
                borderDash: [5, 5],
                fill: true,
                tension: 0,
                borderWidth: 1.5,
                pointBackgroundColor: capacityPointColors,
                pointBorderColor: capacityPointColors,
                pointRadius: capacityPointRadius,
                pointHoverRadius: 5,
                order: 1
            }
        ];
        
        // Add adjusted demand curve if stock adjustments or super chill adjustments exist
        const adjustedDemand = calculateAdjustedDemand(dataPoints);
        if (adjustedDemand) {
            // Determine label based on what adjustments are active
            let adjustedLabel = 'Adjusted Demand';
            const hasStock = stockAdjustments.length > 0;
            const hasSuperChill = superChillAdjustments.length > 0;
            const hasFrozen = frozenAdjustments.length > 0;
            
            const parts = [];
            if (hasStock) parts.push('Stock');
            if (hasSuperChill) parts.push('Super Chill');
            if (hasFrozen) parts.push('Frozen');
            
            if (parts.length === 1) {
                adjustedLabel = `Demand with ${parts[0]}`;
            } else if (parts.length > 1) {
                adjustedLabel = `Demand (${parts.join(' + ')})`;
            }
            
            datasets.push({
                label: adjustedLabel,
                data: adjustedDemand,
                borderColor: '#17a2b8',  // Teal/cyan color
                backgroundColor: '#17a2b840',
                fill: false,
                tension: 0.3,
                borderWidth: 1.5,
                borderDash: [10, 5],
                pointRadius: 0,
                pointHoverRadius: 5,
                pointStyle: 'rectRot',
                order: 0  // Draw on top
            });
        }
        
        // Check if we should combine overlays
        const combineOverlays = document.getElementById('combineOverlays').checked;
        
        if (combineOverlays && Object.keys(clientOverlays).length > 0) {
            // Create combined overlay - sum all client demands
            const combinedDemandData = dataPoints.map(dp => {
                let sum = 0;
                Object.entries(clientOverlays).forEach(([clientCode, overlayData]) => {
                    const overlayPoint = overlayData.data_points.find(op => op.date === dp.date);
                    sum += overlayPoint ? parseFloat(overlayPoint.demand) : 0;
                });
                return sum;
            });
            
            // Build label with all client codes
            const clientCodes = Object.keys(clientOverlays).join(' + ');
            
            datasets.push({
                label: `Combined (${clientCodes})`,
                data: combinedDemandData,
                borderColor: '#9b59b6',  // Purple for combined
                backgroundColor: '#9b59b640',
                fill: false,
                tension: 0.3,
                borderWidth: 1.5,
                pointRadius: 0,
                pointHoverRadius: 5,
                order: 3
            });
        } else {
            // Add overlay datasets for each client separately
            Object.entries(clientOverlays).forEach(([clientCode, overlayData], index) => {
                const overlayClient = overlayClients.find(c => c.code === clientCode);
                const color = overlayClient ? overlayClient.color : overlayColors[index % overlayColors.length];
                
                // Map overlay demand data to match dataPoints labels
                const overlayDemandData = dataPoints.map(dp => {
                    const overlayPoint = overlayData.data_points.find(op => op.date === dp.date);
                    return overlayPoint ? parseFloat(overlayPoint.demand) : 0;
                });
                
                datasets.push({
                    label: `${clientCode} (${overlayData.client_name})`,
                    data: overlayDemandData,
                    borderColor: color,
                    backgroundColor: color + '40',  // Add transparency
                    fill: false,
                    tension: 0.3,
                    borderWidth: 1.5,
                    pointRadius: 0,
                    pointHoverRadius: 5,
                    order: 3 + index
                });
            });
        }

        simulationChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: datasets
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: `Lines: ${linesSubtitle}`,
                        font: {
                            size: 14,
                            weight: 'normal'
                        },
                        color: '#6c757d',
                        padding: {
                            bottom: 10
                        }
                    },
                    legend: {
                        position: 'top',
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        callbacks: {
                            afterBody: function(context) {
                                const dataIndex = context[0].dataIndex;
                                const dp = dataPoints[dataIndex];
                                if (dp.has_override) {
                                    return ['âš ï¸ Config override active for this week'];
                                }
                                return [];
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Units'
                        }
                    }
                }
            }
        });
    }

    function updateTable(dataPoints, clientOverlays) {
        const tbody = document.querySelector('#dataTable tbody');
        const combineOverlays = document.getElementById('combineOverlays').checked;
        
        // Build dynamic header for overlay columns
        let overlayHeaders = '';
        if (combineOverlays && Object.keys(clientOverlays).length > 0) {
            const clientCodes = Object.keys(clientOverlays).join(' + ');
            overlayHeaders = `<th>Combined (${clientCodes})</th>`;
        } else {
            overlayHeaders = Object.entries(clientOverlays).map(([code, data]) => 
                `<th>${code}</th>`
            ).join('');
        }
        
        const thead = document.querySelector('#dataTable thead tr');
        const granularity = document.querySelector('input[name="granularity"]:checked')?.value || 'week';
        const periodLabel = granularity === 'day' ? 'Date' : 'Week';
        thead.innerHTML = `
            <th>${periodLabel}</th>
            <th>Total Demand</th>
            ${overlayHeaders}
            <th>Capacity</th>
            <th>Utilization</th>
            <th>Status</th>
        `;
        
        tbody.innerHTML = dataPoints.map(dp => {
            // Get overlay values for this data point
            let overlayValues = '';
            if (combineOverlays && Object.keys(clientOverlays).length > 0) {
                // Sum all overlay values
                let sum = 0;
                Object.entries(clientOverlays).forEach(([code, data]) => {
                    const overlayPoint = data.data_points.find(op => op.date === dp.date);
                    sum += overlayPoint ? parseFloat(overlayPoint.demand) : 0;
                });
                overlayValues = `<td>${formatNumber(sum)}</td>`;
            } else {
                overlayValues = Object.entries(clientOverlays).map(([code, data]) => {
                    const overlayPoint = data.data_points.find(op => op.date === dp.date);
                    const value = overlayPoint ? overlayPoint.demand : 0;
                    return `<td>${formatNumber(value)}</td>`;
                }).join('');
            }
            
            // Determine row class - weekends get muted style
            let rowClass = '';
            if (dp.over_capacity) rowClass = 'table-danger';
            else if (dp.has_override) rowClass = 'table-warning';
            else if (dp.is_weekend) rowClass = 'table-secondary';
            
            // Use date_display if available for daily view
            const displayDate = dp.date_display || dp.date;
            
            return `
                <tr class="${rowClass}">
                    <td>
                        ${displayDate}
                        ${dp.has_override ? '<i class="bi bi-gear text-warning ms-1" title="Config override active"></i>' : ''}
                        ${dp.is_weekend ? '<i class="bi bi-calendar-x text-muted ms-1" title="Weekend"></i>' : ''}
                    </td>
                    <td>${formatNumber(dp.demand)}</td>
                    ${overlayValues}
                    <td>${formatNumber(dp.capacity)}</td>
                    <td>${dp.utilization_percent}%</td>
                    <td>
                        ${dp.over_capacity 
                            ? '<span class="badge bg-danger">Over Capacity</span>' 
                            : '<span class="badge bg-success">OK</span>'}
                    </td>
                </tr>
            `;
        }).join('');
    }

    function formatNumber(num) {
        return parseFloat(num).toLocaleString('en-US', { maximumFractionDigits: 0 });
    }
    
    // Export Functions
    function exportToCSV() {
        if (!lastSimulationResult) {
            alert('No simulation data to export. Run a simulation first.');
            return;
        }
        
        const dataPoints = lastSimulationResult.data_points;
        const overlays = lastClientOverlays;
        const granularity = document.querySelector('input[name="granularity"]:checked')?.value || 'week';
        const periodLabel = granularity === 'day' ? 'Date' : 'Week';
        const periodType = granularity === 'day' ? 'Days' : 'Weeks';
        const combineOverlays = document.getElementById('combineOverlays').checked;
        
        // Build CSV headers
        let headers = [periodLabel, 'Total Demand'];
        if (combineOverlays && Object.keys(overlays).length > 0) {
            const clientCodes = Object.keys(overlays).join(' + ');
            headers.push(`Combined (${clientCodes})`);
        } else {
            Object.keys(overlays).forEach(code => {
                headers.push(code);
            });
        }
        headers.push('Capacity', 'Utilization %', 'Status', 'Has Override');
        
        // Build CSV rows
        let csvContent = headers.join(',') + '\n';
        
        dataPoints.forEach(dp => {
            let row = [
                dp.date,
                dp.demand
            ];
            
            // Add overlay values
            if (combineOverlays && Object.keys(overlays).length > 0) {
                let sum = 0;
                Object.entries(overlays).forEach(([code, data]) => {
                    const overlayPoint = data.data_points.find(op => op.date === dp.date);
                    sum += overlayPoint ? parseFloat(overlayPoint.demand) : 0;
                });
                row.push(sum);
            } else {
                Object.entries(overlays).forEach(([code, data]) => {
                    const overlayPoint = data.data_points.find(op => op.date === dp.date);
                    row.push(overlayPoint ? overlayPoint.demand : 0);
                });
            }
            
            row.push(
                dp.capacity,
                dp.utilization_percent,
                dp.over_capacity ? 'Over Capacity' : 'OK',
                dp.has_override ? 'Yes' : 'No'
            );
            
            csvContent += row.join(',') + '\n';
        });
        
        // Add summary row
        csvContent += '\n';
        csvContent += `Summary\n`;
        csvContent += `Average Utilization,${lastSimulationResult.average_utilization}%\n`;
        csvContent += `Peak Utilization,${lastSimulationResult.peak_utilization}%\n`;
        csvContent += `Over-Capacity ${periodType},${lastSimulationResult.over_capacity_periods}\n`;
        csvContent += `Total Capacity,${lastSimulationResult.total_capacity}\n`;
        csvContent += `Total Demand,${lastSimulationResult.total_demand}\n`;
        
        // Download
        downloadFile(csvContent, 'line_simulation_export.csv', 'text/csv');
    }
    
    function exportToExcel() {
        if (!lastSimulationResult) {
            alert('No simulation data to export. Run a simulation first.');
            return;
        }
        
        const dataPoints = lastSimulationResult.data_points;
        const overlays = lastClientOverlays;
        const granularity = document.querySelector('input[name="granularity"]:checked')?.value || 'week';
        const periodLabel = granularity === 'day' ? 'Date' : 'Week';
        const periodType = granularity === 'day' ? 'Days' : 'Weeks';
        const combineOverlays = document.getElementById('combineOverlays').checked;
        
        // Build HTML table for Excel
        let html = '<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel">';
        html += '<head><meta charset="UTF-8"></head><body>';
        html += '<table border="1">';
        
        // Headers
        html += '<tr style="background-color: #4a90d9; color: white; font-weight: bold;">';
        html += `<th>${periodLabel}</th><th>Total Demand</th>`;
        if (combineOverlays && Object.keys(overlays).length > 0) {
            const clientCodes = Object.keys(overlays).join(' + ');
            html += `<th>Combined (${clientCodes})</th>`;
        } else {
            Object.keys(overlays).forEach(code => {
                html += `<th>${code}</th>`;
            });
        }
        html += '<th>Capacity</th><th>Utilization %</th><th>Status</th><th>Has Override</th>';
        html += '</tr>';
        
        // Data rows
        dataPoints.forEach(dp => {
            const rowStyle = dp.over_capacity ? 'background-color: #f8d7da;' : (dp.has_override ? 'background-color: #fff3cd;' : '');
            html += `<tr style="${rowStyle}">`;
            html += `<td>${dp.date}</td>`;
            html += `<td>${dp.demand}</td>`;
            
            if (combineOverlays && Object.keys(overlays).length > 0) {
                let sum = 0;
                Object.entries(overlays).forEach(([code, data]) => {
                    const overlayPoint = data.data_points.find(op => op.date === dp.date);
                    sum += overlayPoint ? parseFloat(overlayPoint.demand) : 0;
                });
                html += `<td>${sum}</td>`;
            } else {
                Object.entries(overlays).forEach(([code, data]) => {
                    const overlayPoint = data.data_points.find(op => op.date === dp.date);
                    html += `<td>${overlayPoint ? overlayPoint.demand : 0}</td>`;
                });
            }
            
            html += `<td>${dp.capacity}</td>`;
            html += `<td>${dp.utilization_percent}%</td>`;
            html += `<td>${dp.over_capacity ? 'Over Capacity' : 'OK'}</td>`;
            html += `<td>${dp.has_override ? 'Yes' : 'No'}</td>`;
            html += '</tr>';
        });
        
        // Summary section
        html += '<tr><td colspan="8"></td></tr>';
        html += '<tr style="background-color: #e9ecef; font-weight: bold;"><td colspan="8">Summary</td></tr>';
        html += `<tr><td>Average Utilization</td><td colspan="7">${lastSimulationResult.average_utilization}%</td></tr>`;
        html += `<tr><td>Peak Utilization</td><td colspan="7">${lastSimulationResult.peak_utilization}%</td></tr>`;
        html += `<tr><td>Over-Capacity ${periodType}</td><td colspan="7">${lastSimulationResult.over_capacity_periods}</td></tr>`;
        html += `<tr><td>Total Capacity</td><td colspan="7">${lastSimulationResult.total_capacity}</td></tr>`;
        html += `<tr><td>Total Demand</td><td colspan="7">${lastSimulationResult.total_demand}</td></tr>`;
        
        html += '</table></body></html>';
        
        // Download as Excel
        downloadFile(html, 'line_simulation_export.xls', 'application/vnd.ms-excel');
    }
    
    function exportChartAsImage() {
        if (!simulationChart) {
            alert('No chart to export. Run a simulation first.');
            return;
        }
        
        // Create a temporary canvas with white background
        const canvas = document.getElementById('simulationChart');
        const tempCanvas = document.createElement('canvas');
        tempCanvas.width = canvas.width;
        tempCanvas.height = canvas.height;
        const tempCtx = tempCanvas.getContext('2d');
        
        // Fill white background
        tempCtx.fillStyle = '#ffffff';
        tempCtx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);
        
        // Draw the chart on top
        tempCtx.drawImage(canvas, 0, 0);
        
        const link = document.createElement('a');
        link.download = 'line_simulation_chart.jpg';
        link.href = tempCanvas.toDataURL('image/jpeg', 1);
        link.click();
    }
    
    function downloadFile(content, filename, mimeType) {
        const blob = new Blob([content], { type: mimeType + ';charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        
        link.setAttribute('href', url);
        link.setAttribute('download', filename);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
    
    // Demand Modification Functions
    let editingModId = null;  // Track if we're editing an existing modification
    
    function addDemandModification() {
        const clientSelect = document.getElementById('modClientSelect');
        const productSelect = document.getElementById('modProductSelect');
        const startDate = document.getElementById('modStartDate').value;
        const endDate = document.getElementById('modEndDate').value;
        const percentage = parseFloat(document.getElementById('modPercentage').value);
        
        if (!clientSelect.value) {
            alert('Please select a client');
            return;
        }
        
        if (!startDate || !endDate) {
            alert('Please select start and end dates');
            return;
        }
        
        if (isNaN(percentage)) {
            alert('Please enter a valid percentage');
            return;
        }
        
        const clientOption = clientSelect.options[clientSelect.selectedIndex];
        const clientCode = clientOption.dataset.code;
        const clientName = clientOption.text;
        
        let productCode = null;
        let productName = 'All products';
        if (productSelect.value) {
            const productOption = productSelect.options[productSelect.selectedIndex];
            productCode = productOption.dataset.code;
            productName = productOption.text;
        }
        
        if (editingModId !== null) {
            // Update existing modification
            const modIndex = demandModifications.findIndex(m => m.id === editingModId);
            if (modIndex !== -1) {
                demandModifications[modIndex] = {
                    id: editingModId,
                    client_id: parseInt(clientSelect.value),
                    client_code: clientCode,
                    client_name: clientName,
                    product_id: productSelect.value ? parseInt(productSelect.value) : null,
                    product_code: productCode,
                    product_name: productName,
                    start_date: startDate,
                    end_date: endDate,
                    percentage: percentage
                };
            }
            editingModId = null;
            document.getElementById('modAddBtn').innerHTML = '<i class="bi bi-plus-lg"></i> Add Modification';
            document.getElementById('modCancelBtn').style.display = 'none';
        } else {
            // Create new modification
            const modId = Date.now();
            demandModifications.push({
                id: modId,
                client_id: parseInt(clientSelect.value),
                client_code: clientCode,
                client_name: clientName,
                product_id: productSelect.value ? parseInt(productSelect.value) : null,
                product_code: productCode,
                product_name: productName,
                start_date: startDate,
                end_date: endDate,
                percentage: percentage
            });
        }
        
        updateDemandModificationsList();
        
        // Reset form
        document.getElementById('modPercentage').value = 0;
    }
    
    function editDemandModification(modId) {
        const mod = demandModifications.find(m => m.id === modId);
        if (!mod) return;
        
        editingModId = modId;
        
        // Populate form with existing values
        document.getElementById('modClientSelect').value = mod.client_id;
        loadClientProducts().then(() => {
            document.getElementById('modProductSelect').value = mod.product_id || '';
        });
        document.getElementById('modStartDate').value = mod.start_date;
        document.getElementById('modEndDate').value = mod.end_date;
        document.getElementById('modPercentage').value = mod.percentage;
        
        // Update button text
        document.getElementById('modAddBtn').innerHTML = '<i class="bi bi-check-lg"></i> Update Modification';
        document.getElementById('modCancelBtn').style.display = 'inline-block';
    }
    
    function cancelEditModification() {
        editingModId = null;
        document.getElementById('modAddBtn').innerHTML = '<i class="bi bi-plus-lg"></i> Add Modification';
        document.getElementById('modCancelBtn').style.display = 'none';
        document.getElementById('modPercentage').value = 0;
    }
    
    function removeDemandModification(modId) {
        demandModifications = demandModifications.filter(m => m.id !== modId);
        if (editingModId === modId) {
            cancelEditModification();
        }
        updateDemandModificationsList();
    }
    
    function updateDemandModificationsList() {
        const container = document.getElementById('demandModificationsList');
        
        if (demandModifications.length === 0) {
            container.innerHTML = '';
            return;
        }
        
        container.innerHTML = demandModifications.map(mod => {
            const percentClass = mod.percentage < 0 ? 'text-danger' : 'text-success';
            const percentSign = mod.percentage >= 0 ? '+' : '';
            const percentIcon = mod.percentage === -100 ? 'ðŸš«' : (mod.percentage < 0 ? 'ðŸ“‰' : 'ðŸ“ˆ');
            const isEditing = editingModId === mod.id;
            
            return `
                <div class="alert ${isEditing ? 'alert-warning' : 'alert-secondary'} py-1 px-2 mb-1">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="small">
                            <strong>${mod.client_code}</strong> - ${mod.product_code || 'All'}<br>
                            <span class="${percentClass}">${percentIcon} ${percentSign}${mod.percentage}%</span>
                            <span class="text-muted">(${mod.start_date} to ${mod.end_date})</span>
                        </div>
                        <div>
                            <button class="btn btn-sm btn-outline-primary py-0 px-1 me-1" onclick="editDemandModification(${mod.id})" title="Edit">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger py-0 px-1" onclick="removeDemandModification(${mod.id})" title="Remove">
                                <i class="bi bi-x"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }).join('');
    }
    
    // Stock Adjustment Functions
    function addStockAdjustment() {
        const weekSelect = document.getElementById('stockWeekSelect');
        const units = parseFloat(document.getElementById('stockUnits').value);
        
        if (!weekSelect.value) {
            alert('Please select a week');
            return;
        }
        
        if (isNaN(units) || units === 0) {
            alert('Please enter a valid number of units (non-zero)');
            return;
        }
        
        const week = weekSelect.value;
        const weekIndex = availableWeeks.indexOf(week);
        
        if (weekIndex === availableWeeks.length - 1) {
            alert('Cannot adjust the last week as there is no following week to balance');
            return;
        }
        
        const nextWeek = availableWeeks[weekIndex + 1];
        
        if (editingStockId !== null) {
            // Update existing adjustment
            const adjIndex = stockAdjustments.findIndex(a => a.id === editingStockId);
            if (adjIndex !== -1) {
                stockAdjustments[adjIndex] = {
                    id: editingStockId,
                    week: week,
                    next_week: nextWeek,
                    units: units
                };
            }
            editingStockId = null;
            document.getElementById('stockAddBtn').innerHTML = '<i class="bi bi-plus-lg"></i> Add Stock Adjustment';
            document.getElementById('stockCancelBtn').style.display = 'none';
        } else {
            // Create new adjustment
            const adjId = Date.now();
            stockAdjustments.push({
                id: adjId,
                week: week,
                next_week: nextWeek,
                units: units
            });
        }
        
        updateStockAdjustmentsList();
        document.getElementById('stockUnits').value = 0;
        
        // Re-render chart if we have results
        if (lastSimulationResult) {
            updateChart(lastSimulationResult.data_points, lastClientOverlays);
        }
    }
    
    function editStockAdjustment(adjId) {
        const adj = stockAdjustments.find(a => a.id === adjId);
        if (!adj) return;
        
        editingStockId = adjId;
        document.getElementById('stockWeekSelect').value = adj.week;
        document.getElementById('stockUnits').value = adj.units;
        
        document.getElementById('stockAddBtn').innerHTML = '<i class="bi bi-check-lg"></i> Update Adjustment';
        document.getElementById('stockCancelBtn').style.display = 'inline-block';
    }
    
    function cancelEditStockAdjustment() {
        editingStockId = null;
        document.getElementById('stockAddBtn').innerHTML = '<i class="bi bi-plus-lg"></i> Add Stock Adjustment';
        document.getElementById('stockCancelBtn').style.display = 'none';
        document.getElementById('stockUnits').value = 0;
    }
    
    function removeStockAdjustment(adjId) {
        stockAdjustments = stockAdjustments.filter(a => a.id !== adjId);
        if (editingStockId === adjId) {
            cancelEditStockAdjustment();
        }
        updateStockAdjustmentsList();
        
        // Re-render chart if we have results
        if (lastSimulationResult) {
            updateChart(lastSimulationResult.data_points, lastClientOverlays);
        }
    }
    
    function updateStockAdjustmentsList() {
        const container = document.getElementById('stockAdjustmentsList');
        
        if (stockAdjustments.length === 0) {
            container.innerHTML = '';
            return;
        }
        
        container.innerHTML = stockAdjustments.map(adj => {
            const isEditing = editingStockId === adj.id;
            const unitsClass = adj.units > 0 ? 'text-success' : 'text-danger';
            const unitsSign = adj.units > 0 ? '+' : '';
            const icon = adj.units > 0 ? 'ðŸ“¦âž¡ï¸' : 'â¬…ï¸ðŸ“¦';
            
            return `
                <div class="alert ${isEditing ? 'alert-warning' : 'alert-info'} py-1 px-2 mb-1">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="small">
                            ${icon} <strong>${adj.week}</strong>: <span class="${unitsClass}">${unitsSign}${adj.units.toLocaleString()}</span> units<br>
                            <span class="text-muted">â†’ ${adj.next_week}: <span class="${adj.units > 0 ? 'text-danger' : 'text-success'}">${adj.units > 0 ? '-' : '+'}${Math.abs(adj.units).toLocaleString()}</span> units</span>
                        </div>
                        <div>
                            <button class="btn btn-sm btn-outline-primary py-0 px-1 me-1" onclick="editStockAdjustment(${adj.id})" title="Edit">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger py-0 px-1" onclick="removeStockAdjustment(${adj.id})" title="Remove">
                                <i class="bi bi-x"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }).join('');
    }
    
    function updateStockWeekSelect() {
        const select = document.getElementById('stockWeekSelect');
        select.innerHTML = '<option value="">Select week...</option>' + 
            availableWeeks.slice(0, -1).map(week => `<option value="${week}">${week}</option>`).join('');
        
        // Also update super chill week selects
        updateSuperChillWeekSelects();
        
        // Also update frozen week selects
        updateFrozenWeekSelects();
    }
    
    function updateSuperChillWeekSelects() {
        const reduceSelect = document.getElementById('superChillReduceWeek');
        const increaseSelect = document.getElementById('superChillIncreaseWeek');
        
        // Reduce week can be any week except the first 4 (need at least 4 weeks before)
        reduceSelect.innerHTML = '<option value="">Select week...</option>' + 
            availableWeeks.slice(4).map(week => `<option value="${week}">${week}</option>`).join('');
        
        // Increase week options will be populated based on reduce week selection
        increaseSelect.innerHTML = '<option value="">Select reduce week first...</option>';
        
        // Add event listener for reduce week change
        reduceSelect.onchange = updateIncreaseWeekOptions;
    }
    
    function updateIncreaseWeekOptions() {
        const reduceWeek = document.getElementById('superChillReduceWeek').value;
        const increaseSelect = document.getElementById('superChillIncreaseWeek');
        
        if (!reduceWeek) {
            increaseSelect.innerHTML = '<option value="">Select reduce week first...</option>';
            return;
        }
        
        const reduceIndex = availableWeeks.indexOf(reduceWeek);
        // Allow selection of 1 to 4 weeks before the reduce week
        const minIndex = Math.max(0, reduceIndex - 4);
        const eligibleWeeks = availableWeeks.slice(minIndex, reduceIndex);
        
        increaseSelect.innerHTML = '<option value="">Select week...</option>' + 
            eligibleWeeks.map((week, i) => {
                const weeksApart = reduceIndex - (minIndex + i);
                return `<option value="${week}">${week} (${weeksApart} week${weeksApart > 1 ? 's' : ''} before)</option>`;
            }).join('');
    }
    
    function calculateAdjustedDemand(dataPoints) {
        if (stockAdjustments.length === 0 && superChillAdjustments.length === 0 && frozenAdjustments.length === 0) return null;
        
        // Create a copy of demand data
        const adjustedDemand = dataPoints.map(dp => parseFloat(dp.demand));
        
        // Apply each stock adjustment
        stockAdjustments.forEach(adj => {
            const weekIndex = dataPoints.findIndex(dp => dp.date === adj.week);
            const nextWeekIndex = dataPoints.findIndex(dp => dp.date === adj.next_week);
            
            if (weekIndex !== -1 && nextWeekIndex !== -1) {
                adjustedDemand[weekIndex] += adj.units;
                adjustedDemand[nextWeekIndex] -= adj.units;
            }
        });
        
        // Apply each super chill adjustment
        superChillAdjustments.forEach(adj => {
            const reduceIndex = dataPoints.findIndex(dp => dp.date === adj.reduce_week);
            const increaseIndex = dataPoints.findIndex(dp => dp.date === adj.increase_week);
            
            if (reduceIndex !== -1 && increaseIndex !== -1) {
                adjustedDemand[reduceIndex] -= adj.units;  // Reduce demand in peak week
                adjustedDemand[increaseIndex] += adj.units;  // Increase demand in pre-prod week
            }
        });
        
        // Apply each frozen adjustment
        frozenAdjustments.forEach(adj => {
            const reduceIndex = dataPoints.findIndex(dp => dp.date === adj.reduce_week);
            const increaseIndex = dataPoints.findIndex(dp => dp.date === adj.increase_week);
            
            if (reduceIndex !== -1 && increaseIndex !== -1) {
                adjustedDemand[reduceIndex] -= adj.units;  // Reduce demand in peak week
                adjustedDemand[increaseIndex] += adj.units;  // Increase demand in pre-prod week
            }
        });
        
        return adjustedDemand;
    }
    
    // Super Chill Adjustment Functions
    function addSuperChillAdjustment() {
        const reduceWeek = document.getElementById('superChillReduceWeek').value;
        const increaseWeek = document.getElementById('superChillIncreaseWeek').value;
        const units = parseFloat(document.getElementById('superChillUnits').value);
        
        if (!reduceWeek) {
            alert('Please select a week to reduce demand from (peak week)');
            return;
        }
        
        if (!increaseWeek) {
            alert('Please select a week to increase demand (pre-production week)');
            return;
        }
        
        if (isNaN(units) || units <= 0) {
            alert('Please enter a valid positive number of units to transfer');
            return;
        }
        
        // Validate that increase week is before reduce week
        const reduceIndex = availableWeeks.indexOf(reduceWeek);
        const increaseIndex = availableWeeks.indexOf(increaseWeek);
        
        if (increaseIndex >= reduceIndex) {
            alert('Increase week must be before the reduce week');
            return;
        }
        
        const weeksApart = reduceIndex - increaseIndex;
        if (weeksApart > 4) {
            alert('Super chilling allows maximum 4 weeks between reduce and increase weeks');
            return;
        }
        
        if (editingSuperChillId !== null) {
            // Update existing adjustment
            const adjIndex = superChillAdjustments.findIndex(a => a.id === editingSuperChillId);
            if (adjIndex !== -1) {
                superChillAdjustments[adjIndex] = {
                    id: editingSuperChillId,
                    reduce_week: reduceWeek,
                    increase_week: increaseWeek,
                    units: units,
                    weeks_apart: weeksApart
                };
            }
            editingSuperChillId = null;
            document.getElementById('superChillAddBtn').innerHTML = '<i class="bi bi-plus-lg"></i> Add Super Chill Adjustment';
            document.getElementById('superChillCancelBtn').style.display = 'none';
        } else {
            // Create new adjustment
            const adjId = Date.now();
            superChillAdjustments.push({
                id: adjId,
                reduce_week: reduceWeek,
                increase_week: increaseWeek,
                units: units,
                weeks_apart: weeksApart
            });
        }
        
        updateSuperChillAdjustmentsList();
        document.getElementById('superChillUnits').value = 0;
        document.getElementById('superChillReduceWeek').value = '';
        document.getElementById('superChillIncreaseWeek').innerHTML = '<option value="">Select reduce week first...</option>';
        
        // Re-render chart if we have results
        if (lastSimulationResult) {
            updateChart(lastSimulationResult.data_points, lastClientOverlays);
        }
    }
    
    function editSuperChillAdjustment(adjId) {
        const adj = superChillAdjustments.find(a => a.id === adjId);
        if (!adj) return;
        
        editingSuperChillId = adjId;
        document.getElementById('superChillReduceWeek').value = adj.reduce_week;
        updateIncreaseWeekOptions();
        document.getElementById('superChillIncreaseWeek').value = adj.increase_week;
        document.getElementById('superChillUnits').value = adj.units;
        
        document.getElementById('superChillAddBtn').innerHTML = '<i class="bi bi-check-lg"></i> Update Adjustment';
        document.getElementById('superChillCancelBtn').style.display = 'inline-block';
    }
    
    function cancelEditSuperChillAdjustment() {
        editingSuperChillId = null;
        document.getElementById('superChillAddBtn').innerHTML = '<i class="bi bi-plus-lg"></i> Add Super Chill Adjustment';
        document.getElementById('superChillCancelBtn').style.display = 'none';
        document.getElementById('superChillUnits').value = 0;
        document.getElementById('superChillReduceWeek').value = '';
        document.getElementById('superChillIncreaseWeek').innerHTML = '<option value="">Select reduce week first...</option>';
    }
    
    function removeSuperChillAdjustment(adjId) {
        superChillAdjustments = superChillAdjustments.filter(a => a.id !== adjId);
        if (editingSuperChillId === adjId) {
            cancelEditSuperChillAdjustment();
        }
        updateSuperChillAdjustmentsList();
        
        // Re-render chart if we have results
        if (lastSimulationResult) {
            updateChart(lastSimulationResult.data_points, lastClientOverlays);
        }
    }
    
    function updateSuperChillAdjustmentsList() {
        const container = document.getElementById('superChillAdjustmentsList');
        
        if (superChillAdjustments.length === 0) {
            container.innerHTML = '';
            return;
        }
        
        container.innerHTML = superChillAdjustments.map(adj => {
            const isEditing = editingSuperChillId === adj.id;
            
            return `
                <div class="alert ${isEditing ? 'alert-warning' : 'alert-info'} py-1 px-2 mb-1" style="border-left: 3px solid #17a2b8;">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="small">
                            <i class="bi bi-snow text-info"></i> <strong>${adj.reduce_week}</strong>: <span class="text-danger">-${adj.units.toLocaleString()}</span> units<br>
                            <span class="text-muted">â†’ ${adj.increase_week}: <span class="text-success">+${adj.units.toLocaleString()}</span> units</span>
                            <span class="badge bg-info ms-1">${adj.weeks_apart}W apart</span>
                        </div>
                        <div>
                            <button class="btn btn-sm btn-outline-primary py-0 px-1 me-1" onclick="editSuperChillAdjustment(${adj.id})" title="Edit">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger py-0 px-1" onclick="removeSuperChillAdjustment(${adj.id})" title="Remove">
                                <i class="bi bi-x"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }).join('');
    }
    
    // Calculate modified demand based on demand modifications (for chart overlay)
    function calculateModifiedDemand(dataPoints) {
        if (demandModifications.length === 0) return null;
        
        // This is a client-side approximation - the actual calculation happens server-side
        // We show it as a visual indicator that modifications are active
        // The actual modified values are already in the demand from the server
        // So we return null here - the server already applies modifications
        return null;
    }
    
    // Frozen Adjustment Functions
    function updateFrozenWeekSelects() {
        const reduceSelect = document.getElementById('frozenReduceWeek');
        const increaseSelect = document.getElementById('frozenIncreaseWeek');
        
        // Reduce week can be any week except the first one
        reduceSelect.innerHTML = '<option value="">Select week...</option>' + 
            availableWeeks.slice(1).map(week => `<option value="${week}">${week}</option>`).join('');
        
        // Increase week options will be populated based on reduce week selection
        increaseSelect.innerHTML = '<option value="">Select reduce week first...</option>';
        
        // Add event listener for reduce week change
        reduceSelect.onchange = updateFrozenIncreaseWeekOptions;
    }
    
    function updateFrozenIncreaseWeekOptions() {
        const reduceWeek = document.getElementById('frozenReduceWeek').value;
        const increaseSelect = document.getElementById('frozenIncreaseWeek');
        
        if (!reduceWeek) {
            increaseSelect.innerHTML = '<option value="">Select reduce week first...</option>';
            return;
        }
        
        const reduceIndex = availableWeeks.indexOf(reduceWeek);
        // Allow selection of any week before the reduce week (no limit)
        const eligibleWeeks = availableWeeks.slice(0, reduceIndex);
        
        increaseSelect.innerHTML = '<option value="">Select week...</option>' + 
            eligibleWeeks.map((week, i) => {
                const weeksApart = reduceIndex - i;
                return `<option value="${week}">${week} (${weeksApart} week${weeksApart > 1 ? 's' : ''} before)</option>`;
            }).join('');
    }
    
    function addFrozenAdjustment() {
        const reduceWeek = document.getElementById('frozenReduceWeek').value;
        const increaseWeek = document.getElementById('frozenIncreaseWeek').value;
        const units = parseFloat(document.getElementById('frozenUnits').value);
        
        if (!reduceWeek) {
            alert('Please select a week to reduce demand from (peak week)');
            return;
        }
        
        if (!increaseWeek) {
            alert('Please select a week to increase demand (pre-production week)');
            return;
        }
        
        if (isNaN(units) || units <= 0) {
            alert('Please enter a valid positive number of units to transfer');
            return;
        }
        
        // Validate that increase week is before reduce week
        const reduceIndex = availableWeeks.indexOf(reduceWeek);
        const increaseIndex = availableWeeks.indexOf(increaseWeek);
        
        if (increaseIndex >= reduceIndex) {
            alert('Increase week must be before the reduce week');
            return;
        }
        
        const weeksApart = reduceIndex - increaseIndex;
        
        if (editingFrozenId !== null) {
            // Update existing adjustment
            const adjIndex = frozenAdjustments.findIndex(a => a.id === editingFrozenId);
            if (adjIndex !== -1) {
                frozenAdjustments[adjIndex] = {
                    id: editingFrozenId,
                    reduce_week: reduceWeek,
                    increase_week: increaseWeek,
                    units: units,
                    weeks_apart: weeksApart
                };
            }
            editingFrozenId = null;
            document.getElementById('frozenAddBtn').innerHTML = '<i class="bi bi-plus-lg"></i> Add Frozen Adjustment';
            document.getElementById('frozenCancelBtn').style.display = 'none';
        } else {
            // Create new adjustment
            const adjId = Date.now();
            frozenAdjustments.push({
                id: adjId,
                reduce_week: reduceWeek,
                increase_week: increaseWeek,
                units: units,
                weeks_apart: weeksApart
            });
        }
        
        updateFrozenAdjustmentsList();
        document.getElementById('frozenUnits').value = 0;
        document.getElementById('frozenReduceWeek').value = '';
        document.getElementById('frozenIncreaseWeek').innerHTML = '<option value="">Select reduce week first...</option>';
        
        // Re-render chart if we have results
        if (lastSimulationResult) {
            updateChart(lastSimulationResult.data_points, lastClientOverlays);
        }
    }
    
    function editFrozenAdjustment(adjId) {
        const adj = frozenAdjustments.find(a => a.id === adjId);
        if (!adj) return;
        
        editingFrozenId = adjId;
        document.getElementById('frozenReduceWeek').value = adj.reduce_week;
        updateFrozenIncreaseWeekOptions();
        document.getElementById('frozenIncreaseWeek').value = adj.increase_week;
        document.getElementById('frozenUnits').value = adj.units;
        
        document.getElementById('frozenAddBtn').innerHTML = '<i class="bi bi-check-lg"></i> Update Adjustment';
        document.getElementById('frozenCancelBtn').style.display = 'inline-block';
    }
    
    function cancelEditFrozenAdjustment() {
        editingFrozenId = null;
        document.getElementById('frozenAddBtn').innerHTML = '<i class="bi bi-plus-lg"></i> Add Frozen Adjustment';
        document.getElementById('frozenCancelBtn').style.display = 'none';
        document.getElementById('frozenUnits').value = 0;
        document.getElementById('frozenReduceWeek').value = '';
        document.getElementById('frozenIncreaseWeek').innerHTML = '<option value="">Select reduce week first...</option>';
    }
    
    function removeFrozenAdjustment(adjId) {
        frozenAdjustments = frozenAdjustments.filter(a => a.id !== adjId);
        if (editingFrozenId === adjId) {
            cancelEditFrozenAdjustment();
        }
        updateFrozenAdjustmentsList();
        
        // Re-render chart if we have results
        if (lastSimulationResult) {
            updateChart(lastSimulationResult.data_points, lastClientOverlays);
        }
    }
    
    function updateFrozenAdjustmentsList() {
        const container = document.getElementById('frozenAdjustmentsList');
        
        if (frozenAdjustments.length === 0) {
            container.innerHTML = '';
            return;
        }
        
        container.innerHTML = frozenAdjustments.map(adj => {
            const isEditing = editingFrozenId === adj.id;
            
            return `
                <div class="alert ${isEditing ? 'alert-warning' : 'alert-primary'} py-1 px-2 mb-1" style="border-left: 3px solid #0d6efd;">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="small">
                            <i class="bi bi-snow text-primary"></i><i class="bi bi-snow text-primary"></i> <strong>${adj.reduce_week}</strong>: <span class="text-danger">-${adj.units.toLocaleString()}</span> units<br>
                            <span class="text-muted">â†’ ${adj.increase_week}: <span class="text-success">+${adj.units.toLocaleString()}</span> units</span>
                            <span class="badge bg-primary ms-1">${adj.weeks_apart}W apart</span>
                        </div>
                        <div>
                            <button class="btn btn-sm btn-outline-primary py-0 px-1 me-1" onclick="editFrozenAdjustment(${adj.id})" title="Edit">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger py-0 px-1" onclick="removeFrozenAdjustment(${adj.id})" title="Remove">
                                <i class="bi bi-x"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }).join('');
    }
</script>
{% endblock %}
