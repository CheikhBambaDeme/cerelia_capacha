{% extends 'base.html' %}

{% block title %}Categories - Cerelia{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="bi bi-collection"></i> Simulation Categories</h2>
    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#categoryModal" onclick="resetForm()">
        <i class="bi bi-plus-lg"></i> New Category
    </button>
</div>

<!-- Categories List -->
<div class="card">
    <div class="card-header">
        <i class="bi bi-list-ul"></i> <span style="color: #ea6d09;">Defined Categories</span>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-striped table-hover" id="categoriesTable">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Site</th>
                        <th>Lines</th>
                        <th>Product Types</th>
                        <th>Recipe Types</th>
                        <th>Material Types</th>
                        <th>Packaging Types</th>
                        <th>Matching Products</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="categoriesBody">
                    <tr>
                        <td colspan="9" class="text-center text-muted">Loading categories...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Category Modal -->
<div class="modal fade" id="categoryModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">
                    <i class="bi bi-collection"></i> New Category
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="categoryForm">
                    <input type="hidden" id="categoryId">
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold">Category Name *</label>
                        <input type="text" class="form-control" id="categoryName" required placeholder="e.g., Pizza Lines - Fresh">
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold">Description</label>
                        <textarea class="form-control" id="categoryDescription" rows="2" placeholder="Optional description"></textarea>
                    </div>
                    
                    <hr>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label fw-bold">Site (optional)</label>
                                <select class="form-select" id="categorySite">
                                    <option value="">All Sites</option>
                                </select>
                                <small class="text-muted">Filter available lines by site</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label fw-bold">Production Lines *</label>
                                <select class="form-select" id="categoryLines" multiple size="5">
                                </select>
                                <small class="text-muted">Hold Ctrl to select multiple lines</small>
                            </div>
                        </div>
                    </div>
                    
                    <hr>
                    <h6 style="color: #ea6d09;"><i class="bi bi-funnel"></i> Product Filters</h6>
                    <small class="text-muted d-block mb-3">Select product attributes to filter which products are included</small>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Product Types</label>
                                <select class="form-select" id="categoryProductTypes" multiple size="4">
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Recipe Types</label>
                                <select class="form-select" id="categoryRecipeTypes" multiple size="4">
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Material Types</label>
                                <select class="form-select" id="categoryMaterialTypes" multiple size="4">
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Packaging Types</label>
                                <select class="form-select" id="categoryPackagingTypes" multiple size="4">
                                </select>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveCategory()">
                    <i class="bi bi-check-lg"></i> Save Category
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title text-danger">
                    <i class="bi bi-exclamation-triangle"></i> Confirm Delete
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this category?</p>
                <p class="fw-bold" id="deleteItemName"></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" onclick="confirmDelete()">
                    <i class="bi bi-trash"></i> Delete
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // API_BASE is defined in base.html
    let allSites = [];
    let allLines = [];
    let productAttributes = {};
    let deleteItemId = null;
    
    document.addEventListener('DOMContentLoaded', async function() {
        try {
            await Promise.all([
                loadSites(),
                loadLines(),
                loadProductAttributes(),
                loadCategories()
            ]);
        } catch (error) {
            console.error('Error during initialization:', error);
        }
        
        // Setup site change listener to filter lines
        document.getElementById('categorySite').addEventListener('change', filterLinesBySite);
    });
    
    async function loadSites() {
        try {
            const response = await fetch(API_BASE + 'sites/');
            const data = await response.json();
            allSites = data.results || data;
            
            const select = document.getElementById('categorySite');
            select.innerHTML = '<option value="">All Sites</option>' + 
                allSites.map(s => `<option value="${s.id}">${s.name} (${s.code})</option>`).join('');
        } catch (error) {
            console.error('Error loading sites:', error);
        }
    }
    
    async function loadLines() {
        try {
            const response = await fetch(API_BASE + 'lines/');
            const data = await response.json();
            allLines = data.results || data;
            
            updateLinesSelect(allLines);
        } catch (error) {
            console.error('Error loading lines:', error);
        }
    }
    
    function updateLinesSelect(lines) {
        const select = document.getElementById('categoryLines');
        select.innerHTML = lines.map(l => 
            `<option value="${l.id}">${l.site_name} - ${l.name}</option>`
        ).join('');
    }
    
    function filterLinesBySite() {
        const siteId = document.getElementById('categorySite').value;
        if (siteId) {
            const filteredLines = allLines.filter(l => l.site == siteId);
            updateLinesSelect(filteredLines);
        } else {
            updateLinesSelect(allLines);
        }
    }
    
    async function loadProductAttributes() {
        try {
            console.log('Loading product attributes from:', API_BASE + 'simulation-categories/product_attributes/');
            const response = await fetch(API_BASE + 'simulation-categories/product_attributes/');
            console.log('Response status:', response.status);
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            productAttributes = await response.json();
            console.log('Product attributes loaded:', productAttributes);
            
            populateAttributeSelect('categoryProductTypes', productAttributes.product_types);
            populateAttributeSelect('categoryRecipeTypes', productAttributes.recipe_types);
            populateAttributeSelect('categoryMaterialTypes', productAttributes.material_types);
            populateAttributeSelect('categoryPackagingTypes', productAttributes.packaging_types);
            
            console.log('Dropdowns populated successfully');
        } catch (error) {
            console.error('Error loading product attributes:', error);
            // Set fallback message in dropdowns
            ['categoryProductTypes', 'categoryRecipeTypes', 'categoryMaterialTypes', 'categoryPackagingTypes'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.innerHTML = '<option value="">Error loading - check console</option>';
            });
        }
    }
    
    function populateAttributeSelect(selectId, values) {
        const select = document.getElementById(selectId);
        if (!values || !Array.isArray(values) || values.length === 0) {
            select.innerHTML = '<option value="">No values available</option>';
            return;
        }
        select.innerHTML = values.map(v => `<option value="${v}">${v}</option>`).join('');
    }
    
    async function loadCategories() {
        try {
            const response = await fetch(API_BASE + 'simulation-categories/');
            const data = await response.json();
            const categories = data.results || data;
            
            const tbody = document.getElementById('categoriesBody');
            
            if (categories.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="text-center text-muted">No categories defined yet. Click "New Category" to create one.</td></tr>';
                return;
            }
            
            tbody.innerHTML = categories.map(cat => `
                <tr>
                    <td><strong>${cat.name}</strong></td>
                    <td>${cat.site_name || 'All Sites'}</td>
                    <td>
                        <span class="badge bg-primary">${cat.lines_data?.length || 0} lines</span>
                    </td>
                    <td>${formatFilterValue(cat.product_types)}</td>
                    <td>${formatFilterValue(cat.recipe_types)}</td>
                    <td>${formatFilterValue(cat.material_types)}</td>
                    <td>${formatFilterValue(cat.packaging_types)}</td>
                    <td><span class="badge bg-success">${cat.matching_products_count} products</span></td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary me-1" onclick="editCategory(${cat.id})" title="Edit">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteCategory(${cat.id}, '${cat.name}')" title="Delete">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        } catch (error) {
            console.error('Error loading categories:', error);
            document.getElementById('categoriesBody').innerHTML = 
                '<tr><td colspan="9" class="text-center text-danger">Error loading categories</td></tr>';
        }
    }
    
    function formatFilterValue(value) {
        if (!value || value.trim() === '') return '<span class="text-muted">Any</span>';
        const items = value.split(',').map(v => v.trim()).filter(v => v);
        if (items.length === 0) return '<span class="text-muted">Any</span>';
        if (items.length <= 2) return items.join(', ');
        return `${items.slice(0, 2).join(', ')} +${items.length - 2}`;
    }
    
    function resetForm() {
        document.getElementById('categoryForm').reset();
        document.getElementById('categoryId').value = '';
        document.getElementById('modalTitle').innerHTML = '<i class="bi bi-collection"></i> New Category';
        filterLinesBySite();
        
        // Clear all multi-selects
        ['categoryLines', 'categoryProductTypes', 'categoryRecipeTypes', 'categoryMaterialTypes', 'categoryPackagingTypes'].forEach(id => {
            const select = document.getElementById(id);
            Array.from(select.options).forEach(opt => opt.selected = false);
        });
    }
    
    async function editCategory(id) {
        try {
            const response = await fetch(API_BASE + `simulation-categories/${id}/`);
            const category = await response.json();
            
            document.getElementById('categoryId').value = category.id;
            document.getElementById('categoryName').value = category.name;
            document.getElementById('categoryDescription').value = category.description || '';
            document.getElementById('categorySite').value = category.site || '';
            
            // Filter lines by site first
            filterLinesBySite();
            
            // Wait for DOM update then set lines
            setTimeout(() => {
                const linesSelect = document.getElementById('categoryLines');
                const lineIds = category.lines_data?.map(l => l.id) || [];
                Array.from(linesSelect.options).forEach(opt => {
                    opt.selected = lineIds.includes(parseInt(opt.value));
                });
                
                // Set product attributes
                setMultiSelectValues('categoryProductTypes', category.product_types);
                setMultiSelectValues('categoryRecipeTypes', category.recipe_types);
                setMultiSelectValues('categoryMaterialTypes', category.material_types);
                setMultiSelectValues('categoryPackagingTypes', category.packaging_types);
            }, 100);
            
            document.getElementById('modalTitle').innerHTML = '<i class="bi bi-pencil"></i> Edit Category';
            new bootstrap.Modal(document.getElementById('categoryModal')).show();
        } catch (error) {
            console.error('Error loading category:', error);
            showToast('Error loading category', 'danger');
        }
    }
    
    function setMultiSelectValues(selectId, values) {
        const select = document.getElementById(selectId);
        const valueList = values ? values.split(',').map(v => v.trim()) : [];
        Array.from(select.options).forEach(opt => {
            opt.selected = valueList.includes(opt.value);
        });
    }
    
    function getMultiSelectValues(selectId) {
        const select = document.getElementById(selectId);
        return Array.from(select.selectedOptions).map(opt => opt.value).join(',');
    }
    
    async function saveCategory() {
        const id = document.getElementById('categoryId').value;
        const name = document.getElementById('categoryName').value.trim();
        
        if (!name) {
            showToast('Please enter a category name', 'warning');
            return;
        }
        
        const linesSelect = document.getElementById('categoryLines');
        const lineIds = Array.from(linesSelect.selectedOptions).map(opt => parseInt(opt.value));
        
        if (lineIds.length === 0) {
            showToast('Please select at least one production line', 'warning');
            return;
        }
        
        const data = {
            name: name,
            description: document.getElementById('categoryDescription').value.trim(),
            site: document.getElementById('categorySite').value || null,
            line_ids: lineIds,
            product_types: getMultiSelectValues('categoryProductTypes'),
            recipe_types: getMultiSelectValues('categoryRecipeTypes'),
            material_types: getMultiSelectValues('categoryMaterialTypes'),
            packaging_types: getMultiSelectValues('categoryPackagingTypes')
        };
        
        try {
            const url = id ? API_BASE + `simulation-categories/${id}/` : API_BASE + 'simulation-categories/';
            const method = id ? 'PUT' : 'POST';
            
            const response = await fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify(data)
            });
            
            if (response.ok) {
                bootstrap.Modal.getInstance(document.getElementById('categoryModal')).hide();
                showToast(id ? 'Category updated successfully' : 'Category created successfully', 'success');
                loadCategories();
            } else {
                const error = await response.json();
                showToast('Error: ' + JSON.stringify(error), 'danger');
            }
        } catch (error) {
            console.error('Error saving category:', error);
            showToast('Error saving category', 'danger');
        }
    }
    
    function deleteCategory(id, name) {
        deleteItemId = id;
        document.getElementById('deleteItemName').textContent = name;
        new bootstrap.Modal(document.getElementById('deleteModal')).show();
    }
    
    async function confirmDelete() {
        if (!deleteItemId) return;
        
        try {
            const response = await fetch(API_BASE + `simulation-categories/${deleteItemId}/`, {
                method: 'DELETE',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                }
            });
            
            if (response.ok) {
                bootstrap.Modal.getInstance(document.getElementById('deleteModal')).hide();
                showToast('Category deleted successfully', 'success');
                loadCategories();
            } else {
                showToast('Error deleting category', 'danger');
            }
        } catch (error) {
            console.error('Error deleting category:', error);
            showToast('Error deleting category', 'danger');
        }
        
        deleteItemId = null;
    }
</script>
{% endblock %}
