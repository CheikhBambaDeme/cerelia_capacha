{% extends 'base.html' %}

{% block title %}Lab Simulation - Cerelia Simulation{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="bi bi-flask"></i> Lab Simulation</h2>
    <button class="btn btn-primary" onclick="runSimulation()">
        <i class="bi bi-play-fill"></i> Run Simulation
    </button>
</div>

<div class="row">
    <!-- Configuration Panel -->
    <div class="col-md-4">
        <div class="card mb-4" style="max-height: 85vh; min-height: 500px; display: flex; flex-direction: column;">
            <div class="card-header">
                <i class="bi bi-sliders"></i> <span style="color: #ea6d09;">Configuration</span>
                <span class="badge bg-info float-end">Real + Lab</span>
            </div>
            <div class="card-body flex-grow-1 overflow-auto" style="min-height: 0;">
                <!-- Date Range -->
                <div class="mb-3">
                    <label class="form-label" style="color: #5e3e2f; font-weight: bold;">Date Range</label>
                    <div class="row">
                        <div class="col-6">
                            <input type="date" class="form-control" id="startDate">
                        </div> 
                        <div class="col-6">
                            <input type="date" class="form-control" id="endDate">
                        </div>
                    </div>
                </div>

                <!-- Real Lines Selection -->
                <div class="mb-3">
                    <label class="form-label" style="color: #ea6d09; font-weight: bold;">
                        <i class="bi bi-building"></i> Real Production Lines
                    </label>
                    <select class="form-select" id="realLineSelect" multiple size="4">
                    </select>
                    <small class="text-muted">Hold Ctrl to select multiple lines</small>
                </div>

                <!-- Lab Lines Selection -->
                <div class="mb-3">
                    <label class="form-label" style="color: #5e3e2f; font-weight: bold;">
                        <i class="bi bi-flask"></i> Lab Lines <span class="badge bg-info">Fictive</span>
                    </label>
                    <select class="form-select" id="labLineSelect" multiple size="4">
                    </select>
                    <small class="text-muted">Hold Ctrl to select multiple lines</small>
                </div>

                <!-- Include Lab Forecasts -->
                <div class="mb-3">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="includeLabForecasts" checked>
                        <label class="form-check-label" for="includeLabForecasts">
                            <i class="bi bi-graph-up-arrow"></i> Include Lab Forecasts in Demand
                        </label>
                    </div>
                </div>

                <hr>

                <!-- Real Data Filters -->
                <h6 style="color: #ea6d09; font-weight: bold;"><i class="bi bi-funnel"></i> Real Data Filters</h6>
                
                <div class="mb-3">
                    <label class="form-label" style="color: #5e3e2f; font-weight: bold;">Filter by Client (codes, comma-separated)</label>
                    <input type="text" class="form-control" id="clientFilter" list="clientDatalist" placeholder="Enter client code(s), e.g. C001,C002">
                    <datalist id="clientDatalist"></datalist>
                </div>

                <div class="mb-3">
                    <label class="form-label" style="color: #ea6d09; font-weight: bold;">Filter by Category</label>
                    <select class="form-select" id="categoryFilter">
                        <option value="">All Categories</option>
                    </select>
                </div>

                <div class="mb-3">
                    <label class="form-label" style="color: #5e3e2f; font-weight: bold;">Filter by Product (code)</label>
                    <input type="text" class="form-control" id="productFilter" list="productDatalist" placeholder="Enter product code">
                    <datalist id="productDatalist"></datalist>
                </div>

                <hr>

                <!-- Lab Data Filters -->
                <h6 style="color: #0dcaf0; font-weight: bold;"><i class="bi bi-flask"></i> Lab Data Filters</h6>
                
                <div class="mb-3">
                    <label class="form-label" style="color: #5e3e2f; font-weight: bold;">Filter by Lab Client</label>
                    <select class="form-select" id="labClientFilter">
                        <option value="">All Lab Clients</option>
                    </select>
                </div>

                <div class="mb-3">
                    <label class="form-label" style="color: #0dcaf0; font-weight: bold;">Filter by Lab Category</label>
                    <select class="form-select" id="labCategoryFilter">
                        <option value="">All Lab Categories</option>
                    </select>
                </div>

                <div class="mb-3">
                    <label class="form-label" style="color: #5e3e2f; font-weight: bold;">Filter by Lab Product (code)</label>
                    <input type="text" class="form-control" id="labProductFilter" list="labProductDatalist" placeholder="Enter lab product code">
                    <datalist id="labProductDatalist"></datalist>
                </div>

                <hr>

                <!-- Client Demand Overlays -->
                <h6 style="color: #ea6d09; font-weight: bold;"><i class="bi bi-layers"></i> Client Demand Overlays</h6>
                <small class="text-muted d-block mb-2">Add client codes to overlay their demand curves</small>
                
                <div class="mb-3">
                    <div class="input-group">
                        <input type="text" class="form-control" id="clientCodeInput" placeholder="Enter client code">
                        <button class="btn btn-outline-secondary" type="button" onclick="addClientOverlay()">
                            <i class="bi bi-plus"></i>
                        </button>
                    </div>
                </div>
                
                <div id="overlayClientsList" class="mb-3">
                    <!-- Client overlay tags will appear here -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- Results Panel -->
    <div class="col-md-8">
        <!-- Summary Stats -->
        <div class="row mb-3">
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body py-2">
                        <div class="stat-value" id="avgUtilization">-</div>
                        <div class="stat-label small text-muted">Avg Utilization</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body py-2">
                        <div class="stat-value" id="peakUtilization">-</div>
                        <div class="stat-label small text-muted">Peak Utilization</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body py-2">
                        <div class="stat-value" id="overCapacityWeeks">-</div>
                        <div class="stat-label small text-muted">Over Capacity</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body py-2">
                        <div class="stat-value" id="totalCapacity">-</div>
                        <div class="stat-label small text-muted">Total Capacity</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Active Filters Display -->
        <div id="activeFilters" class="alert alert-info mb-3" style="display: none;">
            <i class="bi bi-funnel-fill"></i> <strong>Active Filters:</strong>
            <span id="filterSummary"></span>
        </div>

        <!-- Chart -->
        <div class="card mb-3">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="bi bi-graph-up"></i> Demand vs Capacity</span>
                <div>
                    <span class="badge bg-primary me-1">
                        <i class="bi bi-circle-fill"></i> Capacity
                    </span>
                    <span class="badge bg-danger me-1">
                        <i class="bi bi-circle-fill"></i> Total Demand
                    </span>
                    <span class="badge bg-warning me-1">
                        <i class="bi bi-circle-fill"></i> Real Demand
                    </span>
                    <span class="badge bg-info">
                        <i class="bi bi-circle-fill"></i> Lab Demand
                    </span>
                </div>
            </div>
            <div class="card-body">
                <canvas id="simulationChart" height="300"></canvas>
                <div id="noSimulation" class="text-center text-muted py-5">
                    <i class="bi bi-graph-up" style="font-size: 3rem;"></i>
                    <p class="mt-2">Configure and run simulation to see results</p>
                </div>
            </div>
        </div>
        
        <!-- Weekly Table -->
        <div class="card">
            <div class="card-header">
                <i class="bi bi-table"></i> Weekly Breakdown
            </div>
            <div class="card-body">
                <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                    <table class="table table-hover table-sm" id="weeklyTable">
                        <thead class="sticky-top bg-white">
                            <tr>
                                <th>Week</th>
                                <th>Real Demand</th>
                                <th>Lab Demand</th>
                                <th>Total Demand</th>
                                <th>Capacity</th>
                                <th>Utilization</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Dynamic content -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const API_LINES = '/api/lines/';
const API_LAB_LINES = '/api/lab/lines/';
const API_CLIENTS = '/api/clients/';
const API_CATEGORIES = '/api/categories/';
const API_PRODUCTS = '/api/products/';
const API_LAB_CLIENTS = '/api/lab/clients/';
const API_LAB_CATEGORIES = '/api/lab/categories/';
const API_LAB_PRODUCTS = '/api/lab/products/';
const API_LAB_SIMULATE = '/api/simulate/lab/';

// CSRF Token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

const csrftoken = getCookie('csrftoken');

let simulationChart = null;
let realLines = [];
let labLines = [];
let clients = [];
let categories = [];
let products = [];
let labClients = [];
let labCategories = [];
let labProducts = [];
let overlayClients = [];

document.addEventListener('DOMContentLoaded', function() {
    // Set default dates
    const today = new Date();
    const futureDate = new Date(today);
    futureDate.setMonth(futureDate.getMonth() + 6);
    
    document.getElementById('startDate').value = today.toISOString().split('T')[0];
    document.getElementById('endDate').value = futureDate.toISOString().split('T')[0];
    
    loadAllData();
});

async function loadAllData() {
    await Promise.all([
        loadRealLines(),
        loadLabLines(),
        loadClients(),
        loadCategories(),
        loadProducts(),
        loadLabClients(),
        loadLabCategories(),
        loadLabProducts()
    ]);
}

async function loadRealLines() {
    try {
        const response = await fetch(API_LINES);
        const data = await response.json();
        realLines = data.results || data;
        
        const select = document.getElementById('realLineSelect');
        select.innerHTML = realLines.map(line => 
            `<option value="${line.id}">${line.site_code || ''} - ${line.name}</option>`
        ).join('');
    } catch (error) {
        console.error('Error loading real lines:', error);
    }
}

async function loadLabLines() {
    try {
        const response = await fetch(API_LAB_LINES);
        const data = await response.json();
        labLines = data.results || data;
        
        const select = document.getElementById('labLineSelect');
        if (labLines.length === 0) {
            select.innerHTML = '<option value="" disabled>No lab lines created yet</option>';
        } else {
            select.innerHTML = labLines.map(line => 
                `<option value="${line.id}">[LAB] ${line.code} - ${line.name}</option>`
            ).join('');
        }
    } catch (error) {
        console.error('Error loading lab lines:', error);
    }
}

async function loadClients() {
    try {
        const response = await fetch(API_CLIENTS);
        const data = await response.json();
        clients = data.results || data;
        
        const datalist = document.getElementById('clientDatalist');
        datalist.innerHTML = clients.map(c => 
            `<option value="${c.code}">${c.name}</option>`
        ).join('');
    } catch (error) {
        console.error('Error loading clients:', error);
    }
}

async function loadCategories() {
    try {
        const response = await fetch(API_CATEGORIES);
        const data = await response.json();
        categories = data.results || data;
        
        const select = document.getElementById('categoryFilter');
        select.innerHTML = '<option value="">All Categories</option>' +
            categories.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
    } catch (error) {
        console.error('Error loading categories:', error);
    }
}

async function loadProducts() {
    try {
        const response = await fetch(API_PRODUCTS);
        const data = await response.json();
        products = data.results || data;
        
        const datalist = document.getElementById('productDatalist');
        datalist.innerHTML = products.map(p => 
            `<option value="${p.code}">${p.name}</option>`
        ).join('');
    } catch (error) {
        console.error('Error loading products:', error);
    }
}

async function loadLabClients() {
    try {
        const response = await fetch(API_LAB_CLIENTS);
        const data = await response.json();
        labClients = data.results || data;
        
        const select = document.getElementById('labClientFilter');
        select.innerHTML = '<option value="">All Lab Clients</option>' +
            labClients.map(c => `<option value="${c.id}">[LAB] ${c.name}</option>`).join('');
    } catch (error) {
        console.error('Error loading lab clients:', error);
    }
}

async function loadLabCategories() {
    try {
        const response = await fetch(API_LAB_CATEGORIES);
        const data = await response.json();
        labCategories = data.results || data;
        
        const select = document.getElementById('labCategoryFilter');
        select.innerHTML = '<option value="">All Lab Categories</option>' +
            labCategories.map(c => `<option value="${c.id}">[LAB] ${c.name}</option>`).join('');
    } catch (error) {
        console.error('Error loading lab categories:', error);
    }
}

async function loadLabProducts() {
    try {
        const response = await fetch(API_LAB_PRODUCTS);
        const data = await response.json();
        labProducts = data.results || data;
        
        const datalist = document.getElementById('labProductDatalist');
        datalist.innerHTML = labProducts.map(p => 
            `<option value="${p.code}">[LAB] ${p.name}</option>`
        ).join('');
    } catch (error) {
        console.error('Error loading lab products:', error);
    }
}

function addClientOverlay() {
    const input = document.getElementById('clientCodeInput');
    const code = input.value.trim().toUpperCase();
    
    if (!code) return;
    
    // Check if client exists
    const client = clients.find(c => c.code.toUpperCase() === code);
    if (!client) {
        alert(`Client with code "${code}" not found`);
        return;
    }
    
    // Check if already added
    if (overlayClients.find(c => c.code === client.code)) {
        alert('Client already added');
        return;
    }
    
    overlayClients.push(client);
    renderOverlayClients();
    input.value = '';
}

function removeClientOverlay(code) {
    overlayClients = overlayClients.filter(c => c.code !== code);
    renderOverlayClients();
}

function renderOverlayClients() {
    const container = document.getElementById('overlayClientsList');
    container.innerHTML = overlayClients.map(client => `
        <span class="badge bg-secondary me-1 mb-1">
            ${client.code} - ${client.name}
            <button type="button" class="btn-close btn-close-white ms-1" 
                    style="font-size: 0.6rem;" 
                    onclick="removeClientOverlay('${client.code}')"></button>
        </span>
    `).join('');
}

async function runSimulation() {
    const startDate = document.getElementById('startDate').value;
    const endDate = document.getElementById('endDate').value;
    
    // Get selected real lines
    const realLineSelect = document.getElementById('realLineSelect');
    const selectedRealLines = Array.from(realLineSelect.selectedOptions).map(opt => parseInt(opt.value));
    
    // Get selected lab lines
    const labLineSelect = document.getElementById('labLineSelect');
    const selectedLabLines = Array.from(labLineSelect.selectedOptions).map(opt => parseInt(opt.value));
    
    if (selectedRealLines.length === 0 && selectedLabLines.length === 0) {
        alert('Please select at least one production line (real or lab)');
        return;
    }
    
    // Get filters
    const clientCodesRaw = document.getElementById('clientFilter').value.trim();
    const clientCodes = clientCodesRaw ? clientCodesRaw.split(',').map(c => c.trim()).filter(Boolean) : [];
    const productCode = document.getElementById('productFilter').value.trim();
    const categoryId = document.getElementById('categoryFilter').value;
    const includeLabForecasts = document.getElementById('includeLabForecasts').checked;
    
    // Get lab filters
    const labClientId = document.getElementById('labClientFilter').value;
    const labCategoryId = document.getElementById('labCategoryFilter').value;
    const labProductCode = document.getElementById('labProductFilter').value.trim();
    
    const requestData = {
        line_ids: selectedRealLines,
        lab_line_ids: selectedLabLines,
        start_date: startDate,
        end_date: endDate,
        include_lab_forecasts: includeLabForecasts,
        client_codes: clientCodes.length > 0 ? clientCodes : null,
        product_code: productCode || null,
        category_id: categoryId || null,
        lab_client_id: labClientId || null,
        lab_category_id: labCategoryId || null,
        lab_product_code: labProductCode || null,
        overlay_client_codes: overlayClients.map(c => c.code)
    };
    
    try {
        const response = await fetch(API_LAB_SIMULATE, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            },
            body: JSON.stringify(requestData)
        });
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const result = await response.json();
        displayResults(result);
    } catch (error) {
        console.error('Error running simulation:', error);
        alert('Error running simulation: ' + error.message);
    }
}

function displayResults(result) {
    document.getElementById('noSimulation').style.display = 'none';
    
    // Update summary stats
    document.getElementById('avgUtilization').textContent = result.average_utilization + '%';
    document.getElementById('peakUtilization').textContent = result.peak_utilization + '%';
    document.getElementById('overCapacityWeeks').textContent = result.over_capacity_periods + ' weeks';
    document.getElementById('totalCapacity').textContent = 
        parseFloat(result.total_capacity).toLocaleString('en-US', {maximumFractionDigits: 0});
    
    // Color coding for utilization
    const avgUtil = parseFloat(result.average_utilization);
    const avgEl = document.getElementById('avgUtilization');
    avgEl.style.color = avgUtil > 100 ? '#dc3545' : avgUtil > 85 ? '#fd7e14' : '#198754';
    
    // Show active filters
    if (result.overlay_data && Object.keys(result.overlay_data).length > 0) {
        const filterSummary = [];
        // Real data filters
        if (result.overlay_data.client_codes) {
            filterSummary.push(`Clients: ${result.overlay_data.client_codes.join(', ')}`);
        }
        if (result.overlay_data.product_code) {
            filterSummary.push(`Product: ${result.overlay_data.product_code}`);
        }
        if (result.overlay_data.category_name) {
            filterSummary.push(`Category: ${result.overlay_data.category_name}`);
        }
        // Lab data filters
        if (result.overlay_data.lab_client_name) {
            filterSummary.push(`Lab Client: ${result.overlay_data.lab_client_name}`);
        }
        if (result.overlay_data.lab_product_code) {
            filterSummary.push(`Lab Product: ${result.overlay_data.lab_product_code}`);
        }
        if (result.overlay_data.lab_category_name) {
            filterSummary.push(`Lab Category: ${result.overlay_data.lab_category_name}`);
        }
        
        document.getElementById('filterSummary').textContent = filterSummary.join(' | ');
        document.getElementById('activeFilters').style.display = 'block';
    } else {
        document.getElementById('activeFilters').style.display = 'none';
    }
    
    // Update chart
    updateChart(result);
    
    // Update table
    updateTable(result.data_points);
}

function updateChart(result) {
    const ctx = document.getElementById('simulationChart').getContext('2d');
    const dataPoints = result.data_points;
    
    if (simulationChart) {
        simulationChart.destroy();
    }
    
    const labels = dataPoints.map(dp => dp.date);
    const capacityData = dataPoints.map(dp => parseFloat(dp.capacity));
    const realDemandData = dataPoints.map(dp => parseFloat(dp.real_demand || 0));
    const labDemandData = dataPoints.map(dp => parseFloat(dp.lab_demand || 0));
    const totalDemandData = dataPoints.map(dp => parseFloat(dp.demand));
    
    const datasets = [
        {
            label: 'Capacity',
            data: capacityData,
            borderColor: '#0d6efd',
            backgroundColor: 'rgba(13, 110, 253, 0.1)',
            fill: true,
            tension: 0.1,
            order: 2
        },
        {
            label: 'Total Demand',
            data: totalDemandData,
            borderColor: '#dc3545',
            backgroundColor: 'transparent',
            borderWidth: 3,
            fill: false,
            tension: 0.1,
            order: 1
        },
        {
            label: 'Real Demand',
            data: realDemandData,
            borderColor: '#ffc107',
            backgroundColor: 'transparent',
            borderDash: [5, 5],
            fill: false,
            tension: 0.1,
            order: 3
        },
        {
            label: 'Lab Demand',
            data: labDemandData,
            borderColor: '#0dcaf0',
            backgroundColor: 'transparent',
            borderDash: [5, 5],
            fill: false,
            tension: 0.1,
            order: 4
        }
    ];
    
    // Add client overlay datasets
    if (result.client_overlays) {
        const colors = ['#6f42c1', '#20c997', '#fd7e14', '#e83e8c', '#6610f2'];
        let colorIndex = 0;
        
        for (const [code, overlay] of Object.entries(result.client_overlays)) {
            const color = colors[colorIndex % colors.length];
            datasets.push({
                label: `${code} (${overlay.client_name})`,
                data: overlay.data_points.map(dp => parseFloat(dp.demand)),
                borderColor: color,
                backgroundColor: 'transparent',
                borderDash: [3, 3],
                borderWidth: 2,
                fill: false,
                tension: 0.1,
                order: 5 + colorIndex
            });
            colorIndex++;
        }
    }
    
    simulationChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: datasets
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                intersect: false,
                mode: 'index'
            },
            plugins: {
                legend: {
                    position: 'top'
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return context.dataset.label + ': ' + 
                                   context.parsed.y.toLocaleString('en-US', {maximumFractionDigits: 0});
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return value.toLocaleString('en-US', {maximumFractionDigits: 0});
                        }
                    }
                }
            }
        }
    });
}

function updateTable(dataPoints) {
    const tbody = document.querySelector('#weeklyTable tbody');
    
    tbody.innerHTML = dataPoints.map(dp => {
        const utilization = parseFloat(dp.utilization_percent);
        const statusClass = utilization > 100 ? 'danger' : utilization > 85 ? 'warning' : 'success';
        const statusText = utilization > 100 ? 'Over' : utilization > 85 ? 'High' : 'OK';
        
        return `
            <tr>
                <td>${dp.date}</td>
                <td>${parseFloat(dp.real_demand || 0).toLocaleString('en-US', {maximumFractionDigits: 0})}</td>
                <td class="text-info">${parseFloat(dp.lab_demand || 0).toLocaleString('en-US', {maximumFractionDigits: 0})}</td>
                <td><strong>${parseFloat(dp.demand).toLocaleString('en-US', {maximumFractionDigits: 0})}</strong></td>
                <td>${parseFloat(dp.capacity).toLocaleString('en-US', {maximumFractionDigits: 0})}</td>
                <td class="text-${statusClass}">${utilization}%</td>
                <td><span class="badge bg-${statusClass}">${statusText}</span></td>
            </tr>
        `;
    }).join('');
}
</script>

<style>
.stat-card .stat-value {
    font-size: 1.5rem;
    font-weight: 700;
}
</style>
{% endblock %}
