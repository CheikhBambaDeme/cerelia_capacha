{% extends 'base.html' %}

{% block title %}Lost Client Simulation - Cerelia{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="bi bi-person-dash"></i> Lost Client Simulation</h2>
    <button class="btn btn-danger" onclick="runSimulation()">
        <i class="bi bi-play-fill"></i> Run Simulation
    </button>
</div>

<div class="row">
    <!-- Configuration Panel -->
    <div class="col-md-4">
        <div class="card mb-4">
            <div class="card-header">
                <i class="bi bi-sliders"></i> Configuration
            </div>
            <div class="card-body">
                <!-- Date Range -->
                <div class="mb-3">
                    <label class="form-label">Date Range</label>
                    <div class="row">
                        <div class="col-6">
                            <input type="date" class="form-control" id="startDate">
                        </div>
                        <div class="col-6">
                            <input type="date" class="form-control" id="endDate">
                        </div>
                    </div>
                </div>

                <!-- Line Selection -->
                <div class="mb-3">
                    <label class="form-label">Production Lines</label>
                    <select class="form-select" id="lineSelect" multiple size="5">
                    </select>
                </div>

                <!-- Shift Configuration -->
                <div class="mb-3">
                    <label class="form-label">Shift Configurations</label>
                    <div id="shiftConfigContainer">
                        <small class="text-muted">Select lines first</small>
                    </div>
                </div>

                <hr>

                <!-- Client to Lose -->
                <div class="mb-3">
                    <label class="form-label text-danger"><i class="bi bi-person-x"></i> Client to Lose *</label>
                    <select class="form-select" id="lostClientSelect" required>
                        <option value="">Select a client...</option>
                    </select>
                    <small class="text-muted">Select the client that would leave</small>
                </div>
            </div>
        </div>

        <!-- Info Card -->
        <div class="card bg-light">
            <div class="card-body">
                <h6><i class="bi bi-info-circle"></i> How it works</h6>
                <small class="text-muted">
                    This simulation shows how your capacity utilization changes if a specific client is lost.
                    Use this to understand freed capacity and plan for potential client departures.
                </small>
            </div>
        </div>
    </div>

    <!-- Results Panel -->
    <div class="col-md-8">
        <!-- Stats Cards -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card stat-card">
                    <div class="stat-value" id="avgUtilization">-</div>
                    <div class="stat-label">New Avg Utilization %</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stat-card success">
                    <div class="stat-value" id="freedCapacity">-</div>
                    <div class="stat-label">Freed Capacity %</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stat-card warning">
                    <div class="stat-value" id="lostDemand">-</div>
                    <div class="stat-label">Lost Demand</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stat-card danger">
                    <div class="stat-value" id="lostClientName">-</div>
                    <div class="stat-label">Lost Client</div>
                </div>
            </div>
        </div>

        <!-- Chart -->
        <div class="card">
            <div class="card-header">
                <i class="bi bi-graph-down"></i> Capacity Impact Analysis
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="simulationChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Data Table -->
        <div class="card mt-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="bi bi-table"></i> Weekly Breakdown</span>
                <div class="btn-group btn-group-sm" id="exportButtons" style="display: none;">
                    <button class="btn btn-outline-success" onclick="exportToCSV()" title="Export to CSV">
                        <i class="bi bi-filetype-csv"></i> CSV
                    </button>
                    <button class="btn btn-outline-primary" onclick="exportToExcel()" title="Export to Excel">
                        <i class="bi bi-file-earmark-excel"></i> Excel
                    </button>
                    <button class="btn btn-outline-secondary" onclick="exportChartAsImage()" title="Export Chart as Image">
                        <i class="bi bi-image"></i> Chart
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-sm" id="dataTable">
                        <thead>
                            <tr>
                                <th>Week</th>
                                <th>Original Demand</th>
                                <th>Lost Demand</th>
                                <th>New Demand</th>
                                <th>Capacity</th>
                                <th>New Utilization</th>
                                <th>Config Override</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="7" class="text-center text-muted">Run simulation to see data</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let simulationChart = null;
    let shiftConfigs = [];
    let allLines = [];
    let lastSimulationResult = null;  // Store for export

    document.addEventListener('DOMContentLoaded', async function() {
        const today = new Date();
        const sixMonthsLater = new Date(today);
        sixMonthsLater.setMonth(sixMonthsLater.getMonth() + 6);
        
        document.getElementById('startDate').value = today.toISOString().split('T')[0];
        document.getElementById('endDate').value = sixMonthsLater.toISOString().split('T')[0];

        await Promise.all([
            loadLines(),
            loadClients(),
            loadShiftConfigs()
        ]);

        document.getElementById('lineSelect').addEventListener('change', updateShiftConfigUI);
    });

    async function loadLines() {
        const data = await fetchAPI('lines/');
        allLines = data.results || data;
        const select = document.getElementById('lineSelect');
        select.innerHTML = allLines.map(line => 
            `<option value="${line.id}">${line.site_name} - ${line.name}</option>`
        ).join('');
    }

    async function loadClients() {
        const data = await fetchAPI('clients/');
        const clients = data.results || data;
        const select = document.getElementById('lostClientSelect');
        select.innerHTML = '<option value="">Select a client...</option>' + 
            clients.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
    }

    async function loadShiftConfigs() {
        const data = await fetchAPI('shift-configs/');
        shiftConfigs = data.results || data;
    }

    function updateShiftConfigUI() {
        const container = document.getElementById('shiftConfigContainer');
        const selectedOptions = Array.from(document.getElementById('lineSelect').selectedOptions);
        
        if (selectedOptions.length === 0) {
            container.innerHTML = '<small class="text-muted">Select lines first</small>';
            return;
        }

        container.innerHTML = selectedOptions.map(opt => {
            const line = allLines.find(l => l.id == opt.value);
            const hasOverrides = line && line.active_overrides_count > 0;
            return `
                <div class="mb-2">
                    <label class="form-label small">${line ? line.name : 'Line'} ${hasOverrides ? '<span class="badge bg-warning text-dark"><i class="bi bi-wrench"></i> Has Overrides</span>' : ''}</label>
                    <select class="form-select form-select-sm" data-line-id="${opt.value}">
                        <option value="override" ${hasOverrides ? 'selected' : ''}>ðŸ”§ Use Override Config (date-based)</option>
                        ${shiftConfigs.map(sc => `<option value="${sc.id}" ${!hasOverrides && line && line.default_shift_config == sc.id ? 'selected' : ''}>${sc.name}</option>`).join('')}
                    </select>
                </div>
            `;
        }).join('');
    }

    async function runSimulation() {
        const lostClientId = document.getElementById('lostClientSelect').value;
        if (!lostClientId) {
            alert('Please select a client to simulate losing');
            return;
        }

        const lineSelect = document.getElementById('lineSelect');
        const selectedLineIds = Array.from(lineSelect.selectedOptions).map(opt => parseInt(opt.value));
        
        if (selectedLineIds.length === 0) {
            alert('Please select at least one production line');
            return;
        }

        const shiftConfigSelects = document.querySelectorAll('#shiftConfigContainer select');
        const lineShiftConfigs = Array.from(shiftConfigSelects).map(select => ({
            line_id: parseInt(select.dataset.lineId),
            shift_config_id: select.value === 'override' ? null : parseInt(select.value),
            use_override: select.value === 'override'
        }));

        const requestData = {
            line_ids: selectedLineIds,
            shift_configs: lineShiftConfigs,
            start_date: document.getElementById('startDate').value,
            end_date: document.getElementById('endDate').value,
            lost_client_id: parseInt(lostClientId)
        };

        try {
            const result = await postAPI('/api/simulate/lost-client/', requestData);
            displayResults(result);
        } catch (error) {
            console.error('Simulation error:', error);
            alert('Error running simulation');
        }
    }

    function displayResults(result) {
        document.getElementById('avgUtilization').textContent = result.average_utilization + '%';
        document.getElementById('freedCapacity').textContent = (result.overlay_data?.freed_capacity_percent || 0) + '%';
        document.getElementById('lostDemand').textContent = parseFloat(result.overlay_data?.total_lost_demand || 0).toLocaleString();
        document.getElementById('lostClientName').textContent = result.overlay_data?.lost_client_name || '-';

        // Store results for export
        lastSimulationResult = result;
        document.getElementById('exportButtons').style.display = 'inline-flex';

        updateChart(result.data_points);
        updateTable(result.data_points);
    }

    function updateChart(dataPoints) {
        const ctx = document.getElementById('simulationChart').getContext('2d');
        
        if (simulationChart) simulationChart.destroy();

        // Point colors for capacity - highlight overrides
        const capacityPointColors = dataPoints.map(dp => 
            dp.has_override ? '#ffc107' : chartColors.success
        );
        const capacityPointRadius = dataPoints.map(dp => 
            dp.has_override ? 6 : 3
        );

        simulationChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: dataPoints.map(dp => dp.date),
                datasets: [
                    {
                        label: 'Original Demand',
                        data: dataPoints.map(dp => parseFloat(dp.base_demand || 0)),
                        borderColor: chartColors.primary,
                        backgroundColor: chartColors.primaryLight,
                        fill: true,
                        tension: 0.3
                    },
                    {
                        label: 'Demand After Loss',
                        data: dataPoints.map(dp => parseFloat(dp.demand)),
                        borderColor: chartColors.danger,
                        backgroundColor: chartColors.dangerLight,
                        fill: true,
                        tension: 0.3
                    },
                    {
                        label: 'Capacity',
                        data: dataPoints.map(dp => parseFloat(dp.capacity)),
                        borderColor: chartColors.success,
                        backgroundColor: 'transparent',
                        borderDash: [5, 5],
                        fill: false,
                        tension: 0,
                        pointBackgroundColor: capacityPointColors,
                        pointBorderColor: capacityPointColors,
                        pointRadius: capacityPointRadius,
                        pointHoverRadius: 8
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'top' },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        callbacks: {
                            afterBody: function(context) {
                                const dataIndex = context[0].dataIndex;
                                const dp = dataPoints[dataIndex];
                                if (dp.has_override) {
                                    return ['âš ï¸ Config override active for this week'];
                                }
                                return [];
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: { display: true, text: 'Units' }
                    }
                }
            }
        });
    }

    function updateTable(dataPoints) {
        const tbody = document.querySelector('#dataTable tbody');
        tbody.innerHTML = dataPoints.map(dp => `
            <tr>
                <td>${dp.date}</td>
                <td>${parseFloat(dp.base_demand || 0).toLocaleString()}</td>
                <td class="text-danger">-${parseFloat(dp.lost_demand || 0).toLocaleString()}</td>
                <td><strong>${parseFloat(dp.demand).toLocaleString()}</strong></td>
                <td>${parseFloat(dp.capacity).toLocaleString()}</td>
                <td>${dp.utilization_percent}%</td>
                <td>
                    ${dp.has_override 
                        ? '<span class="badge bg-warning text-dark" title="Custom configuration active"><i class="bi bi-wrench"></i></span>' 
                        : '<span class="text-muted">-</span>'}
                </td>
            </tr>
        `).join('');
    }
    
    // Export Functions
    function exportToCSV() {
        if (!lastSimulationResult) {
            alert('No simulation data to export. Run a simulation first.');
            return;
        }
        
        const dataPoints = lastSimulationResult.data_points;
        let csvContent = 'Week,Original Demand,Lost Demand,New Demand,Capacity,Utilization %,Has Override\n';
        
        dataPoints.forEach(dp => {
            csvContent += `${dp.date},${dp.base_demand || 0},${dp.lost_demand || 0},${dp.demand},${dp.capacity},${dp.utilization_percent},${dp.has_override ? 'Yes' : 'No'}\n`;
        });
        
        csvContent += '\nSummary\n';
        csvContent += `Average Utilization,${lastSimulationResult.average_utilization}%\n`;
        csvContent += `Peak Utilization,${lastSimulationResult.peak_utilization}%\n`;
        csvContent += `Freed Capacity,${lastSimulationResult.freed_capacity || 0}\n`;
        
        downloadFile(csvContent, 'lost_client_simulation_export.csv', 'text/csv');
    }
    
    function exportToExcel() {
        if (!lastSimulationResult) {
            alert('No simulation data to export. Run a simulation first.');
            return;
        }
        
        const dataPoints = lastSimulationResult.data_points;
        let html = '<html><head><meta charset="UTF-8"></head><body><table border="1">';
        html += '<tr style="background-color: #4a90d9; color: white;"><th>Week</th><th>Original Demand</th><th>Lost Demand</th><th>New Demand</th><th>Capacity</th><th>Utilization %</th><th>Has Override</th></tr>';
        
        dataPoints.forEach(dp => {
            html += `<tr><td>${dp.date}</td><td>${dp.base_demand || 0}</td><td style="color:red">-${dp.lost_demand || 0}</td><td><b>${dp.demand}</b></td><td>${dp.capacity}</td><td>${dp.utilization_percent}%</td><td>${dp.has_override ? 'Yes' : 'No'}</td></tr>`;
        });
        
        html += '<tr><td colspan="7"></td></tr>';
        html += '<tr style="background-color: #e9ecef;"><td colspan="7"><b>Summary</b></td></tr>';
        html += `<tr><td>Average Utilization</td><td colspan="6">${lastSimulationResult.average_utilization}%</td></tr>`;
        html += `<tr><td>Peak Utilization</td><td colspan="6">${lastSimulationResult.peak_utilization}%</td></tr>`;
        html += `<tr><td>Freed Capacity</td><td colspan="6">${lastSimulationResult.freed_capacity || 0}</td></tr>`;
        html += '</table></body></html>';
        
        downloadFile(html, 'lost_client_simulation_export.xls', 'application/vnd.ms-excel');
    }
    
    function exportChartAsImage() {
        if (!simulationChart) {
            alert('No chart to export. Run a simulation first.');
            return;
        }
        
        // Create a temporary canvas with white background
        const canvas = document.getElementById('simulationChart');
        const tempCanvas = document.createElement('canvas');
        tempCanvas.width = canvas.width;
        tempCanvas.height = canvas.height;
        const tempCtx = tempCanvas.getContext('2d');
        
        // Fill white background
        tempCtx.fillStyle = '#ffffff';
        tempCtx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);
        
        // Draw the chart on top
        tempCtx.drawImage(canvas, 0, 0);
        
        const link = document.createElement('a');
        link.download = 'lost_client_simulation_chart.jpg';
        link.href = tempCanvas.toDataURL('image/jpeg', 1);
        link.click();
    }
    
    function downloadFile(content, filename, mimeType) {
        const blob = new Blob([content], { type: mimeType + ';charset=utf-8;' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = filename;
        link.click();
    }
</script>
{% endblock %}
