{% extends 'base.html' %}

{% block title %}Lab Simulation - Cerelia Simulation{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="bi bi-flask"></i> Lab Simulation</h2>
    <span class="badge bg-info">Combines Real + Lab Data</span>
</div>

<div class="row">
    <!-- Configuration Panel -->
    <div class="col-md-4">
        <div class="card mb-3">
            <div class="card-header">
                <i class="bi bi-gear"></i> Simulation Configuration
            </div>
            <div class="card-body">
                <!-- Date Range -->
                <div class="row mb-3">
                    <div class="col-6">
                        <label for="startDate" class="form-label">Start Date</label>
                        <input type="date" class="form-control" id="startDate">
                    </div>
                    <div class="col-6">
                        <label for="endDate" class="form-label">End Date</label>
                        <input type="date" class="form-control" id="endDate">
                    </div>
                </div>
                
                <!-- Real Lines Selection -->
                <div class="mb-3">
                    <label class="form-label">
                        <i class="bi bi-building"></i> Real Production Lines
                    </label>
                    <div id="realLinesContainer" class="border rounded p-2" style="max-height: 150px; overflow-y: auto;">
                        <div class="text-muted small">Loading...</div>
                    </div>
                </div>
                
                <!-- Lab Lines Selection -->
                <div class="mb-3">
                    <label class="form-label">
                        <i class="bi bi-diagram-3"></i> Lab Lines
                        <span class="badge bg-info">Fictive</span>
                    </label>
                    <div id="labLinesContainer" class="border rounded p-2" style="max-height: 150px; overflow-y: auto;">
                        <div class="text-muted small">Loading...</div>
                    </div>
                </div>
                
                <!-- Include Lab Forecasts -->
                <div class="mb-3">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="includeLabForecasts" checked>
                        <label class="form-check-label" for="includeLabForecasts">
                            Include Lab Forecasts in Demand
                        </label>
                    </div>
                </div>
                
                <button class="btn btn-primary w-100" id="runSimulation">
                    <i class="bi bi-play-fill"></i> Run Lab Simulation
                </button>
            </div>
        </div>
        
        <!-- Summary Stats -->
        <div class="card">
            <div class="card-header">
                <i class="bi bi-bar-chart"></i> Summary
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-6 mb-2">
                        <div class="stat-card p-2 rounded border">
                            <div class="stat-value" id="avgUtilization">-</div>
                            <div class="stat-label small">Avg Utilization</div>
                        </div>
                    </div>
                    <div class="col-6 mb-2">
                        <div class="stat-card p-2 rounded border">
                            <div class="stat-value" id="peakUtilization">-</div>
                            <div class="stat-label small">Peak Utilization</div>
                        </div>
                    </div>
                    <div class="col-6 mb-2">
                        <div class="stat-card p-2 rounded border">
                            <div class="stat-value" id="overCapacityWeeks">-</div>
                            <div class="stat-label small">Over Capacity</div>
                        </div>
                    </div>
                    <div class="col-6 mb-2">
                        <div class="stat-card p-2 rounded border">
                            <div class="stat-value" id="totalCapacity">-</div>
                            <div class="stat-label small">Total Capacity</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Chart & Results -->
    <div class="col-md-8">
        <div class="card mb-3">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="bi bi-graph-up"></i> Demand vs Capacity</span>
                <div>
                    <span class="badge bg-primary me-1">
                        <i class="bi bi-circle-fill"></i> Capacity
                    </span>
                    <span class="badge bg-warning me-1">
                        <i class="bi bi-circle-fill"></i> Real Demand
                    </span>
                    <span class="badge bg-info">
                        <i class="bi bi-circle-fill"></i> Lab Demand
                    </span>
                </div>
            </div>
            <div class="card-body">
                <canvas id="simulationChart" height="300"></canvas>
                <div id="noSimulation" class="text-center text-muted py-5">
                    <i class="bi bi-graph-up" style="font-size: 3rem;"></i>
                    <p class="mt-2">Configure and run simulation to see results</p>
                </div>
            </div>
        </div>
        
        <!-- Weekly Table -->
        <div class="card">
            <div class="card-header">
                <i class="bi bi-table"></i> Weekly Breakdown
            </div>
            <div class="card-body">
                <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                    <table class="table table-hover table-sm" id="weeklyTable">
                        <thead class="sticky-top bg-white">
                            <tr>
                                <th>Week</th>
                                <th>Real Demand</th>
                                <th>Lab Demand</th>
                                <th>Total Demand</th>
                                <th>Capacity</th>
                                <th>Utilization</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Dynamic content -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const API_LINES = '/api/lines/';
const API_LAB_LINES = '/api/lab/lines/';
const API_LAB_SIMULATE = '/api/simulate/lab/';

// CSRF Token - get it once at script load
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

const csrftoken = getCookie('csrftoken');

let simulationChart = null;
let realLines = [];
let labLines = [];

document.addEventListener('DOMContentLoaded', function() {
    // Set default dates
    const today = new Date();
    const futureDate = new Date(today);
    futureDate.setMonth(futureDate.getMonth() + 6);
    
    document.getElementById('startDate').value = today.toISOString().split('T')[0];
    document.getElementById('endDate').value = futureDate.toISOString().split('T')[0];
    
    loadLines();
    
    document.getElementById('runSimulation').addEventListener('click', runSimulation);
});

async function loadLines() {
    try {
        // Load real lines
        const realResponse = await fetch(API_LINES);
        const realData = await realResponse.json();
        realLines = realData.results || realData;
        
        const realContainer = document.getElementById('realLinesContainer');
        if (realLines.length === 0) {
            realContainer.innerHTML = '<div class="text-muted small">No production lines found</div>';
        } else {
            realContainer.innerHTML = realLines.map(line => `
                <div class="form-check">
                    <input class="form-check-input real-line-check" type="checkbox" 
                           value="${line.id}" id="realLine${line.id}">
                    <label class="form-check-label small" for="realLine${line.id}">
                        ${line.code} - ${line.name}
                    </label>
                </div>
            `).join('');
        }
        
        // Load lab lines
        const labResponse = await fetch(API_LAB_LINES);
        const labData = await labResponse.json();
        labLines = labData.results || labData;
        
        const labContainer = document.getElementById('labLinesContainer');
        if (labLines.length === 0) {
            labContainer.innerHTML = '<div class="text-muted small">No lab lines created yet. <a href="/lab/line/">Create one</a></div>';
        } else {
            labContainer.innerHTML = labLines.map(line => `
                <div class="form-check">
                    <input class="form-check-input lab-line-check" type="checkbox" 
                           value="${line.id}" id="labLine${line.id}">
                    <label class="form-check-label small" for="labLine${line.id}">
                        <span class="badge bg-info">LAB</span> ${line.code} - ${line.name}
                    </label>
                </div>
            `).join('');
        }
    } catch (error) {
        console.error('Error loading lines:', error);
    }
}

async function runSimulation() {
    const startDate = document.getElementById('startDate').value;
    const endDate = document.getElementById('endDate').value;
    
    const selectedRealLines = Array.from(document.querySelectorAll('.real-line-check:checked'))
        .map(cb => parseInt(cb.value));
    const selectedLabLines = Array.from(document.querySelectorAll('.lab-line-check:checked'))
        .map(cb => parseInt(cb.value));
    
    if (selectedRealLines.length === 0 && selectedLabLines.length === 0) {
        alert('Please select at least one production line (real or lab)');
        return;
    }
    
    const includeLabForecasts = document.getElementById('includeLabForecasts').checked;
    
    try {
        document.getElementById('runSimulation').disabled = true;
        document.getElementById('runSimulation').innerHTML = '<i class="bi bi-hourglass-split"></i> Running...';
        
        const response = await fetch(API_LAB_SIMULATE, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            },
            body: JSON.stringify({
                line_ids: selectedRealLines,
                lab_line_ids: selectedLabLines,
                start_date: startDate,
                end_date: endDate,
                include_lab_forecasts: includeLabForecasts
            })
        });
        
        if (response.ok) {
            const result = await response.json();
            displayResults(result);
        } else {
            const error = await response.json();
            alert('Error: ' + JSON.stringify(error));
        }
    } catch (error) {
        console.error('Error running simulation:', error);
        alert('Error running simulation');
    } finally {
        document.getElementById('runSimulation').disabled = false;
        document.getElementById('runSimulation').innerHTML = '<i class="bi bi-play-fill"></i> Run Lab Simulation';
    }
}

function displayResults(result) {
    document.getElementById('noSimulation').style.display = 'none';
    
    // Update summary stats
    document.getElementById('avgUtilization').textContent = result.average_utilization + '%';
    document.getElementById('peakUtilization').textContent = result.peak_utilization + '%';
    document.getElementById('overCapacityWeeks').textContent = result.over_capacity_periods + ' weeks';
    document.getElementById('totalCapacity').textContent = 
        parseFloat(result.total_capacity).toLocaleString('en-US', {maximumFractionDigits: 0});
    
    // Color coding for utilization
    const avgUtil = parseFloat(result.average_utilization);
    const avgEl = document.getElementById('avgUtilization');
    avgEl.style.color = avgUtil > 100 ? '#dc3545' : avgUtil > 85 ? '#fd7e14' : '#198754';
    
    // Update chart
    updateChart(result.data_points);
    
    // Update table
    updateTable(result.data_points);
}

function updateChart(dataPoints) {
    const ctx = document.getElementById('simulationChart').getContext('2d');
    
    if (simulationChart) {
        simulationChart.destroy();
    }
    
    const labels = dataPoints.map(dp => dp.date);
    const capacityData = dataPoints.map(dp => parseFloat(dp.capacity));
    const realDemandData = dataPoints.map(dp => parseFloat(dp.real_demand || 0));
    const labDemandData = dataPoints.map(dp => parseFloat(dp.lab_demand || 0));
    const totalDemandData = dataPoints.map(dp => parseFloat(dp.demand));
    
    simulationChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [
                {
                    label: 'Capacity',
                    data: capacityData,
                    borderColor: '#0d6efd',
                    backgroundColor: 'rgba(13, 110, 253, 0.1)',
                    fill: true,
                    tension: 0.1
                },
                {
                    label: 'Total Demand',
                    data: totalDemandData,
                    borderColor: '#dc3545',
                    backgroundColor: 'rgba(220, 53, 69, 0.1)',
                    borderWidth: 3,
                    fill: false,
                    tension: 0.1
                },
                {
                    label: 'Real Demand',
                    data: realDemandData,
                    borderColor: '#ffc107',
                    backgroundColor: 'transparent',
                    borderDash: [5, 5],
                    fill: false,
                    tension: 0.1
                },
                {
                    label: 'Lab Demand',
                    data: labDemandData,
                    borderColor: '#0dcaf0',
                    backgroundColor: 'transparent',
                    borderDash: [5, 5],
                    fill: false,
                    tension: 0.1
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                intersect: false,
                mode: 'index'
            },
            plugins: {
                legend: {
                    position: 'top'
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return context.dataset.label + ': ' + 
                                   context.parsed.y.toLocaleString('en-US', {maximumFractionDigits: 0});
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return value.toLocaleString('en-US', {maximumFractionDigits: 0});
                        }
                    }
                }
            }
        }
    });
}

function updateTable(dataPoints) {
    const tbody = document.querySelector('#weeklyTable tbody');
    
    tbody.innerHTML = dataPoints.map(dp => {
        const utilization = parseFloat(dp.utilization_percent);
        const statusClass = utilization > 100 ? 'danger' : utilization > 85 ? 'warning' : 'success';
        const statusText = utilization > 100 ? 'Over' : utilization > 85 ? 'High' : 'OK';
        
        return `
            <tr>
                <td>${dp.date}</td>
                <td>${parseFloat(dp.real_demand || 0).toLocaleString('en-US', {maximumFractionDigits: 0})}</td>
                <td class="text-info">${parseFloat(dp.lab_demand || 0).toLocaleString('en-US', {maximumFractionDigits: 0})}</td>
                <td><strong>${parseFloat(dp.demand).toLocaleString('en-US', {maximumFractionDigits: 0})}</strong></td>
                <td>${parseFloat(dp.capacity).toLocaleString('en-US', {maximumFractionDigits: 0})}</td>
                <td class="text-${statusClass}">${utilization}%</td>
                <td><span class="badge bg-${statusClass}">${statusText}</span></td>
            </tr>
        `;
    }).join('');
}
</script>

<style>
.stat-card .stat-value {
    font-size: 1.2rem;
    font-weight: 700;
}
</style>
{% endblock %}
