{% extends 'base.html' %}

{% block title %}Line Simulation - Cerelia{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="bi bi-bar-chart-line"></i> Line Simulation</h2>
    <button class="btn btn-primary" onclick="runSimulation()">
        <i class="bi bi-play-fill"></i> Run Simulation
    </button>
</div>

<div class="row">
    <!-- Configuration Panel -->
    <div class="col-md-4">
        <div class="card mb-4">
            <div class="card-header">
                <i class="bi bi-sliders"></i> Configuration
            </div>
            <div class="card-body">
                <!-- Date Range -->
                <div class="mb-3">
                    <label class="form-label">Date Range</label>
                    <div class="row">
                        <div class="col-6">
                            <input type="date" class="form-control" id="startDate">
                        </div>
                        <div class="col-6">
                            <input type="date" class="form-control" id="endDate">
                        </div>
                    </div>
                </div>

                <!-- Line Selection -->
                <div class="mb-3">
                    <label class="form-label">Production Lines</label>
                    <select class="form-select" id="lineSelect" multiple size="6">
                    </select>
                    <small class="text-muted">Hold Ctrl to select multiple lines</small>
                </div>

                <!-- Shift Configuration per Line -->
                <div class="mb-3">
                    <label class="form-label">Shift Configurations</label>
                    <div id="shiftConfigContainer">
                        <small class="text-muted">Select lines first</small>
                    </div>
                </div>

                <hr>

                <!-- Optional Filters -->
                <h6><i class="bi bi-funnel"></i> Optional Filters</h6>
                
                <div class="mb-3">
                    <label class="form-label">Filter by Client (code)</label>
                    <input type="text" class="form-control" id="clientFilter" list="clientDatalist" placeholder="Enter client code">
                    <datalist id="clientDatalist">
                    </datalist>
                </div>

                <div class="mb-3">
                    <label class="form-label">Filter by Category</label>
                    <select class="form-select" id="categoryFilter">
                        <option value="">All Categories</option>
                    </select>
                </div>

                <div class="mb-3">
                    <label class="form-label">Filter by Product</label>
                    <select class="form-select" id="productFilter">
                        <option value="">All Products</option>
                    </select>
                </div>

                <hr>

                <!-- Client Demand Overlays -->
                <h6><i class="bi bi-layers"></i> Client Demand Overlays</h6>
                <small class="text-muted d-block mb-2">Add client codes to overlay their demand curves</small>
                
                <div class="mb-3">
                    <div class="input-group">
                        <input type="text" class="form-control" id="clientCodeInput" placeholder="Enter client code">
                        <button class="btn btn-outline-secondary" type="button" onclick="addClientOverlay()">
                            <i class="bi bi-plus"></i>
                        </button>
                    </div>
                </div>
                
                <div id="overlayClientsList" class="mb-3">
                    <!-- Client overlay tags will appear here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Results Panel -->
    <div class="col-md-8">
        <!-- Stats Cards -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card stat-card">
                    <div class="stat-value" id="avgUtilization">-</div>
                    <div class="stat-label">Avg Utilization %</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stat-card warning">
                    <div class="stat-value" id="peakUtilization">-</div>
                    <div class="stat-label">Peak Utilization %</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stat-card danger">
                    <div class="stat-value" id="overCapacityPeriods">-</div>
                    <div class="stat-label">Over-Capacity Weeks</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stat-card success">
                    <div class="stat-value" id="totalCapacity">-</div>
                    <div class="stat-label">Total Capacity</div>
                </div>
            </div>
        </div>

        <!-- Chart -->
        <div class="card">
            <div class="card-header">
                <i class="bi bi-graph-up"></i> Demand vs Capacity
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="simulationChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Data Table -->
        <div class="card mt-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="bi bi-table"></i> Weekly Data</span>
                <div>
                    <small class="text-muted me-3"><i class="bi bi-gear text-warning"></i> = Config Override Active</small>
                    <div class="btn-group btn-group-sm" id="exportButtons" style="display: none;">
                        <button class="btn btn-outline-success" onclick="exportToCSV()" title="Export to CSV">
                            <i class="bi bi-filetype-csv"></i> CSV
                        </button>
                        <button class="btn btn-outline-primary" onclick="exportToExcel()" title="Export to Excel">
                            <i class="bi bi-file-earmark-excel"></i> Excel
                        </button>
                        <button class="btn btn-outline-secondary" onclick="exportChartAsImage()" title="Export Chart as Image">
                            <i class="bi bi-image"></i> Chart
                        </button>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-sm" id="dataTable">
                        <thead>
                            <tr>
                                <th>Week</th>
                                <th>Demand</th>
                                <th>Capacity</th>
                                <th>Utilization</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="5" class="text-center text-muted">Run simulation to see data</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let simulationChart = null;
    let shiftConfigs = [];
    let allLines = [];
    let overlayClients = [];  // Store client codes for overlay
    let lastSimulationResult = null;  // Store for export
    let lastClientOverlays = {};  // Store for export
    
    // Colors for overlay curves
    const overlayColors = [
        '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', 
        '#FF9F40', '#7CB9E8', '#F0E68C', '#DDA0DD', '#98FB98'
    ];

    // Initialize
    document.addEventListener('DOMContentLoaded', async function() {
        // Set default dates (next 6 months)
        const today = new Date();
        const sixMonthsLater = new Date(today);
        sixMonthsLater.setMonth(sixMonthsLater.getMonth() + 6);
        
        document.getElementById('startDate').value = today.toISOString().split('T')[0];
        document.getElementById('endDate').value = sixMonthsLater.toISOString().split('T')[0];

        // Load data
        await Promise.all([
            loadLines(),
            loadClients(),
            loadCategories(),
            loadShiftConfigs()
        ]);

        // Setup event listeners
        document.getElementById('lineSelect').addEventListener('change', updateShiftConfigUI);
        document.getElementById('categoryFilter').addEventListener('change', loadProductsByCategory);
        
        // Handle Enter key for client code input
        document.getElementById('clientCodeInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                addClientOverlay();
            }
        });
    });

    async function loadLines() {
        const data = await fetchAPI('lines/');
        allLines = data.results || data;
        const select = document.getElementById('lineSelect');
        select.innerHTML = allLines.map(line => 
            `<option value="${line.id}">${line.site_name} - ${line.name}</option>`
        ).join('');
    }

    let allClients = [];  // Store clients for lookup
    
    async function loadClients() {
        const data = await fetchAPI('clients/');
        allClients = data.results || data;
        const datalist = document.getElementById('clientDatalist');
        datalist.innerHTML = allClients.map(c => `<option value="${c.code}">${c.code} - ${c.name}</option>`).join('');
    }
    
    function getClientIdByCode(code) {
        if (!code) return null;
        const client = allClients.find(c => c.code.toUpperCase() === code.toUpperCase());
        return client ? client.id : null;
    }

    async function loadCategories() {
        const data = await fetchAPI('categories/');
        const categories = data.results || data;
        const select = document.getElementById('categoryFilter');
        select.innerHTML = '<option value="">All Categories</option>' + 
            categories.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
    }

    async function loadShiftConfigs() {
        const data = await fetchAPI('shift-configs/');
        shiftConfigs = data.results || data;
    }

    async function loadProductsByCategory() {
        const categoryId = document.getElementById('categoryFilter').value;
        const select = document.getElementById('productFilter');
        
        if (!categoryId) {
            select.innerHTML = '<option value="">All Products</option>';
            return;
        }

        const data = await fetchAPI(`products/by_category/?category_id=${categoryId}`);
        const products = data.results || data;
        select.innerHTML = '<option value="">All Products in Category</option>' + 
            products.map(p => `<option value="${p.id}">${p.code} - ${p.name}</option>`).join('');
    }

    function updateShiftConfigUI() {
        const container = document.getElementById('shiftConfigContainer');
        const selectedOptions = Array.from(document.getElementById('lineSelect').selectedOptions);
        
        if (selectedOptions.length === 0) {
            container.innerHTML = '<small class="text-muted">Select lines first</small>';
            return;
        }

        container.innerHTML = selectedOptions.map(opt => {
            const line = allLines.find(l => l.id == opt.value);
            const hasOverrides = line && line.active_overrides_count > 0;
            return `
                <div class="mb-2">
                    <label class="form-label small">${line ? line.name : 'Line'} ${hasOverrides ? '<span class="badge bg-warning text-dark"><i class="bi bi-wrench"></i> Has Overrides</span>' : ''}</label>
                    <select class="form-select form-select-sm" data-line-id="${opt.value}">
                        <option value="override" ${hasOverrides ? 'selected' : ''}>ðŸ”§ Use Override Config (date-based)</option>
                        ${shiftConfigs.map(sc => `<option value="${sc.id}" ${!hasOverrides && line && line.default_shift_config == sc.id ? 'selected' : ''}>${sc.name}</option>`).join('')}
                    </select>
                </div>
            `;
        }).join('');
    }

    async function runSimulation() {
        const lineSelect = document.getElementById('lineSelect');
        const selectedLineIds = Array.from(lineSelect.selectedOptions).map(opt => parseInt(opt.value));
        
        if (selectedLineIds.length === 0) {
            alert('Please select at least one production line');
            return;
        }

        // Get shift configs for each line
        const shiftConfigSelects = document.querySelectorAll('#shiftConfigContainer select');
        const lineShiftConfigs = Array.from(shiftConfigSelects).map(select => ({
            line_id: parseInt(select.dataset.lineId),
            shift_config_id: select.value === 'override' ? null : parseInt(select.value),
            use_override: select.value === 'override'
        }));

        // Get client ID from code
        const clientCode = document.getElementById('clientFilter').value.trim();
        const clientId = getClientIdByCode(clientCode);

        const requestData = {
            line_ids: selectedLineIds,
            shift_configs: lineShiftConfigs,
            start_date: document.getElementById('startDate').value,
            end_date: document.getElementById('endDate').value,
            client_id: clientId,
            category_id: document.getElementById('categoryFilter').value || null,
            product_id: document.getElementById('productFilter').value || null,
            overlay_client_codes: overlayClients.map(c => c.code)
        };

        try {
            const result = await postAPI('/api/simulate/line/', requestData);
            displayResults(result);
        } catch (error) {
            console.error('Simulation error:', error);
            alert('Error running simulation');
        }
    }

    // Client overlay management functions
    async function addClientOverlay() {
        const input = document.getElementById('clientCodeInput');
        const code = input.value.trim().toUpperCase();
        
        if (!code) {
            return;
        }
        
        // Check if already added
        if (overlayClients.some(c => c.code === code)) {
            alert('Client code already added');
            input.value = '';
            return;
        }
        
        // Verify client exists
        try {
            const data = await fetchAPI(`clients/?code=${code}`);
            const clients = data.results || data;
            const client = clients.find(c => c.code.toUpperCase() === code);
            
            if (!client) {
                alert(`Client with code "${code}" not found`);
                return;
            }
            
            // Add to overlay list with color
            const colorIndex = overlayClients.length % overlayColors.length;
            overlayClients.push({
                code: client.code,
                name: client.name,
                id: client.id,
                color: overlayColors[colorIndex]
            });
            
            input.value = '';
            updateOverlayClientsList();
            
        } catch (error) {
            console.error('Error verifying client:', error);
            alert('Error verifying client code');
        }
    }
    
    function removeClientOverlay(code) {
        overlayClients = overlayClients.filter(c => c.code !== code);
        updateOverlayClientsList();
    }
    
    function updateOverlayClientsList() {
        const container = document.getElementById('overlayClientsList');
        
        if (overlayClients.length === 0) {
            container.innerHTML = '';
            return;
        }
        
        container.innerHTML = overlayClients.map(client => `
            <span class="badge me-1 mb-1" style="background-color: ${client.color}; cursor: pointer;" 
                  onclick="removeClientOverlay('${client.code}')" title="Click to remove">
                ${client.code} - ${client.name} <i class="bi bi-x"></i>
            </span>
        `).join('');
    }

    function displayResults(result) {
        // Store results for export
        lastSimulationResult = result;
        lastClientOverlays = result.client_overlays || {};
        
        // Show export buttons
        document.getElementById('exportButtons').style.display = 'inline-flex';
        
        // Update stats
        document.getElementById('avgUtilization').textContent = result.average_utilization + '%';
        document.getElementById('peakUtilization').textContent = result.peak_utilization + '%';
        document.getElementById('overCapacityPeriods').textContent = result.over_capacity_periods;
        document.getElementById('totalCapacity').textContent = formatNumber(result.total_capacity);

        // Update chart with overlay data
        updateChart(result.data_points, result.client_overlays || {});

        // Update table
        updateTable(result.data_points, result.client_overlays || {});
    }

    function updateChart(dataPoints, clientOverlays) {
        const ctx = document.getElementById('simulationChart').getContext('2d');
        
        if (simulationChart) {
            simulationChart.destroy();
        }

        const labels = dataPoints.map(dp => dp.date);
        const demandData = dataPoints.map(dp => parseFloat(dp.demand));
        const capacityData = dataPoints.map(dp => parseFloat(dp.capacity));
        
        // Point colors for capacity - highlight overrides
        const capacityPointColors = dataPoints.map(dp => 
            dp.has_override ? '#ffc107' : chartColors.primary
        );
        const capacityPointRadius = dataPoints.map(dp => 
            dp.has_override ? 6 : 3
        );
        
        // Build datasets array
        const datasets = [
            {
                label: 'Total Demand',
                data: demandData,
                borderColor: chartColors.accent,
                backgroundColor: chartColors.accentLight,
                fill: true,
                tension: 0.3,
                order: 2
            },
            {
                label: 'Capacity',
                data: capacityData,
                borderColor: chartColors.primary,
                backgroundColor: chartColors.primaryLight,
                borderDash: [5, 5],
                fill: false,
                tension: 0,
                pointBackgroundColor: capacityPointColors,
                pointBorderColor: capacityPointColors,
                pointRadius: capacityPointRadius,
                pointHoverRadius: 8,
                order: 1
            }
        ];
        
        // Add overlay datasets for each client
        Object.entries(clientOverlays).forEach(([clientCode, overlayData], index) => {
            const overlayClient = overlayClients.find(c => c.code === clientCode);
            const color = overlayClient ? overlayClient.color : overlayColors[index % overlayColors.length];
            
            // Map overlay demand data to match dataPoints labels
            const overlayDemandData = dataPoints.map(dp => {
                const overlayPoint = overlayData.data_points.find(op => op.date === dp.date);
                return overlayPoint ? parseFloat(overlayPoint.demand) : 0;
            });
            
            datasets.push({
                label: `${clientCode} (${overlayData.client_name})`,
                data: overlayDemandData,
                borderColor: color,
                backgroundColor: color + '40',  // Add transparency
                fill: false,
                tension: 0.3,
                borderWidth: 2,
                pointRadius: 4,
                order: 3 + index
            });
        });

        simulationChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: datasets
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        callbacks: {
                            afterBody: function(context) {
                                const dataIndex = context[0].dataIndex;
                                const dp = dataPoints[dataIndex];
                                if (dp.has_override) {
                                    return ['âš ï¸ Config override active for this week'];
                                }
                                return [];
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Units'
                        }
                    }
                }
            }
        });
    }

    function updateTable(dataPoints, clientOverlays) {
        const tbody = document.querySelector('#dataTable tbody');
        
        // Build dynamic header for overlay columns
        const overlayHeaders = Object.entries(clientOverlays).map(([code, data]) => 
            `<th>${code}</th>`
        ).join('');
        
        const thead = document.querySelector('#dataTable thead tr');
        thead.innerHTML = `
            <th>Week</th>
            <th>Total Demand</th>
            ${overlayHeaders}
            <th>Capacity</th>
            <th>Utilization</th>
            <th>Status</th>
        `;
        
        tbody.innerHTML = dataPoints.map(dp => {
            // Get overlay values for this data point
            const overlayValues = Object.entries(clientOverlays).map(([code, data]) => {
                const overlayPoint = data.data_points.find(op => op.date === dp.date);
                const value = overlayPoint ? overlayPoint.demand : 0;
                return `<td>${formatNumber(value)}</td>`;
            }).join('');
            
            return `
                <tr class="${dp.over_capacity ? 'table-danger' : ''} ${dp.has_override ? 'table-warning' : ''}">
                    <td>
                        ${dp.date}
                        ${dp.has_override ? '<i class="bi bi-gear text-warning ms-1" title="Config override active"></i>' : ''}
                    </td>
                    <td>${formatNumber(dp.demand)}</td>
                    ${overlayValues}
                    <td>${formatNumber(dp.capacity)}</td>
                    <td>${dp.utilization_percent}%</td>
                    <td>
                        ${dp.over_capacity 
                            ? '<span class="badge bg-danger">Over Capacity</span>' 
                            : '<span class="badge bg-success">OK</span>'}
                    </td>
                </tr>
            `;
        }).join('');
    }

    function formatNumber(num) {
        return parseFloat(num).toLocaleString('en-US', { maximumFractionDigits: 0 });
    }
    
    // Export Functions
    function exportToCSV() {
        if (!lastSimulationResult) {
            alert('No simulation data to export. Run a simulation first.');
            return;
        }
        
        const dataPoints = lastSimulationResult.data_points;
        const overlays = lastClientOverlays;
        
        // Build CSV headers
        let headers = ['Week', 'Total Demand'];
        Object.keys(overlays).forEach(code => {
            headers.push(code);
        });
        headers.push('Capacity', 'Utilization %', 'Status', 'Has Override');
        
        // Build CSV rows
        let csvContent = headers.join(',') + '\n';
        
        dataPoints.forEach(dp => {
            let row = [
                dp.date,
                dp.demand
            ];
            
            // Add overlay values
            Object.entries(overlays).forEach(([code, data]) => {
                const overlayPoint = data.data_points.find(op => op.date === dp.date);
                row.push(overlayPoint ? overlayPoint.demand : 0);
            });
            
            row.push(
                dp.capacity,
                dp.utilization_percent,
                dp.over_capacity ? 'Over Capacity' : 'OK',
                dp.has_override ? 'Yes' : 'No'
            );
            
            csvContent += row.join(',') + '\n';
        });
        
        // Add summary row
        csvContent += '\n';
        csvContent += `Summary\n`;
        csvContent += `Average Utilization,${lastSimulationResult.average_utilization}%\n`;
        csvContent += `Peak Utilization,${lastSimulationResult.peak_utilization}%\n`;
        csvContent += `Over-Capacity Weeks,${lastSimulationResult.over_capacity_periods}\n`;
        csvContent += `Total Capacity,${lastSimulationResult.total_capacity}\n`;
        csvContent += `Total Demand,${lastSimulationResult.total_demand}\n`;
        
        // Download
        downloadFile(csvContent, 'line_simulation_export.csv', 'text/csv');
    }
    
    function exportToExcel() {
        if (!lastSimulationResult) {
            alert('No simulation data to export. Run a simulation first.');
            return;
        }
        
        const dataPoints = lastSimulationResult.data_points;
        const overlays = lastClientOverlays;
        
        // Build HTML table for Excel
        let html = '<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel">';
        html += '<head><meta charset="UTF-8"></head><body>';
        html += '<table border="1">';
        
        // Headers
        html += '<tr style="background-color: #4a90d9; color: white; font-weight: bold;">';
        html += '<th>Week</th><th>Total Demand</th>';
        Object.keys(overlays).forEach(code => {
            html += `<th>${code}</th>`;
        });
        html += '<th>Capacity</th><th>Utilization %</th><th>Status</th><th>Has Override</th>';
        html += '</tr>';
        
        // Data rows
        dataPoints.forEach(dp => {
            const rowStyle = dp.over_capacity ? 'background-color: #f8d7da;' : (dp.has_override ? 'background-color: #fff3cd;' : '');
            html += `<tr style="${rowStyle}">`;
            html += `<td>${dp.date}</td>`;
            html += `<td>${dp.demand}</td>`;
            
            Object.entries(overlays).forEach(([code, data]) => {
                const overlayPoint = data.data_points.find(op => op.date === dp.date);
                html += `<td>${overlayPoint ? overlayPoint.demand : 0}</td>`;
            });
            
            html += `<td>${dp.capacity}</td>`;
            html += `<td>${dp.utilization_percent}%</td>`;
            html += `<td>${dp.over_capacity ? 'Over Capacity' : 'OK'}</td>`;
            html += `<td>${dp.has_override ? 'Yes' : 'No'}</td>`;
            html += '</tr>';
        });
        
        // Summary section
        html += '<tr><td colspan="8"></td></tr>';
        html += '<tr style="background-color: #e9ecef; font-weight: bold;"><td colspan="8">Summary</td></tr>';
        html += `<tr><td>Average Utilization</td><td colspan="7">${lastSimulationResult.average_utilization}%</td></tr>`;
        html += `<tr><td>Peak Utilization</td><td colspan="7">${lastSimulationResult.peak_utilization}%</td></tr>`;
        html += `<tr><td>Over-Capacity Weeks</td><td colspan="7">${lastSimulationResult.over_capacity_periods}</td></tr>`;
        html += `<tr><td>Total Capacity</td><td colspan="7">${lastSimulationResult.total_capacity}</td></tr>`;
        html += `<tr><td>Total Demand</td><td colspan="7">${lastSimulationResult.total_demand}</td></tr>`;
        
        html += '</table></body></html>';
        
        // Download as Excel
        downloadFile(html, 'line_simulation_export.xls', 'application/vnd.ms-excel');
    }
    
    function exportChartAsImage() {
        if (!simulationChart) {
            alert('No chart to export. Run a simulation first.');
            return;
        }
        
        // Create a temporary canvas with white background
        const canvas = document.getElementById('simulationChart');
        const tempCanvas = document.createElement('canvas');
        tempCanvas.width = canvas.width;
        tempCanvas.height = canvas.height;
        const tempCtx = tempCanvas.getContext('2d');
        
        // Fill white background
        tempCtx.fillStyle = '#ffffff';
        tempCtx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);
        
        // Draw the chart on top
        tempCtx.drawImage(canvas, 0, 0);
        
        const link = document.createElement('a');
        link.download = 'line_simulation_chart.jpg';
        link.href = tempCanvas.toDataURL('image/jpeg', 1);
        link.click();
    }
    
    function downloadFile(content, filename, mimeType) {
        const blob = new Blob([content], { type: mimeType + ';charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        
        link.setAttribute('href', url);
        link.setAttribute('download', filename);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
</script>
{% endblock %}
