{% extends 'base.html' %}

{% block title %}Category Simulation - Cerelia{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="bi bi-grid-3x3-gap"></i> Category Simulation</h2>
    <button class="btn btn-success" onclick="runSimulation()">
        <i class="bi bi-play-fill"></i> Run Simulation
    </button>
</div>

<div class="row">
    <!-- Configuration Panel -->
    <div class="col-md-4">
        <div class="card mb-4" style="max-height: 85vh; min-height: 500px; display: flex; flex-direction: column;">
            <div class="card-header">
                <i class="bi bi-sliders"></i> <span style="color: #ea6d09;">Configuration</span>
            </div>
            <div class="card-body flex-grow-1 overflow-auto" style="min-height: 0;">
                <!-- Category Selection -->
                <div class="mb-3">
                    <label class="form-label" style="color: #ea6d09; font-weight: bold;">Product Category *</label>
                    <select class="form-select" id="categorySelect" required>
                        <option value="">Select a category...</option>
                    </select>
                </div>

                <!-- Date Range -->
                <div class="mb-3">
                    <label class="form-label" style="color: #5e3e2f; font-weight: bold;">Date Range</label>
                    <div class="row">
                        <div class="col-6">
                            <input type="date" class="form-control" id="startDate">
                        </div>
                        <div class="col-6">
                            <input type="date" class="form-control" id="endDate">
                        </div>
                    </div>
                </div>

                <!-- Line Selection -->
                <div class="mb-3">
                    <label class="form-label" style="color: #ea6d09; font-weight: bold;">Production Lines</label>
                    <select class="form-select" id="lineSelect" multiple size="6">
                    </select>
                    <small class="text-muted">Hold Ctrl to select multiple lines</small>
                </div>

                <!-- Shift Configuration per Line -->
                <div class="mb-3">
                    <label class="form-label" style="color: #5e3e2f; font-weight: bold;">Shift Configurations</label>
                    <div id="shiftConfigContainer">
                        <small class="text-muted">Select lines first</small>
                    </div>
                </div>

                <hr>

                <!-- Optional Product Filter -->
                <div class="mb-3">
                    <label class="form-label" style="color: #ea6d09; font-weight: bold;"><i class="bi bi-funnel"></i> Filter by Product (Optional)</label>
                    <select class="form-select" id="productFilter">
                        <option value="">All Products in Category</option>
                    </select>
                </div>

                <hr>

                <!-- Demand Modifications -->
                <h6 style="color: #ea6d09; font-weight: bold;"><i class="bi bi-pencil-square"></i> Demand Modifications</h6>
                <small class="text-muted d-block mb-2">Adjust client demand by percentage for specific products</small>
                
                <div class="card bg-light mb-3">
                    <div class="card-body p-2">
                        <div class="mb-2">
                            <label class="form-label small mb-1">Client</label>
                            <select class="form-select form-select-sm" id="modClientSelect">
                                <option value="">Select client...</option>
                            </select>
                        </div>
                        <div class="mb-2">
                            <label class="form-label small mb-1">Product</label>
                            <select class="form-select form-select-sm" id="modProductSelect" disabled>
                                <option value="">Select product...</option>
                            </select>
                        </div>
                        <div class="row mb-2">
                            <div class="col-6">
                                <label class="form-label small mb-1">Start Date</label>
                                <input type="date" class="form-control form-control-sm" id="modStartDate">
                            </div>
                            <div class="col-6">
                                <label class="form-label small mb-1">End Date</label>
                                <input type="date" class="form-control form-control-sm" id="modEndDate">
                            </div>
                        </div>
                        <div class="mb-2">
                            <label class="form-label small mb-1">Percentage Adjustment</label>
                            <div class="input-group input-group-sm">
                                <input type="number" class="form-control" id="modPercentage" value="0" min="-100" step="5">
                                <span class="input-group-text">%</span>
                            </div>
                            <small class="text-muted">-100% = Remove demand, +50% = Increase by 50%</small>
                        </div>
                        <div class="d-flex gap-1">
                            <button class="btn btn-sm btn-outline-primary flex-grow-1" id="modAddBtn" onclick="addDemandModification()">
                                <i class="bi bi-plus-lg"></i> Add Modification
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" id="modCancelBtn" onclick="cancelEditModification()" style="display: none;">
                                <i class="bi bi-x-lg"></i>
                            </button>
                        </div>
                    </div>
                </div>
                
                <div id="demandModificationsList" class="mb-3">
                    <!-- Demand modification items will appear here -->
                </div>

                <hr>

                <!-- Demand with Stock Handling -->
                <h6 style="color: #ea6d09; font-weight: bold;"><i class="bi bi-box-seam"></i> Demand with Stock</h6>
                <small class="text-muted d-block mb-2">Shift demand between weeks to optimize capacity. Adding units to a week will subtract them from the next week.</small>
                
                <div class="card bg-light mb-3">
                    <div class="card-body p-2">
                        <div class="row mb-2">
                            <div class="col-6">
                                <label class="form-label small mb-1">Week</label>
                                <select class="form-select form-select-sm" id="stockWeekSelect">
                                    <option value="">Select week...</option>
                                </select>
                            </div>
                            <div class="col-6">
                                <label class="form-label small mb-1">Units to Add</label>
                                <input type="number" class="form-control form-control-sm" id="stockUnits" value="0" step="100">
                            </div>
                        </div>
                        <small class="text-muted d-block mb-2"><i class="bi bi-info-circle"></i> Positive = add to this week (subtract from next), Negative = remove from this week (add to next)</small>
                        <div class="d-flex gap-1">
                            <button class="btn btn-sm btn-outline-success flex-grow-1" id="stockAddBtn" onclick="addStockAdjustment()">
                                <i class="bi bi-plus-lg"></i> Add Stock Adjustment
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" id="stockCancelBtn" onclick="cancelEditStockAdjustment()" style="display: none;">
                                <i class="bi bi-x-lg"></i>
                            </button>
                        </div>
                    </div>
                </div>
                
                <div id="stockAdjustmentsList" class="mb-3">
                    <!-- Stock adjustment items will appear here -->
                </div>

                <hr>

                <!-- Super Chilling -->
                <h6 style="color: #ea6d09; font-weight: bold;"><i class="bi bi-snow"></i> Super Chilling</h6>
                <small class="text-muted d-block mb-2">Shift demand between weeks (up to 4 weeks apart). Reduce demand in one week and increase it in an earlier week for pre-production.</small>
                
                <div class="card bg-light mb-3">
                    <div class="card-body p-2">
                        <div class="row mb-2">
                            <div class="col-6">
                                <label class="form-label small mb-1">Reduce Week (Peak)</label>
                                <select class="form-select form-select-sm" id="superChillReduceWeek">
                                    <option value="">Select week...</option>
                                </select>
                            </div>
                            <div class="col-6">
                                <label class="form-label small mb-1">Increase Week (Pre-prod)</label>
                                <select class="form-select form-select-sm" id="superChillIncreaseWeek">
                                    <option value="">Select week...</option>
                                </select>
                            </div>
                        </div>
                        <div class="mb-2">
                            <label class="form-label small mb-1">Units to Transfer</label>
                            <input type="number" class="form-control form-control-sm" id="superChillUnits" value="0" step="100">
                        </div>
                        <small class="text-muted d-block mb-2"><i class="bi bi-info-circle"></i> Transfer demand from peak week to an earlier week (up to 4 weeks before) for super chilling pre-production.</small>
                        <div class="d-flex gap-1">
                            <button class="btn btn-sm btn-outline-info flex-grow-1" id="superChillAddBtn" onclick="addSuperChillAdjustment()">
                                <i class="bi bi-plus-lg"></i> Add Super Chill Adjustment
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" id="superChillCancelBtn" onclick="cancelEditSuperChillAdjustment()" style="display: none;">
                                <i class="bi bi-x-lg"></i>
                            </button>
                        </div>
                    </div>
                </div>
                
                <div id="superChillAdjustmentsList" class="mb-3">
                    <!-- Super chill adjustment items will appear here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Results Panel -->
    <div class="col-md-8">
        <!-- Stats Cards -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card stat-card">
                    <div class="stat-value" id="avgUtilization">-</div>
                    <div class="stat-label">Avg Utilization %</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stat-card warning">
                    <div class="stat-value" id="peakUtilization">-</div>
                    <div class="stat-label">Peak Utilization %</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stat-card danger">
                    <div class="stat-value" id="overCapacityPeriods">-</div>
                    <div class="stat-label">Over-Capacity Weeks</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stat-card success">
                    <div class="stat-value" id="categoryName">-</div>
                    <div class="stat-label">Category</div>
                </div>
            </div>
        </div>

        <!-- Chart -->
        <div class="card">
            <div class="card-header">
                <i class="bi bi-graph-up"></i> Category Demand vs Capacity
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="simulationChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Data Table -->
        <div class="card mt-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="bi bi-table"></i> Weekly Data</span>
                <div class="btn-group btn-group-sm" id="exportButtons" style="display: none;">
                    <button class="btn btn-outline-success" onclick="exportToCSV()" title="Export to CSV">
                        <i class="bi bi-filetype-csv"></i> CSV
                    </button>
                    <button class="btn btn-outline-primary" onclick="exportToExcel()" title="Export to Excel">
                        <i class="bi bi-file-earmark-excel"></i> Excel
                    </button>
                    <button class="btn btn-outline-secondary" onclick="exportChartAsImage()" title="Export Chart as Image">
                        <i class="bi bi-image"></i> Chart
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-sm" id="dataTable">
                        <thead>
                            <tr>
                                <th>Week</th>
                                <th>Demand</th>
                                <th>Capacity</th>
                                <th>Utilization</th>
                                <th>Status</th>
                                <th>Config Override</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="5" class="text-center text-muted">Run simulation to see data</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // CSRF Token handling
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');
    let simulationChart = null;
    let shiftConfigs = [];
    let allLines = [];
    let allClients = [];
    let allProducts = [];
    let demandModifications = [];  // Store demand modifications
    let lastSimulationResult = null;  // Store for export
    let stockAdjustments = [];  // Store stock adjustments for demand shifting
    let editingStockId = null;  // Track if we're editing an existing stock adjustment
    let availableWeeks = [];  // Store available weeks from last simulation
    let superChillAdjustments = [];  // Store super chilling adjustments (up to 4 weeks)
    let editingSuperChillId = null;  // Track if we're editing an existing super chill adjustment

    document.addEventListener('DOMContentLoaded', async function() {
        const today = new Date();
        const sixMonthsLater = new Date(today);
        sixMonthsLater.setMonth(sixMonthsLater.getMonth() + 6);
        
        document.getElementById('startDate').value = today.toISOString().split('T')[0];
        document.getElementById('endDate').value = sixMonthsLater.toISOString().split('T')[0];
        
        // Initialize modification dates
        document.getElementById('modStartDate').value = today.toISOString().split('T')[0];
        document.getElementById('modEndDate').value = sixMonthsLater.toISOString().split('T')[0];

        await Promise.all([
            loadCategories(),
            loadLines(),
            loadShiftConfigs(),
            loadClients(),
            loadAllProducts()
        ]);

        document.getElementById('lineSelect').addEventListener('change', updateShiftConfigUI);
        document.getElementById('categorySelect').addEventListener('change', loadProductsByCategory);
        
        // Setup modification client change listener
        document.getElementById('modClientSelect').addEventListener('change', loadClientProducts);
    });

    async function loadCategories() {
        const data = await fetchAPI('categories/');
        const categories = Array.isArray(data.results) ? data.results : (Array.isArray(data) ? data : []);
        const select = document.getElementById('categorySelect');
        select.innerHTML = '<option value="">Select a category...</option>' + 
            categories.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
    }

    async function loadLines() {
        const data = await fetchAPI('lines/');
        allLines = Array.isArray(data.results) ? data.results : (Array.isArray(data) ? data : []);
        const select = document.getElementById('lineSelect');
        select.innerHTML = allLines.map(line => 
            `<option value="${line.id}">${line.site_name} - ${line.name}</option>`
        ).join('');
    }

    async function loadShiftConfigs() {
        const data = await fetchAPI('shift-configs/');
        shiftConfigs = Array.isArray(data.results) ? data.results : (Array.isArray(data) ? data : []);
    }
    
    async function loadClients() {
        const data = await fetchAPI('clients/');
        allClients = Array.isArray(data.results) ? data.results : (Array.isArray(data) ? data : []);
        // Populate modification client dropdown
        const modClientSelect = document.getElementById('modClientSelect');
        modClientSelect.innerHTML = '<option value="">Select client...</option>' + 
            allClients.map(c => `<option value="${c.id}" data-code="${c.code}">${c.code} - ${c.name}</option>`).join('');
    }
    
    async function loadAllProducts() {
        const data = await fetchAPI('products/');
        allProducts = Array.isArray(data.results) ? data.results : (Array.isArray(data) ? data : []);
    }
    
    async function loadClientProducts() {
        const clientId = document.getElementById('modClientSelect').value;
        const productSelect = document.getElementById('modProductSelect');
        
        if (!clientId) {
            productSelect.innerHTML = '<option value="">Select product...</option>';
            productSelect.disabled = true;
            return;
        }
        
        // Get products that have demand forecasts for this client
        try {
            const data = await fetchAPI(`forecasts/products_by_client/?client_id=${clientId}`);
            const products = Array.isArray(data.results) ? data.results : (Array.isArray(data) ? data : []);
            
            if (products.length > 0) {
                productSelect.innerHTML = '<option value="">All products</option>' + 
                    products.map(p => `<option value="${p.id}" data-code="${p.code}">${p.code} - ${p.name}</option>`).join('');
            } else {
                productSelect.innerHTML = '<option value="">All products</option>' + 
                    allProducts.map(p => `<option value="${p.id}" data-code="${p.code}">${p.code} - ${p.name}</option>`).join('');
            }
            productSelect.disabled = false;
        } catch (error) {
            productSelect.innerHTML = '<option value="">All products</option>' + 
                allProducts.map(p => `<option value="${p.id}" data-code="${p.code}">${p.code} - ${p.name}</option>`).join('');
            productSelect.disabled = false;
        }
    }

    async function loadProductsByCategory() {
        const categoryId = document.getElementById('categorySelect').value;
        const select = document.getElementById('productFilter');
        
        if (!categoryId) {
            select.innerHTML = '<option value="">All Products in Category</option>';
            return;
        }

        const data = await fetchAPI(`products/by_category/?category_id=${categoryId}`);
        const products = Array.isArray(data.results) ? data.results : (Array.isArray(data) ? data : []);
        select.innerHTML = '<option value="">All Products in Category</option>' + 
            products.map(p => `<option value="${p.id}">${p.code} - ${p.name}</option>`).join('');
    }

    function updateShiftConfigUI() {
        const container = document.getElementById('shiftConfigContainer');
        const selectedOptions = Array.from(document.getElementById('lineSelect').selectedOptions);
        
        if (selectedOptions.length === 0) {
            container.innerHTML = '<small class="text-muted">Select lines first</small>';
            return;
        }

        container.innerHTML = selectedOptions.map(opt => {
            const line = allLines.find(l => l.id == opt.value);
            const hasOverrides = line && line.active_overrides_count > 0;
            return `
                <div class="mb-2">
                    <label class="form-label small">${line ? line.name : 'Line'} ${hasOverrides ? '<span class="badge bg-warning text-dark"><i class="bi bi-wrench"></i> Has Overrides</span>' : ''}</label>
                    <select class="form-select form-select-sm" data-line-id="${opt.value}">
                        <option value="override" ${hasOverrides ? 'selected' : ''}>üîß Use Override Config (date-based)</option>
                        ${shiftConfigs.map(sc => `<option value="${sc.id}" ${!hasOverrides && line && line.default_shift_config == sc.id ? 'selected' : ''}>${sc.name}</option>`).join('')}
                    </select>
                </div>
            `;
        }).join('');
    }

    async function runSimulation() {
        const categoryId = document.getElementById('categorySelect').value;
        if (!categoryId) {
            alert('Please select a product category');
            return;
        }

        const lineSelect = document.getElementById('lineSelect');
        const selectedLineIds = Array.from(lineSelect.selectedOptions).map(opt => parseInt(opt.value));
        
        if (selectedLineIds.length === 0) {
            alert('Please select at least one production line');
            return;
        }

        const shiftConfigSelects = document.querySelectorAll('#shiftConfigContainer select');
        const lineShiftConfigs = Array.from(shiftConfigSelects).map(select => ({
            line_id: parseInt(select.dataset.lineId),
            shift_config_id: select.value === 'override' ? null : parseInt(select.value),
            use_override: select.value === 'override'
        }));

        const requestData = {
            category_id: parseInt(categoryId),
            line_ids: selectedLineIds,
            shift_configs: lineShiftConfigs,
            start_date: document.getElementById('startDate').value,
            end_date: document.getElementById('endDate').value,
            product_id: document.getElementById('productFilter').value || null,
            demand_modifications: demandModifications.length > 0 ? demandModifications : null
        };

        try {
            // Use fetch directly to include CSRF token
            const response = await fetch('/api/simulate/category/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken
                },
                body: JSON.stringify(requestData)
            });
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const result = await response.json();
            displayResults(result);
        } catch (error) {
            console.error('Simulation error:', error);
            alert('Error running simulation: ' + error.message);
        }
    }

    function displayResults(result) {
        // Store results for export
        lastSimulationResult = result;
        document.getElementById('exportButtons').style.display = 'inline-flex';
        
        document.getElementById('avgUtilization').textContent = result.average_utilization + '%';
        document.getElementById('peakUtilization').textContent = result.peak_utilization + '%';
        document.getElementById('overCapacityPeriods').textContent = result.over_capacity_periods;
        document.getElementById('categoryName').textContent = result.overlay_data?.category_name || '-';

        // Update available weeks for stock adjustment
        availableWeeks = result.data_points.map(dp => dp.date);
        updateStockWeekSelect();

        updateChart(result.data_points);
        updateTable(result.data_points);
    }

    function updateChart(dataPoints) {
        const ctx = document.getElementById('simulationChart').getContext('2d');
        
        if (simulationChart) simulationChart.destroy();

        // Point colors for capacity - highlight overrides
        const capacityPointColors = dataPoints.map(dp => 
            dp.has_override ? '#ffc107' : chartColors.primary
        );
        const capacityPointRadius = dataPoints.map(dp => 
            dp.has_override ? 6 : 3
        );
        
        // Build datasets array
        const datasets = [
            {
                label: 'Category Demand',
                data: dataPoints.map(dp => parseFloat(dp.demand)),
                borderColor: chartColors.accent,
                backgroundColor: chartColors.accentLight,
                fill: true,
                tension: 0.3
            },
            {
                label: 'Capacity',
                data: dataPoints.map(dp => parseFloat(dp.capacity)),
                borderColor: chartColors.primary,
                backgroundColor: chartColors.primaryLight,
                borderDash: [5, 5],
                fill: false,
                tension: 0,
                pointBackgroundColor: capacityPointColors,
                pointBorderColor: capacityPointColors,
                pointRadius: capacityPointRadius,
                pointHoverRadius: 8
            }
        ];
        
        // Add adjusted demand curve if stock adjustments or super chill adjustments exist
        const adjustedDemand = calculateAdjustedDemand(dataPoints);
        if (adjustedDemand) {
            // Determine label based on what adjustments are active
            let adjustedLabel = 'Adjusted Demand';
            if (stockAdjustments.length > 0 && superChillAdjustments.length > 0) {
                adjustedLabel = 'Demand (Stock + Super Chill)';
            } else if (stockAdjustments.length > 0) {
                adjustedLabel = 'Demand with Stock';
            } else if (superChillAdjustments.length > 0) {
                adjustedLabel = 'Demand with Super Chill';
            }
            
            datasets.push({
                label: adjustedLabel,
                data: adjustedDemand,
                borderColor: '#17a2b8',  // Teal/cyan color
                backgroundColor: '#17a2b840',
                fill: false,
                tension: 0.3,
                borderWidth: 3,
                borderDash: [10, 5],
                pointRadius: 5,
                pointStyle: 'rectRot'
            });
        }

        simulationChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: dataPoints.map(dp => dp.date),
                datasets: datasets
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'top' },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        callbacks: {
                            afterBody: function(context) {
                                const dataIndex = context[0].dataIndex;
                                const dp = dataPoints[dataIndex];
                                if (dp.has_override) {
                                    return ['‚ö†Ô∏è Config override active for this week'];
                                }
                                return [];
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: { display: true, text: 'Units' }
                    }
                }
            }
        });
    }

    function updateTable(dataPoints) {
        const tbody = document.querySelector('#dataTable tbody');
        tbody.innerHTML = dataPoints.map(dp => `
            <tr class="${dp.over_capacity ? 'table-danger' : ''}">
                <td>${dp.date}</td>
                <td>${parseFloat(dp.demand).toLocaleString()}</td>
                <td>${parseFloat(dp.capacity).toLocaleString()}</td>
                <td>${dp.utilization_percent}%</td>
                <td>${dp.over_capacity ? '<span class="badge bg-danger">Over</span>' : '<span class="badge bg-success">OK</span>'}</td>
                <td>
                    ${dp.has_override 
                        ? '<span class="badge bg-warning text-dark" title="Custom configuration active"><i class="bi bi-wrench"></i></span>' 
                        : '<span class="text-muted">-</span>'}
                </td>
            </tr>
        `).join('');
    }
    
    // Export Functions
    function exportToCSV() {
        if (!lastSimulationResult) {
            alert('No simulation data to export. Run a simulation first.');
            return;
        }
        
        const dataPoints = lastSimulationResult.data_points;
        let csvContent = 'Week,Demand,Capacity,Utilization %,Status,Has Override\n';
        
        dataPoints.forEach(dp => {
            csvContent += `${dp.date},${dp.demand},${dp.capacity},${dp.utilization_percent},${dp.over_capacity ? 'Over Capacity' : 'OK'},${dp.has_override ? 'Yes' : 'No'}\n`;
        });
        
        csvContent += '\nSummary\n';
        csvContent += `Average Utilization,${lastSimulationResult.average_utilization}%\n`;
        csvContent += `Peak Utilization,${lastSimulationResult.peak_utilization}%\n`;
        csvContent += `Over-Capacity Weeks,${lastSimulationResult.over_capacity_periods}\n`;
        
        downloadFile(csvContent, 'category_simulation_export.csv', 'text/csv');
    }
    
    function exportToExcel() {
        if (!lastSimulationResult) {
            alert('No simulation data to export. Run a simulation first.');
            return;
        }
        
        const dataPoints = lastSimulationResult.data_points;
        let html = '<html><head><meta charset="UTF-8"></head><body><table border="1">';
        html += '<tr style="background-color: #4a90d9; color: white;"><th>Week</th><th>Demand</th><th>Capacity</th><th>Utilization %</th><th>Status</th><th>Has Override</th></tr>';
        
        dataPoints.forEach(dp => {
            const style = dp.over_capacity ? 'background-color: #f8d7da;' : '';
            html += `<tr style="${style}"><td>${dp.date}</td><td>${dp.demand}</td><td>${dp.capacity}</td><td>${dp.utilization_percent}%</td><td>${dp.over_capacity ? 'Over Capacity' : 'OK'}</td><td>${dp.has_override ? 'Yes' : 'No'}</td></tr>`;
        });
        
        html += '<tr><td colspan="6"></td></tr>';
        html += '<tr style="background-color: #e9ecef;"><td colspan="6"><b>Summary</b></td></tr>';
        html += `<tr><td>Average Utilization</td><td colspan="5">${lastSimulationResult.average_utilization}%</td></tr>`;
        html += `<tr><td>Peak Utilization</td><td colspan="5">${lastSimulationResult.peak_utilization}%</td></tr>`;
        html += `<tr><td>Over-Capacity Weeks</td><td colspan="5">${lastSimulationResult.over_capacity_periods}</td></tr>`;
        html += '</table></body></html>';
        
        downloadFile(html, 'category_simulation_export.xls', 'application/vnd.ms-excel');
    }
    
    function exportChartAsImage() {
        if (!simulationChart) {
            alert('No chart to export. Run a simulation first.');
            return;
        }
        
        // Create a temporary canvas with white background
        const canvas = document.getElementById('simulationChart');
        const tempCanvas = document.createElement('canvas');
        tempCanvas.width = canvas.width;
        tempCanvas.height = canvas.height;
        const tempCtx = tempCanvas.getContext('2d');
        
        // Fill white background
        tempCtx.fillStyle = '#ffffff';
        tempCtx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);
        
        // Draw the chart on top
        tempCtx.drawImage(canvas, 0, 0);
        
        const link = document.createElement('a');
        link.download = 'category_simulation_chart.jpg';
        link.href = tempCanvas.toDataURL('image/jpeg', 1);
        link.click();
    }
    
    function downloadFile(content, filename, mimeType) {
        const blob = new Blob([content], { type: mimeType + ';charset=utf-8;' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = filename;
        link.click();
    }
    
    // Demand Modification Functions
    let editingModId = null;  // Track if we're editing an existing modification
    
    function addDemandModification() {
        const clientSelect = document.getElementById('modClientSelect');
        const productSelect = document.getElementById('modProductSelect');
        const startDate = document.getElementById('modStartDate').value;
        const endDate = document.getElementById('modEndDate').value;
        const percentage = parseFloat(document.getElementById('modPercentage').value);
        
        if (!clientSelect.value) {
            alert('Please select a client');
            return;
        }
        
        if (!startDate || !endDate) {
            alert('Please select start and end dates');
            return;
        }
        
        if (isNaN(percentage)) {
            alert('Please enter a valid percentage');
            return;
        }
        
        const clientOption = clientSelect.options[clientSelect.selectedIndex];
        const clientCode = clientOption.dataset.code;
        const clientName = clientOption.text;
        
        let productCode = null;
        let productName = 'All products';
        if (productSelect.value) {
            const productOption = productSelect.options[productSelect.selectedIndex];
            productCode = productOption.dataset.code;
            productName = productOption.text;
        }
        
        if (editingModId !== null) {
            // Update existing modification
            const modIndex = demandModifications.findIndex(m => m.id === editingModId);
            if (modIndex !== -1) {
                demandModifications[modIndex] = {
                    id: editingModId,
                    client_id: parseInt(clientSelect.value),
                    client_code: clientCode,
                    client_name: clientName,
                    product_id: productSelect.value ? parseInt(productSelect.value) : null,
                    product_code: productCode,
                    product_name: productName,
                    start_date: startDate,
                    end_date: endDate,
                    percentage: percentage
                };
            }
            editingModId = null;
            document.getElementById('modAddBtn').innerHTML = '<i class="bi bi-plus-lg"></i> Add Modification';
            document.getElementById('modCancelBtn').style.display = 'none';
        } else {
            // Create new modification
            const modId = Date.now();
            demandModifications.push({
                id: modId,
                client_id: parseInt(clientSelect.value),
                client_code: clientCode,
                client_name: clientName,
                product_id: productSelect.value ? parseInt(productSelect.value) : null,
                product_code: productCode,
                product_name: productName,
                start_date: startDate,
                end_date: endDate,
                percentage: percentage
            });
        }
        
        updateDemandModificationsList();
        
        // Reset form
        document.getElementById('modPercentage').value = 0;
    }
    
    function editDemandModification(modId) {
        const mod = demandModifications.find(m => m.id === modId);
        if (!mod) return;
        
        editingModId = modId;
        
        // Populate form with existing values
        document.getElementById('modClientSelect').value = mod.client_id;
        loadClientProducts().then(() => {
            document.getElementById('modProductSelect').value = mod.product_id || '';
        });
        document.getElementById('modStartDate').value = mod.start_date;
        document.getElementById('modEndDate').value = mod.end_date;
        document.getElementById('modPercentage').value = mod.percentage;
        
        // Update button text
        document.getElementById('modAddBtn').innerHTML = '<i class="bi bi-check-lg"></i> Update Modification';
        document.getElementById('modCancelBtn').style.display = 'inline-block';
    }
    
    function cancelEditModification() {
        editingModId = null;
        document.getElementById('modAddBtn').innerHTML = '<i class="bi bi-plus-lg"></i> Add Modification';
        document.getElementById('modCancelBtn').style.display = 'none';
        document.getElementById('modPercentage').value = 0;
    }
    
    function removeDemandModification(modId) {
        demandModifications = demandModifications.filter(m => m.id !== modId);
        if (editingModId === modId) {
            cancelEditModification();
        }
        updateDemandModificationsList();
    }
    
    function updateDemandModificationsList() {
        const container = document.getElementById('demandModificationsList');
        
        if (demandModifications.length === 0) {
            container.innerHTML = '';
            return;
        }
        
        container.innerHTML = demandModifications.map(mod => {
            const percentClass = mod.percentage < 0 ? 'text-danger' : 'text-success';
            const percentSign = mod.percentage >= 0 ? '+' : '';
            const percentIcon = mod.percentage === -100 ? 'üö´' : (mod.percentage < 0 ? 'üìâ' : 'üìà');
            const isEditing = editingModId === mod.id;
            
            return `
                <div class="alert ${isEditing ? 'alert-warning' : 'alert-secondary'} py-1 px-2 mb-1">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="small">
                            <strong>${mod.client_code}</strong> - ${mod.product_code || 'All'}<br>
                            <span class="${percentClass}">${percentIcon} ${percentSign}${mod.percentage}%</span>
                            <span class="text-muted">(${mod.start_date} to ${mod.end_date})</span>
                        </div>
                        <div>
                            <button class="btn btn-sm btn-outline-primary py-0 px-1 me-1" onclick="editDemandModification(${mod.id})" title="Edit">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger py-0 px-1" onclick="removeDemandModification(${mod.id})" title="Remove">
                                <i class="bi bi-x"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }).join('');
    }
    
    // Stock Adjustment Functions
    function addStockAdjustment() {
        const weekSelect = document.getElementById('stockWeekSelect');
        const units = parseFloat(document.getElementById('stockUnits').value);
        
        if (!weekSelect.value) {
            alert('Please select a week');
            return;
        }
        
        if (isNaN(units) || units === 0) {
            alert('Please enter a valid number of units (non-zero)');
            return;
        }
        
        const week = weekSelect.value;
        const weekIndex = availableWeeks.indexOf(week);
        
        if (weekIndex === availableWeeks.length - 1) {
            alert('Cannot adjust the last week as there is no following week to balance');
            return;
        }
        
        const nextWeek = availableWeeks[weekIndex + 1];
        
        if (editingStockId !== null) {
            // Update existing adjustment
            const adjIndex = stockAdjustments.findIndex(a => a.id === editingStockId);
            if (adjIndex !== -1) {
                stockAdjustments[adjIndex] = {
                    id: editingStockId,
                    week: week,
                    next_week: nextWeek,
                    units: units
                };
            }
            editingStockId = null;
            document.getElementById('stockAddBtn').innerHTML = '<i class="bi bi-plus-lg"></i> Add Stock Adjustment';
            document.getElementById('stockCancelBtn').style.display = 'none';
        } else {
            // Create new adjustment
            const adjId = Date.now();
            stockAdjustments.push({
                id: adjId,
                week: week,
                next_week: nextWeek,
                units: units
            });
        }
        
        updateStockAdjustmentsList();
        document.getElementById('stockUnits').value = 0;
        
        // Re-render chart if we have results
        if (lastSimulationResult) {
            updateChart(lastSimulationResult.data_points);
        }
    }
    
    function editStockAdjustment(adjId) {
        const adj = stockAdjustments.find(a => a.id === adjId);
        if (!adj) return;
        
        editingStockId = adjId;
        document.getElementById('stockWeekSelect').value = adj.week;
        document.getElementById('stockUnits').value = adj.units;
        
        document.getElementById('stockAddBtn').innerHTML = '<i class="bi bi-check-lg"></i> Update Adjustment';
        document.getElementById('stockCancelBtn').style.display = 'inline-block';
    }
    
    function cancelEditStockAdjustment() {
        editingStockId = null;
        document.getElementById('stockAddBtn').innerHTML = '<i class="bi bi-plus-lg"></i> Add Stock Adjustment';
        document.getElementById('stockCancelBtn').style.display = 'none';
        document.getElementById('stockUnits').value = 0;
    }
    
    function removeStockAdjustment(adjId) {
        stockAdjustments = stockAdjustments.filter(a => a.id !== adjId);
        if (editingStockId === adjId) {
            cancelEditStockAdjustment();
        }
        updateStockAdjustmentsList();
        
        // Re-render chart if we have results
        if (lastSimulationResult) {
            updateChart(lastSimulationResult.data_points);
        }
    }
    
    function updateStockAdjustmentsList() {
        const container = document.getElementById('stockAdjustmentsList');
        
        if (stockAdjustments.length === 0) {
            container.innerHTML = '';
            return;
        }
        
        container.innerHTML = stockAdjustments.map(adj => {
            const isEditing = editingStockId === adj.id;
            const unitsClass = adj.units > 0 ? 'text-success' : 'text-danger';
            const unitsSign = adj.units > 0 ? '+' : '';
            const icon = adj.units > 0 ? 'üì¶‚û°Ô∏è' : '‚¨ÖÔ∏èüì¶';
            
            return `
                <div class="alert ${isEditing ? 'alert-warning' : 'alert-info'} py-1 px-2 mb-1">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="small">
                            ${icon} <strong>${adj.week}</strong>: <span class="${unitsClass}">${unitsSign}${adj.units.toLocaleString()}</span> units<br>
                            <span class="text-muted">‚Üí ${adj.next_week}: <span class="${adj.units > 0 ? 'text-danger' : 'text-success'}">${adj.units > 0 ? '-' : '+'}${Math.abs(adj.units).toLocaleString()}</span> units</span>
                        </div>
                        <div>
                            <button class="btn btn-sm btn-outline-primary py-0 px-1 me-1" onclick="editStockAdjustment(${adj.id})" title="Edit">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger py-0 px-1" onclick="removeStockAdjustment(${adj.id})" title="Remove">
                                <i class="bi bi-x"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }).join('');
    }
    
    function updateStockWeekSelect() {
        const select = document.getElementById('stockWeekSelect');
        select.innerHTML = '<option value="">Select week...</option>' + 
            availableWeeks.slice(0, -1).map(week => `<option value="${week}">${week}</option>`).join('');
        
        // Also update super chill week selects
        updateSuperChillWeekSelects();
    }
    
    function calculateAdjustedDemand(dataPoints) {
        if (stockAdjustments.length === 0 && superChillAdjustments.length === 0) return null;
        
        // Create a copy of demand data
        const adjustedDemand = dataPoints.map(dp => parseFloat(dp.demand));
        
        // Apply each stock adjustment
        stockAdjustments.forEach(adj => {
            const weekIndex = dataPoints.findIndex(dp => dp.date === adj.week);
            const nextWeekIndex = dataPoints.findIndex(dp => dp.date === adj.next_week);
            
            if (weekIndex !== -1 && nextWeekIndex !== -1) {
                adjustedDemand[weekIndex] += adj.units;
                adjustedDemand[nextWeekIndex] -= adj.units;
            }
        });
        
        // Apply each super chill adjustment
        superChillAdjustments.forEach(adj => {
            const reduceIndex = dataPoints.findIndex(dp => dp.date === adj.reduce_week);
            const increaseIndex = dataPoints.findIndex(dp => dp.date === adj.increase_week);
            
            if (reduceIndex !== -1 && increaseIndex !== -1) {
                adjustedDemand[reduceIndex] -= adj.units;  // Reduce demand in peak week
                adjustedDemand[increaseIndex] += adj.units;  // Increase demand in pre-prod week
            }
        });
        
        return adjustedDemand;
    }
    
    function updateSuperChillWeekSelects() {
        const reduceSelect = document.getElementById('superChillReduceWeek');
        const increaseSelect = document.getElementById('superChillIncreaseWeek');
        
        // Reduce week can be any week except the first 4 (need at least 4 weeks before)
        reduceSelect.innerHTML = '<option value="">Select week...</option>' + 
            availableWeeks.slice(4).map(week => `<option value="${week}">${week}</option>`).join('');
        
        // Increase week options will be populated based on reduce week selection
        increaseSelect.innerHTML = '<option value="">Select reduce week first...</option>';
        
        // Add event listener for reduce week change
        reduceSelect.onchange = updateIncreaseWeekOptions;
    }
    
    function updateIncreaseWeekOptions() {
        const reduceWeek = document.getElementById('superChillReduceWeek').value;
        const increaseSelect = document.getElementById('superChillIncreaseWeek');
        
        if (!reduceWeek) {
            increaseSelect.innerHTML = '<option value="">Select reduce week first...</option>';
            return;
        }
        
        const reduceIndex = availableWeeks.indexOf(reduceWeek);
        // Allow selection of 1 to 4 weeks before the reduce week
        const minIndex = Math.max(0, reduceIndex - 4);
        const eligibleWeeks = availableWeeks.slice(minIndex, reduceIndex);
        
        increaseSelect.innerHTML = '<option value="">Select week...</option>' + 
            eligibleWeeks.map((week, i) => {
                const weeksApart = reduceIndex - (minIndex + i);
                return `<option value="${week}">${week} (${weeksApart} week${weeksApart > 1 ? 's' : ''} before)</option>`;
            }).join('');
    }
    
    // Super Chill Adjustment Functions
    function addSuperChillAdjustment() {
        const reduceWeek = document.getElementById('superChillReduceWeek').value;
        const increaseWeek = document.getElementById('superChillIncreaseWeek').value;
        const units = parseFloat(document.getElementById('superChillUnits').value);
        
        if (!reduceWeek) {
            alert('Please select a week to reduce demand from (peak week)');
            return;
        }
        
        if (!increaseWeek) {
            alert('Please select a week to increase demand (pre-production week)');
            return;
        }
        
        if (isNaN(units) || units <= 0) {
            alert('Please enter a valid positive number of units to transfer');
            return;
        }
        
        // Validate that increase week is before reduce week
        const reduceIndex = availableWeeks.indexOf(reduceWeek);
        const increaseIndex = availableWeeks.indexOf(increaseWeek);
        
        if (increaseIndex >= reduceIndex) {
            alert('Increase week must be before the reduce week');
            return;
        }
        
        const weeksApart = reduceIndex - increaseIndex;
        if (weeksApart > 4) {
            alert('Super chilling allows maximum 4 weeks between reduce and increase weeks');
            return;
        }
        
        if (editingSuperChillId !== null) {
            // Update existing adjustment
            const adjIndex = superChillAdjustments.findIndex(a => a.id === editingSuperChillId);
            if (adjIndex !== -1) {
                superChillAdjustments[adjIndex] = {
                    id: editingSuperChillId,
                    reduce_week: reduceWeek,
                    increase_week: increaseWeek,
                    units: units,
                    weeks_apart: weeksApart
                };
            }
            editingSuperChillId = null;
            document.getElementById('superChillAddBtn').innerHTML = '<i class="bi bi-plus-lg"></i> Add Super Chill Adjustment';
            document.getElementById('superChillCancelBtn').style.display = 'none';
        } else {
            // Create new adjustment
            const adjId = Date.now();
            superChillAdjustments.push({
                id: adjId,
                reduce_week: reduceWeek,
                increase_week: increaseWeek,
                units: units,
                weeks_apart: weeksApart
            });
        }
        
        updateSuperChillAdjustmentsList();
        document.getElementById('superChillUnits').value = 0;
        document.getElementById('superChillReduceWeek').value = '';
        document.getElementById('superChillIncreaseWeek').innerHTML = '<option value="">Select reduce week first...</option>';
        
        // Re-render chart if we have results
        if (lastSimulationResult) {
            updateChart(lastSimulationResult.data_points);
        }
    }
    
    function editSuperChillAdjustment(adjId) {
        const adj = superChillAdjustments.find(a => a.id === adjId);
        if (!adj) return;
        
        editingSuperChillId = adjId;
        document.getElementById('superChillReduceWeek').value = adj.reduce_week;
        updateIncreaseWeekOptions();
        document.getElementById('superChillIncreaseWeek').value = adj.increase_week;
        document.getElementById('superChillUnits').value = adj.units;
        
        document.getElementById('superChillAddBtn').innerHTML = '<i class="bi bi-check-lg"></i> Update Adjustment';
        document.getElementById('superChillCancelBtn').style.display = 'inline-block';
    }
    
    function cancelEditSuperChillAdjustment() {
        editingSuperChillId = null;
        document.getElementById('superChillAddBtn').innerHTML = '<i class="bi bi-plus-lg"></i> Add Super Chill Adjustment';
        document.getElementById('superChillCancelBtn').style.display = 'none';
        document.getElementById('superChillUnits').value = 0;
        document.getElementById('superChillReduceWeek').value = '';
        document.getElementById('superChillIncreaseWeek').innerHTML = '<option value="">Select reduce week first...</option>';
    }
    
    function removeSuperChillAdjustment(adjId) {
        superChillAdjustments = superChillAdjustments.filter(a => a.id !== adjId);
        if (editingSuperChillId === adjId) {
            cancelEditSuperChillAdjustment();
        }
        updateSuperChillAdjustmentsList();
        
        // Re-render chart if we have results
        if (lastSimulationResult) {
            updateChart(lastSimulationResult.data_points);
        }
    }
    
    function updateSuperChillAdjustmentsList() {
        const container = document.getElementById('superChillAdjustmentsList');
        
        if (superChillAdjustments.length === 0) {
            container.innerHTML = '';
            return;
        }
        
        container.innerHTML = superChillAdjustments.map(adj => {
            const isEditing = editingSuperChillId === adj.id;
            
            return `
                <div class="alert ${isEditing ? 'alert-warning' : 'alert-info'} py-1 px-2 mb-1" style="border-left: 3px solid #17a2b8;">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="small">
                            <i class="bi bi-snow text-info"></i> <strong>${adj.reduce_week}</strong>: <span class="text-danger">-${adj.units.toLocaleString()}</span> units<br>
                            <span class="text-muted">‚Üí ${adj.increase_week}: <span class="text-success">+${adj.units.toLocaleString()}</span> units</span>
                            <span class="badge bg-info ms-1">${adj.weeks_apart}W apart</span>
                        </div>
                        <div>
                            <button class="btn btn-sm btn-outline-primary py-0 px-1 me-1" onclick="editSuperChillAdjustment(${adj.id})" title="Edit">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger py-0 px-1" onclick="removeSuperChillAdjustment(${adj.id})" title="Remove">
                                <i class="bi bi-x"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }).join('');
    }
</script>
{% endblock %}
