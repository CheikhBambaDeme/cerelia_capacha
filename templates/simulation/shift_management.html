{% extends 'base.html' %}

{% block title %}Shift Management - Cerelia{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="bi bi-clock-history"></i> Shift Management</h2>
    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#shiftModal" onclick="resetForm()">
        <i class="bi bi-plus-lg"></i> New Shift Configuration
    </button>
</div>

<div class="row">
    <!-- Default Shift Configurations -->
    <div class="col-md-6">
        <div class="card mb-4">
            <div class="card-header">
                <i class="bi bi-list-ul"></i> <span style="color: #5e3e2f;">System Shift Configurations</span>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-sm">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Shifts/Day</th>
                                <th>Hours/Shift</th>
                                <th>Days/Week</th>
                                <th>Weekend</th>
                                <th>Cleaning</th>
                                <th>Weekly Hours</th>
                            </tr>
                        </thead>
                        <tbody id="systemShiftsBody">
                            <tr>
                                <td colspan="7" class="text-center text-muted">Loading...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Custom Shift Configurations -->
    <div class="col-md-6">
        <div class="card mb-4">
            <div class="card-header">
                <i class="bi bi-gear"></i> <span style="color: #ea6d09;">Custom Shift Configurations</span>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-sm">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Shifts/Day</th>
                                <th>Hours/Shift</th>
                                <th>Days/Week</th>
                                <th>Weekend</th>
                                <th>Cleaning</th>
                                <th>Weekly Hours</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="customShiftsBody">
                            <tr>
                                <td colspan="8" class="text-center text-muted">Loading...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Shift Configuration Modal -->
<div class="modal fade" id="shiftModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">
                    <i class="bi bi-clock-history"></i> New Shift Configuration
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="shiftForm">
                    <input type="hidden" id="shiftId">
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold">Configuration Name</label>
                        <input type="text" class="form-control" id="shiftName" placeholder="e.g., 2x8 SS 6d (auto-generated if empty)">
                        <small class="text-muted">Leave blank to auto-generate based on settings</small>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold">Description</label>
                        <textarea class="form-control" id="shiftDescription" rows="2" placeholder="Optional description"></textarea>
                    </div>
                    
                    <hr>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label fw-bold">Shifts per Day *</label>
                                <input type="number" class="form-control" id="shiftsPerDay" min="1" max="4" value="2" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label fw-bold">Hours per Shift *</label>
                                <input type="number" class="form-control" id="hoursPerShift" min="1" max="12" step="0.5" value="8" required>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold">Days per Week *</label>
                        <input type="number" class="form-control" id="daysPerWeek" min="1" max="7" value="5" required>
                    </div>
                    
                    <hr>
                    
                    <h6 style="color: #ea6d09;"><i class="bi bi-calendar-week"></i> Weekend Work</h6>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="includeSaturday" onchange="toggleWeekendHours()">
                                <label class="form-check-label" for="includeSaturday">
                                    Include Saturday
                                </label>
                            </div>
                            <div id="saturdayHoursGroup" class="mb-3" style="display: none;">
                                <label class="form-label small">Saturday Hours</label>
                                <input type="number" class="form-control form-control-sm" id="saturdayHours" min="0" max="24" step="0.5" value="0">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="includeSunday" onchange="toggleWeekendHours()">
                                <label class="form-check-label" for="includeSunday">
                                    Include Sunday
                                </label>
                            </div>
                            <div id="sundayHoursGroup" class="mb-3" style="display: none;">
                                <label class="form-label small">Sunday Hours</label>
                                <input type="number" class="form-control form-control-sm" id="sundayHours" min="0" max="24" step="0.5" value="0">
                            </div>
                        </div>
                    </div>
                    
                    <hr>
                    
                    <h6 style="color: #ea6d09;"><i class="bi bi-clock"></i> Opening & Cleaning Time</h6>
                    
                    <div class="mb-3">
                        <label class="form-label">Hours to subtract from weekly total</label>
                        <input type="number" class="form-control" id="openingCleaningTime" min="0" max="50" step="0.5" value="0">
                        <small class="text-muted">This time will be deducted from the weekly hours calculation</small>
                    </div>
                    
                    <hr>
                    
                    <div class="alert alert-info mb-0">
                        <i class="bi bi-calculator"></i> <strong>Weekly Hours:</strong> 
                        <span id="calculatedWeeklyHours">80</span> hours
                        <small class="text-muted d-block" id="calculationBreakdown"></small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveShift()">
                    <i class="bi bi-check-lg"></i> Save Configuration
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title text-danger">
                    <i class="bi bi-exclamation-triangle"></i> Confirm Delete
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this shift configuration?</p>
                <p class="fw-bold" id="deleteItemName"></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" onclick="confirmDelete()">
                    <i class="bi bi-trash"></i> Delete
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // API_BASE is defined in base.html
    let deleteItemId = null;
    
    document.addEventListener('DOMContentLoaded', function() {
        loadSystemShifts();
        loadCustomShifts();
        
        // Setup live calculation of weekly hours
        ['shiftsPerDay', 'hoursPerShift', 'daysPerWeek', 'saturdayHours', 'sundayHours', 'openingCleaningTime'].forEach(id => {
            document.getElementById(id).addEventListener('input', calculateWeeklyHours);
        });
    });
    
    function toggleWeekendHours() {
        const satChecked = document.getElementById('includeSaturday').checked;
        const sunChecked = document.getElementById('includeSunday').checked;
        
        document.getElementById('saturdayHoursGroup').style.display = satChecked ? 'block' : 'none';
        document.getElementById('sundayHoursGroup').style.display = sunChecked ? 'block' : 'none';
        
        if (!satChecked) document.getElementById('saturdayHours').value = 0;
        if (!sunChecked) document.getElementById('sundayHours').value = 0;
        
        calculateWeeklyHours();
    }
    
    function calculateWeeklyHours() {
        const shiftsPerDay = parseFloat(document.getElementById('shiftsPerDay').value) || 0;
        const hoursPerShift = parseFloat(document.getElementById('hoursPerShift').value) || 0;
        const daysPerWeek = parseFloat(document.getElementById('daysPerWeek').value) || 0;
        const saturdayHours = parseFloat(document.getElementById('saturdayHours').value) || 0;
        const sundayHours = parseFloat(document.getElementById('sundayHours').value) || 0;
        const openingCleaningTime = parseFloat(document.getElementById('openingCleaningTime').value) || 0;
        
        const baseHours = shiftsPerDay * hoursPerShift * daysPerWeek;
        const weeklyHours = baseHours + saturdayHours + sundayHours - openingCleaningTime;
        
        document.getElementById('calculatedWeeklyHours').textContent = weeklyHours.toFixed(1);
        
        // Update breakdown
        let breakdown = `${shiftsPerDay}×${hoursPerShift}h×${daysPerWeek}d = ${baseHours}h`;
        if (saturdayHours > 0) breakdown += ` + ${saturdayHours}h (Sat)`;
        if (sundayHours > 0) breakdown += ` + ${sundayHours}h (Sun)`;
        if (openingCleaningTime > 0) breakdown += ` - ${openingCleaningTime}h (cleaning)`;
        document.getElementById('calculationBreakdown').textContent = breakdown;
    }
    
    async function loadSystemShifts() {
        try {
            const response = await fetch(API_BASE + 'shift-configs/');
            const data = await response.json();
            const shifts = data.results || data;
            
            const tbody = document.getElementById('systemShiftsBody');
            
            if (shifts.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">No system configurations</td></tr>';
                return;
            }
            
            tbody.innerHTML = shifts.map(shift => `
                <tr>
                    <td><strong>${shift.name}</strong></td>
                    <td>${shift.shifts_per_day}</td>
                    <td>${shift.hours_per_shift}</td>
                    <td>${shift.days_per_week}</td>
                    <td>${formatWeekend(shift.includes_saturday, shift.includes_sunday, shift.saturday_hours, shift.sunday_hours)}</td>
                    <td>${shift.opening_cleaning_time > 0 ? shift.opening_cleaning_time + 'h' : '-'}</td>
                    <td><span class="badge bg-primary">${shift.weekly_hours}h</span></td>
                </tr>
            `).join('');
        } catch (error) {
            console.error('Error loading system shifts:', error);
            document.getElementById('systemShiftsBody').innerHTML = 
                '<tr><td colspan="7" class="text-center text-danger">Error loading data</td></tr>';
        }
    }
    
    async function loadCustomShifts() {
        try {
            const response = await fetch(API_BASE + 'custom-shift-configs/');
            const data = await response.json();
            const shifts = data.results || data;
            
            const tbody = document.getElementById('customShiftsBody');
            
            if (shifts.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">No custom configurations yet. Click "New Shift Configuration" to create one.</td></tr>';
                return;
            }
            
            tbody.innerHTML = shifts.map(shift => `
                <tr>
                    <td><strong>${shift.name}</strong></td>
                    <td>${shift.shifts_per_day}</td>
                    <td>${shift.hours_per_shift}</td>
                    <td>${shift.days_per_week}</td>
                    <td>${formatWeekend(shift.includes_saturday, shift.includes_sunday, shift.saturday_hours, shift.sunday_hours)}</td>
                    <td>${shift.opening_cleaning_time > 0 ? shift.opening_cleaning_time + 'h' : '-'}</td>
                    <td><span class="badge bg-success">${shift.weekly_hours}h</span></td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary me-1" onclick="editShift(${shift.id})" title="Edit">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteShift(${shift.id}, '${shift.name}')" title="Delete">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        } catch (error) {
            console.error('Error loading custom shifts:', error);
            document.getElementById('customShiftsBody').innerHTML = 
                '<tr><td colspan="8" class="text-center text-danger">Error loading data</td></tr>';
        }
    }
    
    function formatWeekend(saturday, sunday, satHours = 0, sunHours = 0) {
        const parts = [];
        if (saturday) parts.push(`S${satHours > 0 ? '(' + satHours + 'h)' : ''}`);
        if (sunday) parts.push(`Su${sunHours > 0 ? '(' + sunHours + 'h)' : ''}`);
        
        if (parts.length === 2 && satHours === 0 && sunHours === 0) {
            return '<span class="badge bg-info">SS</span>';
        } else if (parts.length > 0) {
            return `<span class="badge bg-info">${parts.join(' ')}</span>`;
        }
        return '<span class="text-muted">-</span>';
    }
    
    function resetForm() {
        document.getElementById('shiftForm').reset();
        document.getElementById('shiftId').value = '';
        document.getElementById('shiftsPerDay').value = 2;
        document.getElementById('hoursPerShift').value = 8;
        document.getElementById('daysPerWeek').value = 5;
        document.getElementById('saturdayHours').value = 0;
        document.getElementById('sundayHours').value = 0;
        document.getElementById('openingCleaningTime').value = 0;
        document.getElementById('saturdayHoursGroup').style.display = 'none';
        document.getElementById('sundayHoursGroup').style.display = 'none';
        document.getElementById('modalTitle').innerHTML = '<i class="bi bi-clock-history"></i> New Shift Configuration';
        calculateWeeklyHours();
    }
    
    async function editShift(id) {
        try {
            const response = await fetch(API_BASE + `custom-shift-configs/${id}/`);
            const shift = await response.json();
            
            document.getElementById('shiftId').value = shift.id;
            document.getElementById('shiftName').value = shift.name;
            document.getElementById('shiftDescription').value = shift.description || '';
            document.getElementById('shiftsPerDay').value = shift.shifts_per_day;
            document.getElementById('hoursPerShift').value = shift.hours_per_shift;
            document.getElementById('daysPerWeek').value = shift.days_per_week;
            document.getElementById('includeSaturday').checked = shift.includes_saturday;
            document.getElementById('includeSunday').checked = shift.includes_sunday;
            document.getElementById('saturdayHours').value = shift.saturday_hours || 0;
            document.getElementById('sundayHours').value = shift.sunday_hours || 0;
            document.getElementById('openingCleaningTime').value = shift.opening_cleaning_time || 0;
            
            toggleWeekendHours();
            calculateWeeklyHours();
            
            document.getElementById('modalTitle').innerHTML = '<i class="bi bi-pencil"></i> Edit Shift Configuration';
            new bootstrap.Modal(document.getElementById('shiftModal')).show();
        } catch (error) {
            console.error('Error loading shift:', error);
            showToast('Error loading shift configuration', 'danger');
        }
    }
    
    async function saveShift() {
        const shiftsPerDay = parseInt(document.getElementById('shiftsPerDay').value);
        const hoursPerShift = parseFloat(document.getElementById('hoursPerShift').value);
        const daysPerWeek = parseInt(document.getElementById('daysPerWeek').value);
        
        if (!shiftsPerDay || !hoursPerShift || !daysPerWeek) {
            showToast('Please fill in all required fields', 'warning');
            return;
        }
        
        const id = document.getElementById('shiftId').value;
        
        const data = {
            name: document.getElementById('shiftName').value.trim() || '',
            description: document.getElementById('shiftDescription').value.trim(),
            shifts_per_day: shiftsPerDay,
            hours_per_shift: hoursPerShift,
            days_per_week: daysPerWeek,
            includes_saturday: document.getElementById('includeSaturday').checked,
            includes_sunday: document.getElementById('includeSunday').checked,
            saturday_hours: parseFloat(document.getElementById('saturdayHours').value) || 0,
            sunday_hours: parseFloat(document.getElementById('sundayHours').value) || 0,
            opening_cleaning_time: parseFloat(document.getElementById('openingCleaningTime').value) || 0
        };
        
        try {
            const url = id ? API_BASE + `custom-shift-configs/${id}/` : API_BASE + 'custom-shift-configs/';
            const method = id ? 'PUT' : 'POST';
            
            const response = await fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify(data)
            });
            
            if (response.ok) {
                bootstrap.Modal.getInstance(document.getElementById('shiftModal')).hide();
                showToast(id ? 'Configuration updated successfully' : 'Configuration created successfully', 'success');
                loadCustomShifts();
            } else {
                const error = await response.json();
                showToast('Error: ' + JSON.stringify(error), 'danger');
            }
        } catch (error) {
            console.error('Error saving shift:', error);
            showToast('Error saving configuration', 'danger');
        }
    }
    
    function deleteShift(id, name) {
        deleteItemId = id;
        document.getElementById('deleteItemName').textContent = name;
        new bootstrap.Modal(document.getElementById('deleteModal')).show();
    }
    
    async function confirmDelete() {
        if (!deleteItemId) return;
        
        try {
            const response = await fetch(API_BASE + `custom-shift-configs/${deleteItemId}/`, {
                method: 'DELETE',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                }
            });
            
            if (response.ok) {
                bootstrap.Modal.getInstance(document.getElementById('deleteModal')).hide();
                showToast('Configuration deleted successfully', 'success');
                loadCustomShifts();
            } else {
                showToast('Error deleting configuration', 'danger');
            }
        } catch (error) {
            console.error('Error deleting shift:', error);
            showToast('Error deleting configuration', 'danger');
        }
        
        deleteItemId = null;
    }
</script>
{% endblock %}
