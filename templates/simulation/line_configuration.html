{% extends 'base.html' %}

{% block title %}Line Configuration - Cerelia{% endblock %}

{% block extra_css %}
<style>
    .override-card {
        border-left: 4px solid #ea6d09;
        transition: transform 0.2s;
    }
    .override-card:hover {
        transform: translateX(5px);
    }
    .override-card.past {
        border-left-color: #adb5bd;
        opacity: 0.7;
    }
    .override-card.active {
        border-left-color: #28a745;
        background-color: #f0fff4;
    }
    .config-badge {
        font-size: 1.1rem;
        font-weight: bold;
        font-family: monospace;
    }
    .weekend-badge {
        font-size: 0.7rem;
        vertical-align: middle;
    }
    .line-card {
        transition: all 0.2s;
    }
    .line-card:hover {
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .line-card.has-overrides {
        border-left: 3px solid #ea6d09;
    }
    .timeline-dot {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        display: inline-block;
    }
    .timeline-dot.active { background-color: #28a745; }
    .timeline-dot.future { background-color: #007bff; }
    .timeline-dot.past { background-color: #adb5bd; }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="bi bi-wrench-adjustable"></i> Line Configuration</h2>
    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addOverrideModal">
        <i class="bi bi-plus-lg"></i> Add Configuration Override
    </button>
</div>

<!-- Filters -->
<div class="row mb-4">
    <div class="col-md-3">
        <label class="form-label">Filter by Site</label>
        <select class="form-select" id="siteFilter">
            <option value="">All Sites</option>
        </select>
    </div>
    <div class="col-md-3">
        <label class="form-label">Search Line</label>
        <input type="text" class="form-control" id="searchLine" placeholder="Search by name...">
    </div>
    <div class="col-md-3">
        <label class="form-label">Show</label>
        <select class="form-select" id="viewFilter">
            <option value="all">All Lines</option>
            <option value="with-overrides">Lines with Overrides</option>
            <option value="no-overrides">Lines without Overrides</option>
        </select>
    </div>
    <div class="col-md-3">
        <label class="form-label">&nbsp;</label>
        <div class="d-flex gap-2">
            <button class="btn btn-outline-secondary flex-grow-1" onclick="loadData()">
                <i class="bi bi-arrow-clockwise"></i> Refresh
            </button>
        </div>
    </div>
</div>

<!-- Summary Cards -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card stat-card">
            <div class="stat-value" id="totalLines">0</div>
            <div class="stat-label">Production Lines</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stat-card warning">
            <div class="stat-value" id="activeOverrides">0</div>
            <div class="stat-label">Active Overrides</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stat-card">
            <div class="stat-value" id="upcomingOverrides">0</div>
            <div class="stat-label">Upcoming Overrides</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stat-card success">
            <div class="stat-value" id="totalWeeklyHours">0</div>
            <div class="stat-label">Total Weekly Hours</div>
        </div>
    </div>
</div>

<!-- Lines with their overrides -->
<div id="linesContainer">
    <div class="text-center py-5 text-muted">
        <i class="bi bi-hourglass-split"></i> Loading lines...
    </div>
</div>

<!-- Add/Edit Override Modal -->
<div class="modal fade" id="addOverrideModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-calendar-plus"></i> <span id="modalTitle">Add Configuration Override</span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="overrideId">
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Production Line *</label>
                            <select class="form-select" id="overrideLine" required>
                                <option value="">Select a line...</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Reason</label>
                            <input type="text" class="form-control" id="overrideReason" 
                                   placeholder="e.g., Maintenance, Peak Season, Cleaning...">
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Start Date *</label>
                            <input type="date" class="form-control" id="overrideStartDate" required>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">End Date *</label>
                            <input type="date" class="form-control" id="overrideEndDate" required>
                        </div>
                    </div>
                </div>
                
                <hr>
                <h6 class="mb-3"><i class="bi bi-gear"></i> Shift Configuration</h6>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Number of Shifts per Day *</label>
                            <select class="form-select" id="overrideShifts" onchange="updatePreview()">
                                <option value="1">1 shift</option>
                                <option value="2">2 shifts</option>
                                <option value="3" selected>3 shifts</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Hours per Shift *</label>
                            <input type="number" class="form-control" id="overrideHours" 
                                   value="8" min="0.5" max="12" step="0.5" onchange="updatePreview()">
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Weekend Days</label>
                            <div class="d-flex gap-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="overrideSaturday" onchange="updatePreview()">
                                    <label class="form-check-label" for="overrideSaturday">
                                        <span class="badge bg-success">Saturday</span>
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="overrideSunday" onchange="updatePreview()">
                                    <label class="form-check-label" for="overrideSunday">
                                        <span class="badge bg-danger">Sunday</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Configuration Preview</label>
                            <div class="alert alert-info mb-0 py-2">
                                <span class="config-badge" id="configPreview">3x8</span>
                                <span class="ms-2 text-muted">= <span id="weeklyHoursPreview">120</span> hours/week</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Quick Presets -->
                <div class="mb-3">
                    <label class="form-label">Quick Presets</label>
                    <div class="d-flex flex-wrap gap-2">
                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="applyPreset(3, 8, false, false)">3×8</button>
                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="applyPreset(3, 8, true, false)">3×8 S</button>
                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="applyPreset(3, 8, true, true)">3×8 SS</button>
                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="applyPreset(2, 8, false, false)">2×8</button>
                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="applyPreset(2, 8, true, false)">2×8 S</button>
                        <button type="button" class="btn btn-sm btn-outline-warning" onclick="applyPreset(3, 4, false, false)">3×4</button>
                        <button type="button" class="btn btn-sm btn-outline-warning" onclick="applyPreset(2, 4, false, false)">2×4</button>
                        <button type="button" class="btn btn-sm btn-outline-warning" onclick="applyPreset(2, 4, true, false)">2×4 S</button>
                        <button type="button" class="btn btn-sm btn-outline-danger" onclick="applyPreset(1, 8, false, false)">1×8</button>
                        <button type="button" class="btn btn-sm btn-outline-danger" onclick="applyPreset(1, 4, false, false)">1×4</button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveOverride()">
                    <i class="bi bi-check"></i> Save Override
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let allLines = [];
    let allOverrides = [];
    let sites = [];
    let overrideModal = null;

    document.addEventListener('DOMContentLoaded', async function() {
        overrideModal = new bootstrap.Modal(document.getElementById('addOverrideModal'));
        
        await loadData();
        
        document.getElementById('searchLine').addEventListener('input', renderLines);
        document.getElementById('siteFilter').addEventListener('change', renderLines);
        document.getElementById('viewFilter').addEventListener('change', renderLines);
    });

    async function loadData() {
        await Promise.all([
            loadSites(),
            loadLines(),
            loadOverrides()
        ]);
        renderLines();
        updateStats();
    }

    async function loadSites() {
        const data = await fetchAPI('sites/');
        sites = data.results || data;
        
        const select = document.getElementById('siteFilter');
        select.innerHTML = '<option value="">All Sites</option>' + 
            sites.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
    }

    async function loadLines() {
        const data = await fetchAPI('lines/');
        allLines = data.results || data;
        
        // Populate modal line select
        const select = document.getElementById('overrideLine');
        select.innerHTML = '<option value="">Select a line...</option>' + 
            allLines.map(l => `<option value="${l.id}">${l.site_name} - ${l.name}</option>`).join('');
    }

    async function loadOverrides() {
        const data = await fetchAPI('line-overrides/upcoming/');
        allOverrides = data.results || data;
    }

    function getFilteredLines() {
        let filtered = [...allLines];
        
        const siteId = document.getElementById('siteFilter').value;
        const search = document.getElementById('searchLine').value.toLowerCase();
        const viewFilter = document.getElementById('viewFilter').value;
        
        if (siteId) {
            filtered = filtered.filter(l => l.site == siteId);
        }
        
        if (search) {
            filtered = filtered.filter(l => 
                l.name.toLowerCase().includes(search) || 
                l.code.toLowerCase().includes(search)
            );
        }
        
        if (viewFilter === 'with-overrides') {
            const lineIdsWithOverrides = new Set(allOverrides.map(o => o.line));
            filtered = filtered.filter(l => lineIdsWithOverrides.has(l.id));
        } else if (viewFilter === 'no-overrides') {
            const lineIdsWithOverrides = new Set(allOverrides.map(o => o.line));
            filtered = filtered.filter(l => !lineIdsWithOverrides.has(l.id));
        }
        
        return filtered;
    }

    function renderLines() {
        const container = document.getElementById('linesContainer');
        const filtered = getFilteredLines();
        
        if (filtered.length === 0) {
            container.innerHTML = '<div class="alert alert-info">No lines found matching your filters.</div>';
            return;
        }
        
        const today = new Date().toISOString().split('T')[0];
        
        container.innerHTML = filtered.map(line => {
            const lineOverrides = allOverrides.filter(o => o.line === line.id);
            const hasOverrides = lineOverrides.length > 0;
            const activeOverride = lineOverrides.find(o => o.start_date <= today && o.end_date >= today);
            
            // Format default config display
            const defaultConfig = line.default_shift_config_name || 'Not set';
            const defaultHours = line.default_weekly_hours || 0;
            
            return `
                <div class="card line-card mb-3 ${hasOverrides ? 'has-overrides' : ''}">
                    <div class="card-header d-flex justify-content-between align-items-center py-2">
                        <div>
                            <span class="badge bg-secondary me-2">${line.site_name}</span>
                            <strong>${line.name}</strong>
                            <small class="text-muted ms-2">(${line.code})</small>
                        </div>
                        <div>
                            <span class="me-3">
                                <i class="bi bi-speedometer2 text-muted"></i>
                                ${line.base_capacity_per_hour} units/h @ ${Math.round(line.efficiency_factor * 100)}%
                            </span>
                            <button class="btn btn-sm btn-outline-primary" onclick="openAddOverride(${line.id})">
                                <i class="bi bi-plus"></i> Add Override
                            </button>
                        </div>
                    </div>
                    <div class="card-body py-2">
                        <div class="row">
                            <div class="col-md-4">
                                <div class="d-flex align-items-center">
                                    <div class="me-3">
                                        <small class="text-muted d-block">Default Config</small>
                                        <span class="config-badge text-primary">${defaultConfig}</span>
                                    </div>
                                    <div>
                                        <small class="text-muted d-block">Weekly Hours</small>
                                        <strong>${defaultHours}h</strong>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-8">
                                ${hasOverrides ? renderOverridesList(lineOverrides, today) : '<div class="text-muted small py-2"><i class="bi bi-info-circle"></i> No configuration overrides scheduled</div>'}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }).join('');
    }

    function renderOverridesList(overrides, today) {
        return `
            <div class="d-flex flex-wrap gap-2">
                ${overrides.map(o => {
                    let statusClass = 'future';
                    let statusText = 'Upcoming';
                    if (o.start_date <= today && o.end_date >= today) {
                        statusClass = 'active';
                        statusText = 'Active';
                    } else if (o.end_date < today) {
                        statusClass = 'past';
                        statusText = 'Past';
                    }
                    
                    return `
                        <div class="override-card card ${statusClass}" style="min-width: 200px;">
                            <div class="card-body py-2 px-3">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <span class="config-badge">${o.config_display}</span>
                                        <span class="badge bg-${statusClass === 'active' ? 'success' : statusClass === 'future' ? 'primary' : 'secondary'} ms-1">${statusText}</span>
                                        ${o.reason ? `<br><small class="text-muted">${o.reason}</small>` : ''}
                                    </div>
                                    <div class="dropdown">
                                        <button class="btn btn-sm btn-link text-muted p-0" data-bs-toggle="dropdown">
                                            <i class="bi bi-three-dots-vertical"></i>
                                        </button>
                                        <ul class="dropdown-menu dropdown-menu-end">
                                            <li><a class="dropdown-item" href="#" onclick="editOverride(${o.id})"><i class="bi bi-pencil"></i> Edit</a></li>
                                            <li><a class="dropdown-item text-danger" href="#" onclick="deleteOverride(${o.id})"><i class="bi bi-trash"></i> Delete</a></li>
                                        </ul>
                                    </div>
                                </div>
                                <small class="text-muted d-block mt-1">
                                    <i class="bi bi-calendar3"></i> ${formatDate(o.start_date)} → ${formatDate(o.end_date)}
                                </small>
                                <small class="text-muted">${o.weekly_hours}h/week</small>
                            </div>
                        </div>
                    `;
                }).join('')}
            </div>
        `;
    }

    function formatDate(dateStr) {
        const date = new Date(dateStr);
        return date.toLocaleDateString('en-GB', { day: '2-digit', month: 'short' });
    }

    function updateStats() {
        const today = new Date().toISOString().split('T')[0];
        const activeCount = allOverrides.filter(o => o.start_date <= today && o.end_date >= today).length;
        const upcomingCount = allOverrides.filter(o => o.start_date > today).length;
        
        let totalHours = 0;
        allLines.forEach(l => {
            totalHours += l.default_weekly_hours || 0;
        });
        
        document.getElementById('totalLines').textContent = allLines.length;
        document.getElementById('activeOverrides').textContent = activeCount;
        document.getElementById('upcomingOverrides').textContent = upcomingCount;
        document.getElementById('totalWeeklyHours').textContent = Math.round(totalHours);
    }

    function updatePreview() {
        const shifts = parseInt(document.getElementById('overrideShifts').value);
        const hours = parseFloat(document.getElementById('overrideHours').value) || 0;
        const saturday = document.getElementById('overrideSaturday').checked;
        const sunday = document.getElementById('overrideSunday').checked;
        
        let configStr = `${shifts}×${hours}`;
        if (saturday && sunday) configStr += ' SS';
        else if (saturday) configStr += ' S';
        
        const daysPerWeek = 5 + (saturday ? 1 : 0) + (sunday ? 1 : 0);
        const weeklyHours = shifts * hours * daysPerWeek;
        
        document.getElementById('configPreview').textContent = configStr;
        document.getElementById('weeklyHoursPreview').textContent = weeklyHours;
    }

    function applyPreset(shifts, hours, saturday, sunday) {
        document.getElementById('overrideShifts').value = shifts;
        document.getElementById('overrideHours').value = hours;
        document.getElementById('overrideSaturday').checked = saturday;
        document.getElementById('overrideSunday').checked = sunday;
        updatePreview();
    }

    function openAddOverride(lineId = null) {
        document.getElementById('overrideId').value = '';
        document.getElementById('modalTitle').textContent = 'Add Configuration Override';
        
        // Reset form
        if (lineId) {
            document.getElementById('overrideLine').value = lineId;
        } else {
            document.getElementById('overrideLine').value = '';
        }
        document.getElementById('overrideReason').value = '';
        document.getElementById('overrideStartDate').value = '';
        document.getElementById('overrideEndDate').value = '';
        applyPreset(3, 8, false, false);
        
        overrideModal.show();
    }

    async function editOverride(overrideId) {
        const override = allOverrides.find(o => o.id === overrideId);
        if (!override) return;
        
        document.getElementById('overrideId').value = override.id;
        document.getElementById('modalTitle').textContent = 'Edit Configuration Override';
        document.getElementById('overrideLine').value = override.line;
        document.getElementById('overrideReason').value = override.reason || '';
        document.getElementById('overrideStartDate').value = override.start_date;
        document.getElementById('overrideEndDate').value = override.end_date;
        document.getElementById('overrideShifts').value = override.shifts_per_day;
        document.getElementById('overrideHours').value = override.hours_per_shift;
        document.getElementById('overrideSaturday').checked = override.include_saturday;
        document.getElementById('overrideSunday').checked = override.include_sunday;
        updatePreview();
        
        overrideModal.show();
    }

    async function saveOverride() {
        const overrideId = document.getElementById('overrideId').value;
        const data = {
            line: parseInt(document.getElementById('overrideLine').value),
            start_date: document.getElementById('overrideStartDate').value,
            end_date: document.getElementById('overrideEndDate').value,
            shifts_per_day: parseInt(document.getElementById('overrideShifts').value),
            hours_per_shift: parseFloat(document.getElementById('overrideHours').value),
            include_saturday: document.getElementById('overrideSaturday').checked,
            include_sunday: document.getElementById('overrideSunday').checked,
            reason: document.getElementById('overrideReason').value,
            is_active: true
        };
        
        if (!data.line || !data.start_date || !data.end_date) {
            alert('Please fill in all required fields');
            return;
        }
        
        if (data.end_date < data.start_date) {
            alert('End date must be after start date');
            return;
        }
        
        try {
            if (overrideId) {
                // Update existing
                await fetch(`/api/line-overrides/${overrideId}/`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify(data)
                });
            } else {
                // Create new
                await postAPI('/api/line-overrides/', data);
            }
            
            overrideModal.hide();
            await loadData();
            alert('Override saved successfully');
        } catch (error) {
            console.error('Error saving override:', error);
            alert('Error saving override');
        }
    }

    async function deleteOverride(overrideId) {
        if (!confirm('Are you sure you want to delete this override?')) return;
        
        try {
            await fetch(`/api/line-overrides/${overrideId}/`, {
                method: 'DELETE',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                }
            });
            
            await loadData();
        } catch (error) {
            console.error('Error deleting override:', error);
            alert('Error deleting override');
        }
    }

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
</script>
{% endblock %}
